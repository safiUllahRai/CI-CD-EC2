import { NgIf } from '@angular/common';
import { ChangeDetectionStrategy, Component, ContentChild, ElementRef, inject, Input, Output, ViewChild, ViewEncapsulation, } from '@angular/core';
import { defer, ReplaySubject, Subject } from 'rxjs';
import { distinctUntilChanged, filter, take, takeUntil } from 'rxjs/operators';
import { RxVirtualScrollElement, RxVirtualScrollStrategy, RxVirtualScrollViewport, RxVirtualViewRepeater, } from './model';
import { observeElementSize } from './observe-element-size';
import { unpatchedScroll } from './util';
import * as i0 from "@angular/core";
const NG_DEV_MODE = typeof ngDevMode === 'undefined' || !!ngDevMode;
/**
 * @Component RxVirtualScrollViewport
 *
 * @description
 * Container component comparable to CdkVirtualScrollViewport acting as viewport
 * for `*rxVirtualFor` to operate on.
 *
 * Its main purpose is to implement the `RxVirtualScrollViewport` interface
 * as well as maintaining the scroll runways' height in order to give
 * the provided `RxVirtualScrollStrategy` room to position items.
 *
 * Furthermore, it will gather and forward all events to the consumer of `rxVirtualFor`.
 *
 * @docsCategory RxVirtualFor
 * @docsPage RxVirtualFor
 * @publicApi
 */
export class RxVirtualScrollViewportComponent {
    elementRef = inject((ElementRef));
    scrollStrategy = inject((RxVirtualScrollStrategy), {
        optional: true,
    });
    scrollElement = inject(RxVirtualScrollElement, { optional: true });
    /**
     * @description
     *
     * Sets the first view to be visible to the user.
     * The viewport waits for the data to arrive and scrolls to the given index immediately.
     *
     * */
    initialScrollIndex = 0;
    /** @internal */
    scrollSentinel;
    /** @internal */
    runway;
    /** @internal */
    viewRepeater;
    elementScrolled$ = this.scrollElement?.elementScrolled$ ??
        defer(() => unpatchedScroll(this.runway.nativeElement));
    /** @internal */
    _containerRect$ = new ReplaySubject(1);
    containerRect$ = this._containerRect$.asObservable();
    /**
     * @description
     *
     * The range to be rendered by `*rxVirtualFor`. This value is determined by the
     * provided `RxVirtualScrollStrategy`. It gives the user information about the
     * range of items being actually rendered to the DOM.
     * Note this value updates before the `renderCallback` kicks in, thus it is only
     * in sync with the DOM when the next `renderCallback` emitted an event.
     */
    viewRange = this.scrollStrategy.renderedRange$;
    /**
     * @description
     *
     * The index of the currently scrolled item. The scrolled item is the topmost
     * item actually being visible to the user.
     */
    scrolledIndexChange = this.scrollStrategy.scrolledIndex$;
    /** @internal */
    destroy$ = new Subject();
    /** @internal */
    constructor() {
        if (NG_DEV_MODE && !this.scrollStrategy) {
            throw Error('Error: rx-virtual-scroll-viewport requires an `RxVirtualScrollStrategy` to be set.');
        }
        observeElementSize(this.scrollElement?.getElementRef()?.nativeElement ??
            this.elementRef.nativeElement, {
            extract: (entries) => ({
                height: Math.round(entries[0].contentRect.height),
                width: Math.round(entries[0].contentRect.width),
            }),
        })
            .pipe(distinctUntilChanged(({ height: prevHeight, width: prevWidth }, { height, width }) => prevHeight === height && prevWidth === width), takeUntil(this.destroy$))
            .subscribe(this._containerRect$);
    }
    ngAfterViewInit() {
        this.scrollStrategy.contentSize$
            .pipe(distinctUntilChanged(), takeUntil(this.destroy$))
            .subscribe((size) => {
            this.updateContentSize(size);
        });
        if (this.initialScrollIndex != null && this.initialScrollIndex > 0) {
            this.scrollStrategy.contentSize$
                .pipe(filter((size) => size > 0), take(1), takeUntil(this.destroy$))
                .subscribe(() => {
                this.scrollToIndex(this.initialScrollIndex);
            });
        }
    }
    /** @internal */
    ngAfterContentInit() {
        if (ngDevMode && !this.viewRepeater) {
            throw Error('Error: rx-virtual-scroll-viewport requires a `RxVirtualViewRepeater` to be provided.');
        }
        this.scrollStrategy.attach(this, this.viewRepeater);
    }
    /** @internal */
    ngOnDestroy() {
        this.destroy$.next();
        this.scrollStrategy.detach();
    }
    getScrollElement() {
        return (this.scrollElement?.getElementRef()?.nativeElement ??
            this.runway.nativeElement);
    }
    getScrollTop() {
        return this.getScrollElement().scrollTop;
    }
    scrollTo(position, behavior) {
        // TODO: implement more complex scroll scenarios
        this.getScrollElement().scrollTo({ top: position, behavior: behavior });
    }
    scrollToIndex(index, behavior) {
        this.scrollStrategy.scrollToIndex(index, behavior);
    }
    measureOffset() {
        if (this.scrollElement) {
            const scrollableOffset = this.scrollElement.measureOffset();
            const rect = this.elementRef.nativeElement.getBoundingClientRect();
            return this.getScrollTop() + (rect.top - scrollableOffset);
        }
        else {
            return 0;
        }
    }
    updateContentSize(size) {
        if (this.scrollElement) {
            this.elementRef.nativeElement.style.height = `${size}px`;
        }
        else {
            this.scrollSentinel.nativeElement.style.transform = `translate(0, ${size - 1}px)`;
        }
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: RxVirtualScrollViewportComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
    /** @nocollapse */ static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.0.1", type: RxVirtualScrollViewportComponent, isStandalone: true, selector: "rx-virtual-scroll-viewport", inputs: { initialScrollIndex: "initialScrollIndex" }, outputs: { viewRange: "viewRange", scrolledIndexChange: "scrolledIndexChange" }, host: { classAttribute: "rx-virtual-scroll-viewport" }, providers: [
            {
                provide: RxVirtualScrollViewport,
                useExisting: RxVirtualScrollViewportComponent,
            },
        ], queries: [{ propertyName: "viewRepeater", first: true, predicate: RxVirtualViewRepeater, descendants: true }], viewQueries: [{ propertyName: "scrollSentinel", first: true, predicate: ["sentinel"], descendants: true }, { propertyName: "runway", first: true, predicate: ["runway"], descendants: true, static: true }], ngImport: i0, template: `
    <div
      #runway
      class="rx-virtual-scroll__runway"
      [class.rx-virtual-scroll-element]="!scrollElement"
    >
      <div
        #sentinel
        class="rx-virtual-scroll__sentinel"
        *ngIf="!this.scrollElement"
      ></div>
      <ng-content></ng-content>
    </div>
  `, isInline: true, styles: [".rx-virtual-scroll-viewport{display:block;width:100%;height:100%;box-sizing:border-box;contain:strict}.rx-virtual-scroll-viewport .rx-virtual-scroll__runway{contain:strict;width:100%;position:absolute;top:0;bottom:0}.rx-virtual-scroll-viewport .rx-virtual-scroll__sentinel{width:1px;height:1px;contain:strict;position:absolute;will-change:transform}.rx-virtual-scroll-element{contain:strict;overflow:auto;-webkit-overflow-scrolling:touch}.rx-virtual-scroll-element:not(.rx-virtual-scroll-element:is(.rx-virtual-scroll-element--withSyncScrollbar)){transform:translateZ(0);will-change:scroll-position}\n"], dependencies: [{ kind: "directive", type: NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: RxVirtualScrollViewportComponent, decorators: [{
            type: Component,
            args: [{ selector: 'rx-virtual-scroll-viewport', template: `
    <div
      #runway
      class="rx-virtual-scroll__runway"
      [class.rx-virtual-scroll-element]="!scrollElement"
    >
      <div
        #sentinel
        class="rx-virtual-scroll__sentinel"
        *ngIf="!this.scrollElement"
      ></div>
      <ng-content></ng-content>
    </div>
  `, providers: [
                        {
                            provide: RxVirtualScrollViewport,
                            useExisting: RxVirtualScrollViewportComponent,
                        },
                    ], encapsulation: ViewEncapsulation.None, host: {
                        class: 'rx-virtual-scroll-viewport',
                    }, standalone: true, changeDetection: ChangeDetectionStrategy.OnPush, imports: [NgIf], styles: [".rx-virtual-scroll-viewport{display:block;width:100%;height:100%;box-sizing:border-box;contain:strict}.rx-virtual-scroll-viewport .rx-virtual-scroll__runway{contain:strict;width:100%;position:absolute;top:0;bottom:0}.rx-virtual-scroll-viewport .rx-virtual-scroll__sentinel{width:1px;height:1px;contain:strict;position:absolute;will-change:transform}.rx-virtual-scroll-element{contain:strict;overflow:auto;-webkit-overflow-scrolling:touch}.rx-virtual-scroll-element:not(.rx-virtual-scroll-element:is(.rx-virtual-scroll-element--withSyncScrollbar)){transform:translateZ(0);will-change:scroll-position}\n"] }]
        }], ctorParameters: () => [], propDecorators: { initialScrollIndex: [{
                type: Input
            }], scrollSentinel: [{
                type: ViewChild,
                args: ['sentinel']
            }], runway: [{
                type: ViewChild,
                args: ['runway', { static: true }]
            }], viewRepeater: [{
                type: ContentChild,
                args: [RxVirtualViewRepeater]
            }], viewRange: [{
                type: Output
            }], scrolledIndexChange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zY3JvbGwtdmlld3BvcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy90ZW1wbGF0ZS9leHBlcmltZW50YWwvdmlydHVhbC1zY3JvbGxpbmcvc3JjL2xpYi92aXJ0dWFsLXNjcm9sbC12aWV3cG9ydC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZDLE9BQU8sRUFHTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUNOLEtBQUssRUFFTCxNQUFNLEVBQ04sU0FBUyxFQUNULGlCQUFpQixHQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0UsT0FBTyxFQUNMLHNCQUFzQixFQUN0Qix1QkFBdUIsRUFDdkIsdUJBQXVCLEVBQ3ZCLHFCQUFxQixHQUN0QixNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sUUFBUSxDQUFDOztBQVF6QyxNQUFNLFdBQVcsR0FBRyxPQUFPLFNBQVMsS0FBSyxXQUFXLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUVwRTs7Ozs7Ozs7Ozs7Ozs7OztHQWdCRztBQWlDSCxNQUFNLE9BQU8sZ0NBQWdDO0lBT25DLFVBQVUsR0FBRyxNQUFNLENBQUMsQ0FBQSxVQUF1QixDQUFBLENBQUMsQ0FBQztJQUM3QyxjQUFjLEdBQUcsTUFBTSxDQUFDLENBQUEsdUJB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NEJBQTRCO3FCQUNwQyxjQUNXLElBQUksbUJBQ0MsdUJBQXVCLENBQUMsTUFBTSxXQUN0QyxDQUFDLElBQUksQ0FBQzt3REFzQk4sa0JBQWtCO3NCQUExQixLQUFLO2dCQUlFLGNBQWM7c0JBRHJCLFNBQVM7dUJBQUMsVUFBVTtnQkFLYixNQUFNO3NCQURiLFNBQVM7dUJBQUMsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtnQkFLckMsWUFBWTtzQkFEWCxZQUFZO3VCQUFDLHFCQUFxQjtnQkF3QjFCLFNBQVM7c0JBRGpCLE1BQU07Z0JBVUUsbUJBQW1CO3NCQUQzQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmdJZiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGQsXG4gIEVsZW1lbnRSZWYsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGRlZmVyLCBSZXBsYXlTdWJqZWN0LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCB0YWtlLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBSeFZpcnR1YWxTY3JvbGxFbGVtZW50LFxuICBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnQsXG4gIFJ4VmlydHVhbFZpZXdSZXBlYXRlcixcbn0gZnJvbSAnLi9tb2RlbCc7XG5pbXBvcnQgeyBvYnNlcnZlRWxlbWVudFNpemUgfSBmcm9tICcuL29ic2VydmUtZWxlbWVudC1zaXplJztcbmltcG9ydCB7IHVucGF0Y2hlZFNjcm9sbCB9IGZyb20gJy4vdXRpbCc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uIFdpbGwgYmUgcHJvdmlkZWQgdGhyb3VnaCBUZXJzZXIgZ2xvYmFsIGRlZmluaXRpb25zIGJ5IEFuZ3VsYXIgQ0xJXG4gKiBkdXJpbmcgdGhlIHByb2R1Y3Rpb24gYnVpbGQuXG4gKi9cbmRlY2xhcmUgY29uc3QgbmdEZXZNb2RlOiBib29sZWFuO1xuXG5jb25zdCBOR19ERVZfTU9ERSA9IHR5cGVvZiBuZ0Rldk1vZGUgPT09ICd1bmRlZmluZWQnIHx8ICEhbmdEZXZNb2RlO1xuXG4vKipcbiAqIEBDb21wb25lbnQgUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnRcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIENvbnRhaW5lciBjb21wb25lbnQgY29tcGFyYWJsZSB0byBDZGtWaXJ0dWFsU2Nyb2xsVmlld3BvcnQgYWN0aW5nIGFzIHZpZXdwb3J0XG4gKiBmb3IgYCpyeFZpcnR1YWxGb3JgIHRvIG9wZXJhdGUgb24uXG4gKlxuICogSXRzIG1haW4gcHVycG9zZSBpcyB0byBpbXBsZW1lbnQgdGhlIGBSeFZpcnR1YWxTY3JvbGxWaWV3cG9ydGAgaW50ZXJmYWNlXG4gKiBhcyB3ZWxsIGFzIG1haW50YWluaW5nIHRoZSBzY3JvbGwgcnVud2F5cycgaGVpZ2h0IGluIG9yZGVyIHRvIGdpdmVcbiAqIHRoZSBwcm92aWRlZCBgUnhWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3lgIHJvb20gdG8gcG9zaXRpb24gaXRlbXMuXG4gKlxuICogRnVydGhlcm1vcmUsIGl0IHdpbGwgZ2F0aGVyIGFuZCBmb3J3YXJkIGFsbCBldmVudHMgdG8gdGhlIGNvbnN1bWVyIG9mIGByeFZpcnR1YWxGb3JgLlxuICpcbiAqIEBkb2NzQ2F0ZWdvcnkgUnhWaXJ0dWFsRm9yXG4gKiBAZG9jc1BhZ2UgUnhWaXJ0dWFsRm9yXG4gKiBAcHVibGljQXBpXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3J4LXZpcnR1YWwtc2Nyb2xsLXZpZXdwb3J0JyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZGl2XG4gICAgICAjcnVud2F5XG4gICAgICBjbGFzcz1cInJ4LXZpcnR1YWwtc2Nyb2xsX19ydW53YXlcIlxuICAgICAgW2NsYXNzLnJ4LXZpcnR1YWwtc2Nyb2xsLWVsZW1lbnRdPVwiIXNjcm9sbEVsZW1lbnRcIlxuICAgID5cbiAgICAgIDxkaXZcbiAgICAgICAgI3NlbnRpbmVsXG4gICAgICAgIGNsYXNzPVwicngtdmlydHVhbC1zY3JvbGxfX3NlbnRpbmVsXCJcbiAgICAgICAgKm5nSWY9XCIhdGhpcy5zY3JvbGxFbGVtZW50XCJcbiAgICAgID48L2Rpdj5cbiAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICA8L2Rpdj5cbiAgYCxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnQsXG4gICAgICB1c2VFeGlzdGluZzogUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnRDb21wb25lbnQsXG4gICAgfSxcbiAgXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgc3R5bGVVcmxzOiBbJy4vdmlydHVhbC1zY3JvbGwtdmlld3BvcnQuY29tcG9uZW50LnNjc3MnXSxcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1ob3N0LW1ldGFkYXRhLXByb3BlcnR5XG4gIGhvc3Q6IHtcbiAgICBjbGFzczogJ3J4LXZpcnR1YWwtc2Nyb2xsLXZpZXdwb3J0JyxcbiAgfSxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGltcG9ydHM6IFtOZ0lmXSxcbn0pXG5leHBvcnQgY2xhc3MgUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnRDb21wb25lbnRcbiAgaW1wbGVtZW50c1xuICAgIFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0LFxuICAgIEFmdGVyVmlld0luaXQsXG4gICAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgICBPbkRlc3Ryb3lcbntcbiAgcHJpdmF0ZSBlbGVtZW50UmVmID0gaW5qZWN0KEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+KTtcbiAgcHJpdmF0ZSBzY3JvbGxTdHJhdGVneSA9IGluamVjdChSeFZpcnR1YWxTY3JvbGxTdHJhdGVneTx1bmtub3duPiwge1xuICAgIG9wdGlvbmFsOiB0cnVlLFxuICB9KTtcbiAgcHJvdGVjdGVkIHNjcm9sbEVsZW1lbnQgPSBpbmplY3QoUnhWaXJ0dWFsU2Nyb2xsRWxlbWVudCwgeyBvcHRpb25hbDogdHJ1ZSB9KTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIFNldHMgdGhlIGZpcnN0IHZpZXcgdG8gYmUgdmlzaWJsZSB0byB0aGUgdXNlci5cbiAgICogVGhlIHZpZXdwb3J0IHdhaXRzIGZvciB0aGUgZGF0YSB0byBhcnJpdmUgYW5kIHNjcm9sbHMgdG8gdGhlIGdpdmVuIGluZGV4IGltbWVkaWF0ZWx5LlxuICAgKlxuICAgKiAqL1xuICBASW5wdXQoKSBpbml0aWFsU2Nyb2xsSW5kZXggPSAwO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgQFZpZXdDaGlsZCgnc2VudGluZWwnKVxuICBwcml2YXRlIHNjcm9sbFNlbnRpbmVsITogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBAVmlld0NoaWxkKCdydW53YXknLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBwcml2YXRlIHJ1bndheSE6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+O1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgQENvbnRlbnRDaGlsZChSeFZpcnR1YWxWaWV3UmVwZWF0ZXIpXG4gIHZpZXdSZXBlYXRlciE6IFJ4VmlydHVhbFZpZXdSZXBlYXRlcjx1bmtub3duPjtcblxuICByZWFkb25seSBlbGVtZW50U2Nyb2xsZWQkID1cbiAgICB0aGlzLnNjcm9sbEVsZW1lbnQ/LmVsZW1lbnRTY3JvbGxlZCQgPz9cbiAgICBkZWZlcigoKSA9PiB1bnBhdGNoZWRTY3JvbGwodGhpcy5ydW53YXkubmF0aXZlRWxlbWVudCkpO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBfY29udGFpbmVyUmVjdCQgPSBuZXcgUmVwbGF5U3ViamVjdDx7XG4gICAgd2lkdGg6IG51bWJlcjtcbiAgICBoZWlnaHQ6IG51bWJlcjtcbiAgfT4oMSk7XG4gIHJlYWRvbmx5IGNvbnRhaW5lclJlY3QkID0gdGhpcy5fY29udGFpbmVyUmVjdCQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBUaGUgcmFuZ2UgdG8gYmUgcmVuZGVyZWQgYnkgYCpyeFZpcnR1YWxGb3JgLiBUaGlzIHZhbHVlIGlzIGRldGVybWluZWQgYnkgdGhlXG4gICAqIHByb3ZpZGVkIGBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneWAuIEl0IGdpdmVzIHRoZSB1c2VyIGluZm9ybWF0aW9uIGFib3V0IHRoZVxuICAgKiByYW5nZSBvZiBpdGVtcyBiZWluZyBhY3R1YWxseSByZW5kZXJlZCB0byB0aGUgRE9NLlxuICAgKiBOb3RlIHRoaXMgdmFsdWUgdXBkYXRlcyBiZWZvcmUgdGhlIGByZW5kZXJDYWxsYmFja2Aga2lja3MgaW4sIHRodXMgaXQgaXMgb25seVxuICAgKiBpbiBzeW5jIHdpdGggdGhlIERPTSB3aGVuIHRoZSBuZXh0IGByZW5kZXJDYWxsYmFja2AgZW1pdHRlZCBhbiBldmVudC5cbiAgICovXG4gIEBPdXRwdXQoKVxuICByZWFkb25seSB2aWV3UmFuZ2UgPSB0aGlzLnNjcm9sbFN0cmF0ZWd5LnJlbmRlcmVkUmFuZ2UkO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50bHkgc2Nyb2xsZWQgaXRlbS4gVGhlIHNjcm9sbGVkIGl0ZW0gaXMgdGhlIHRvcG1vc3RcbiAgICogaXRlbSBhY3R1YWxseSBiZWluZyB2aXNpYmxlIHRvIHRoZSB1c2VyLlxuICAgKi9cbiAgQE91dHB1dCgpXG4gIHJlYWRvbmx5IHNjcm9sbGVkSW5kZXhDaGFuZ2UgPSB0aGlzLnNjcm9sbFN0cmF0ZWd5LnNjcm9sbGVkSW5kZXgkO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBpZiAoTkdfREVWX01PREUgJiYgIXRoaXMuc2Nyb2xsU3RyYXRlZ3kpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAnRXJyb3I6IHJ4LXZpcnR1YWwtc2Nyb2xsLXZpZXdwb3J0IHJlcXVpcmVzIGFuIGBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneWAgdG8gYmUgc2V0LidcbiAgICAgICk7XG4gICAgfVxuICAgIG9ic2VydmVFbGVtZW50U2l6ZShcbiAgICAgIHRoaXMuc2Nyb2xsRWxlbWVudD8uZ2V0RWxlbWVudFJlZigpPy5uYXRpdmVFbGVtZW50ID8/XG4gICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAge1xuICAgICAgICBleHRyYWN0OiAoZW50cmllcykgPT4gKHtcbiAgICAgICAgICBoZWlnaHQ6IE1hdGgucm91bmQoZW50cmllc1swXS5jb250ZW50UmVjdC5oZWlnaHQpLFxuICAgICAgICAgIHdpZHRoOiBNYXRoLnJvdW5kKGVudHJpZXNbMF0uY29udGVudFJlY3Qud2lkdGgpLFxuICAgICAgICB9KSxcbiAgICAgIH1cbiAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoXG4gICAgICAgICAgKHsgaGVpZ2h0OiBwcmV2SGVpZ2h0LCB3aWR0aDogcHJldldpZHRoIH0sIHsgaGVpZ2h0LCB3aWR0aCB9KSA9PlxuICAgICAgICAgICAgcHJldkhlaWdodCA9PT0gaGVpZ2h0ICYmIHByZXZXaWR0aCA9PT0gd2lkdGhcbiAgICAgICAgKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHRoaXMuX2NvbnRhaW5lclJlY3QkKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5LmNvbnRlbnRTaXplJFxuICAgICAgLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSwgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoc2l6ZSkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZUNvbnRlbnRTaXplKHNpemUpO1xuICAgICAgfSk7XG4gICAgaWYgKHRoaXMuaW5pdGlhbFNjcm9sbEluZGV4ICE9IG51bGwgJiYgdGhpcy5pbml0aWFsU2Nyb2xsSW5kZXggPiAwKSB7XG4gICAgICB0aGlzLnNjcm9sbFN0cmF0ZWd5LmNvbnRlbnRTaXplJFxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKHNpemUpID0+IHNpemUgPiAwKSxcbiAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLmluaXRpYWxTY3JvbGxJbmRleCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGlmIChuZ0Rldk1vZGUgJiYgIXRoaXMudmlld1JlcGVhdGVyKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ0Vycm9yOiByeC12aXJ0dWFsLXNjcm9sbC12aWV3cG9ydCByZXF1aXJlcyBhIGBSeFZpcnR1YWxWaWV3UmVwZWF0ZXJgIHRvIGJlIHByb3ZpZGVkLidcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuc2Nyb2xsU3RyYXRlZ3kuYXR0YWNoKHRoaXMsIHRoaXMudmlld1JlcGVhdGVyKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneS5kZXRhY2goKTtcbiAgfVxuXG4gIGdldFNjcm9sbEVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnNjcm9sbEVsZW1lbnQ/LmdldEVsZW1lbnRSZWYoKT8ubmF0aXZlRWxlbWVudCA/P1xuICAgICAgdGhpcy5ydW53YXkubmF0aXZlRWxlbWVudFxuICAgICk7XG4gIH1cblxuICBnZXRTY3JvbGxUb3AoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxFbGVtZW50KCkuc2Nyb2xsVG9wO1xuICB9XG5cbiAgc2Nyb2xsVG8ocG9zaXRpb246IG51bWJlciwgYmVoYXZpb3I/OiBTY3JvbGxCZWhhdmlvcik6IHZvaWQge1xuICAgIC8vIFRPRE86IGltcGxlbWVudCBtb3JlIGNvbXBsZXggc2Nyb2xsIHNjZW5hcmlvc1xuICAgIHRoaXMuZ2V0U2Nyb2xsRWxlbWVudCgpLnNjcm9sbFRvKHsgdG9wOiBwb3NpdGlvbiwgYmVoYXZpb3I6IGJlaGF2aW9yIH0pO1xuICB9XG5cbiAgc2Nyb2xsVG9JbmRleChpbmRleDogbnVtYmVyLCBiZWhhdmlvcj86IFNjcm9sbEJlaGF2aW9yKTogdm9pZCB7XG4gICAgdGhpcy5zY3JvbGxTdHJhdGVneS5zY3JvbGxUb0luZGV4KGluZGV4LCBiZWhhdmlvcik7XG4gIH1cblxuICBtZWFzdXJlT2Zmc2V0KCk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMuc2Nyb2xsRWxlbWVudCkge1xuICAgICAgY29uc3Qgc2Nyb2xsYWJsZU9mZnNldCA9IHRoaXMuc2Nyb2xsRWxlbWVudC5tZWFzdXJlT2Zmc2V0KCk7XG4gICAgICBjb25zdCByZWN0ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxUb3AoKSArIChyZWN0LnRvcCAtIHNjcm9sbGFibGVPZmZzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlQ29udGVudFNpemUoc2l6ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc2Nyb2xsRWxlbWVudCkge1xuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gYCR7c2l6ZX1weGA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2Nyb2xsU2VudGluZWwubmF0aXZlRWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKDAsICR7XG4gICAgICAgIHNpemUgLSAxXG4gICAgICB9cHgpYDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==