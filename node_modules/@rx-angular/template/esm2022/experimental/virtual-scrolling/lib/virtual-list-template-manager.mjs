/**
 * @internal
 *
 * Factory that returns a `ListTemplateManager` for the passed params.
 *
 * @param templateSettings
 */
export function createVirtualListTemplateManager({ viewContainerRef, templateRef, createViewContext, updateViewContext, templateCacheSize, }) {
    let _viewCache = [];
    let itemCount = 0;
    return {
        getListChanges,
        setItemCount: (count) => (itemCount = count),
        detach: () => {
            for (let i = 0; i < _viewCache.length; i++) {
                _viewCache[i].destroy();
            }
            _viewCache = [];
        },
    };
    function _updateView(item, index, count, contextIndex) {
        const view = viewContainerRef.get(index);
        updateViewContext(item, view, {
            count,
            index: contextIndex,
        });
        view.detectChanges();
        return view;
    }
    /**
     * Inserts a view for a new item, either from the cache or by creating a new
     * one.
     */
    function _insertView(value, count, adjustIndexWith, currentIndex) {
        currentIndex = currentIndex ?? viewContainerRef.length;
        const contextIndex = currentIndex + adjustIndexWith;
        const cachedView = _insertViewFromCache(currentIndex);
        if (cachedView) {
            updateViewContext(value, cachedView, {
                count,
                index: contextIndex,
            });
            cachedView.detectChanges();
            return [currentIndex, cachedView];
        }
        const context = createViewContext(value, {
            count,
            index: contextIndex,
        });
        const view = viewContainerRef.createEmbeddedView(templateRef, context, currentIndex);
        view.detectChanges();
        return [currentIndex, view];
    }
    /** Detaches the view at the given index and inserts into the view cache. */
    function _detachAndCacheView(index) {
        const detachedView = viewContainerRef.detach(index);
        _maybeCacheView(detachedView);
        detachedView.detectChanges();
    }
    /** Moves view at the previous index to the current index. */
    function _moveView(value, adjustedPreviousIndex, currentIndex, count, contextIndex) {
        const oldView = viewContainerRef.get(adjustedPreviousIndex);
        const view = (viewContainerRef.move(oldView, currentIndex));
        updateViewContext(value, view, {
            count,
            index: contextIndex,
        });
        view.detectChanges();
        return view;
    }
    /**
     * Cache the given detached view. If the cache is full, the view will be
     * destroyed.
     */
    function _maybeCacheView(view) {
        if (_viewCache.length < templateCacheSize) {
            _viewCache.push(view);
            return true;
        }
        else {
            const index = viewContainerRef.indexOf(view);
            // The host component could remove views from the container outside of
            // the view repeater. It's unlikely this will occur, but just in case,
            // destroy the view on its own, otherwise destroy it through the
            // container to ensure that all the references are removed.
            if (index === -1) {
                view.destroy();
            }
            else {
                viewContainerRef.remove(index);
            }
            return false;
        }
    }
    /** Inserts a recycled view from the cache at the given index. */
    function _insertViewFromCache(index) {
        const cachedView = _viewCache.pop();
        if (cachedView) {
            return viewContainerRef.insert(cachedView, index);
        }
        return null;
    }
    /**
     * @internal
     */
    function getListChanges(changes, items, count, adjustIndexWith) {
        const changedIdxs = new Set();
        const listChanges = [];
        let notifyParent = false;
        let appendedAtEnd = 0;
        const otherMovedIds = [];
        changes.forEachOperation(({ item, previousIndex }, adjustedPreviousIndex, currentIndex) => {
            if (previousIndex == null) {
                // insert
                const index = currentIndex === null ? undefined : currentIndex;
                listChanges.push([
                    index ?? items.length + appendedAtEnd,
                    () => {
                        const [insertedIndex, view] = _insertView(item, count, adjustIndexWith, index);
                        return {
                            view,
                            index: insertedIndex,
                            item,
                        };
                    },
                ]);
                if (index === undefined) {
                    appendedAtEnd++;
                }
                changedIdxs.add(item);
                notifyParent = true;
            }
            else if (currentIndex == null) {
                // remove
                listChanges.push([
                    adjustedPreviousIndex,
                    () => {
                        _detachAndCacheView(adjustedPreviousIndex ?? undefined);
                        return { item };
                    },
                    true,
                ]);
                notifyParent = true;
            }
            else if (adjustedPreviousIndex !== null) {
                // move
                listChanges.push([
                    currentIndex,
                    () => {
                        const view = _moveView(item, adjustedPreviousIndex, currentIndex, count, currentIndex + adjustIndexWith);
                        return {
                            view,
                            index: currentIndex,
                            item,
                        };
                    },
                ]);
                otherMovedIds.push(adjustedPreviousIndex);
                changedIdxs.add(item);
                notifyParent = true;
            }
        });
        changes.forEachIdentityChange(({ item, currentIndex }) => {
            if (currentIndex != null && !changedIdxs.has(item)) {
                listChanges.push([
                    currentIndex,
                    () => {
                        const view = _updateView(item, currentIndex, count, currentIndex + adjustIndexWith);
                        return {
                            view,
                            index: currentIndex,
                            item,
                        };
                    },
                ]);
                changedIdxs.add(item);
            }
        });
        for (let i = 0; i < otherMovedIds.length; i++) {
            const itemIndex = otherMovedIds[i];
            const item = items[itemIndex];
            if (item && !changedIdxs.has(item)) {
                changedIdxs.add(item);
                listChanges.push([
                    itemIndex,
                    () => maybeUpdateView(itemIndex, count, itemIndex + adjustIndexWith, item),
                ]);
            }
        }
        if (changedIdxs.size < items.length) {
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (!changedIdxs.has(item)) {
                    listChanges.push([
                        i,
                        () => maybeUpdateView(i, count, i + adjustIndexWith, item),
                    ]);
                }
            }
        }
        return [listChanges, notifyParent];
    }
    function maybeUpdateView(viewIndex, count, itemIndex, item) {
        const view = viewContainerRef.get(viewIndex);
        if (view.context.count !== count || view.context.index !== itemIndex) {
            return {
                view: _updateView(item, viewIndex, count, itemIndex),
                index: viewIndex,
                item,
            };
        }
        return {
            index: viewIndex,
            view,
            item,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1saXN0LXRlbXBsYXRlLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3RlbXBsYXRlL2V4cGVyaW1lbnRhbC92aXJ0dWFsLXNjcm9sbGluZy9zcmMvbGliL3ZpcnR1YWwtbGlzdC10ZW1wbGF0ZS1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWdDQTs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsZ0NBQWdDLENBRzlDLEVBQ0EsZ0JBQWdCLEVBQ2hCLFdBQVcsRUFDWCxpQkFBaUIsRUFDakIsaUJBQWlCLEVBQ2pCLGlCQUFpQixHQUNXO0lBQzVCLElBQUksVUFBVSxHQUF5QixFQUFFLENBQUM7SUFDMUMsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0lBRWxCLE9BQU87UUFDTCxjQUFjO1FBQ2QsWUFBWSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDNUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtZQUNYLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQzNDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMxQixDQUFDO1lBQ0QsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNsQixDQUFDO0tBQ0YsQ0FBQztJQUVGLFNBQVMsV0FBVyxDQUNsQixJQUFPLEVBQ1AsS0FBYSxFQUNiLEtBQWEsRUFDYixZQUFvQjtRQUVwQixNQUFNLElBQUksR0FBdUIsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdELGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7WUFDNUIsS0FBSztZQUNMLEtBQUssRUFBRSxZQUFZO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUks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Q0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDdEMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO29CQUMzQixXQUFXLENBQUMsSUFBSSxDQUFDO3dCQUNmLENBQUM7d0JBQ0QsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxHQUFHLGVBQWUsRUFBRSxJQUFJLENBQUM7cUJBQzNELENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxTQUFTLGVBQWUsQ0FDdEIsU0FBaUIsRUFDakIsS0FBYSxFQUNiLFNBQWlCLEVBQ2pCLElBQU87UUFFUCxNQUFNLElBQUksR0FBdUIsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2pFLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3JFLE9BQU87Z0JBQ0wsSUFBSSxFQUFFLFdBQVcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUM7Z0JBQ3BELEtBQUssRUFBRSxTQUFTO2dCQUNoQixJQUFJO2FBQ0wsQ0FBQztRQUNKLENBQUM7UUFDRCxPQUFPO1lBQ0wsS0FBSyxFQUFFLFNBQVM7WUFDaEIsSUFBSTtZQUNKLElBQUk7U0FDTCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbWJlZGRlZFZpZXdSZWYsIEl0ZXJhYmxlQ2hhbmdlcywgVmlld1JlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUnhMaXN0Vmlld0NvbnRleHQgfSBmcm9tICdAcngtYW5ndWxhci9jZGsvdGVtcGxhdGUnO1xuaW1wb3J0IHsgVGVtcGxhdGVTZXR0aW5ncyB9IGZyb20gJy4vbW9kZWwnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJ4VmlydHVhbExpc3RDaGFuZ2U8VCwgQz4ge1xuICBpbmRleD86IG51bWJlcjtcbiAgdmlldz86IEVtYmVkZGVkVmlld1JlZjxDPjtcbiAgaXRlbTogVDtcbn1cblxuZXhwb3J0IHR5cGUgUnhWaXJ0dWFsTGlzdENoYW5nZXM8VCwgQz4gPSBbXG4gIG51bWJlcixcbiAgKCkgPT4gUnhWaXJ0dWFsTGlzdENoYW5nZTxULCBDPixcbiAgYm9vbGVhbj8sIC8vIHJlbW92ZWRcbl1bXTtcblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqXG4gKiBBbiBvYmplY3QgdGhhdCBob2xkcyBtZXRob2RzIG5lZWRlZCB0byBpbnRyb2R1Y2UgYWN0aW9ucyB0byBhIGxpc3QgZS5nLiBtb3ZlLCByZW1vdmUsIGluc2VydFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJ4VmlydHVhbExpc3RUZW1wbGF0ZU1hbmFnZXI8VCwgQz4ge1xuICBnZXRMaXN0Q2hhbmdlcyhcbiAgICBjaGFuZ2VzOiBJdGVyYWJsZUNoYW5nZXM8VD4sXG4gICAgaXRlbXM6IFRbXSxcbiAgICByZW5kZXJDb3VudDogbnVtYmVyLFxuICAgIGFkanVzdEluZGV4V2l0aDogbnVtYmVyLFxuICApOiBbUnhWaXJ0dWFsTGlzdENoYW5nZXM8VCwgQz4sIGJvb2xlYW5dO1xuICBzZXRJdGVtQ291bnQoaXRlbUNvdW50OiBudW1iZXIpOiB2b2lkO1xuICBkZXRhY2goKTogdm9pZDtcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqXG4gKiBGYWN0b3J5IHRoYXQgcmV0dXJucyBhIGBMaXN0VGVtcGxhdGVNYW5hZ2VyYCBmb3IgdGhlIHBhc3NlZCBwYXJhbXMuXG4gKlxuICogQHBhcmFtIHRlbXBsYXRlU2V0dGluZ3NcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxMaXN0VGVtcGxhdGVNYW5hZ2VyPFxuICBDIGV4dGVuZHMgUnhMaXN0Vmlld0NvbnRleHQ8VD4sXG4gIFQsXG4+KHtcbiAgdmlld0NvbnRhaW5lclJlZixcbiAgdGVtcGxhdGVSZWYsXG4gIGNyZWF0ZVZpZXdDb250ZXh0LFxuICB1cGRhdGVWaWV3Q29udGV4dCxcbiAgdGVtcGxhdGVDYWNoZVNpemUsXG59OiBUZW1wbGF0ZVNldHRpbmdzPFQsIEMsIGFueT4pOiBSeFZpcnR1YWxMaXN0VGVtcGxhdGVNYW5hZ2VyPFQsIEM+IHtcbiAgbGV0IF92aWV3Q2FjaGU6IEVtYmVkZGVkVmlld1JlZjxDPltdID0gW107XG4gIGxldCBpdGVtQ291bnQgPSAwO1xuXG4gIHJldHVybiB7XG4gICAgZ2V0TGlzdENoYW5nZXMsXG4gICAgc2V0SXRlbUNvdW50OiAoY291bnQpID0+IChpdGVtQ291bnQgPSBjb3VudCksXG4gICAgZGV0YWNoOiAoKSA9PiB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IF92aWV3Q2FjaGUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgX3ZpZXdDYWNoZVtpXS5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgICBfdmlld0NhY2hlID0gW107XG4gICAgfSxcbiAgfTtcblxuICBmdW5jdGlvbiBfdXBkYXRlVmlldyhcbiAgICBpdGVtOiBULFxuICAgIGluZGV4OiBudW1iZXIsXG4gICAgY291bnQ6IG51bWJlcixcbiAgICBjb250ZXh0SW5kZXg6IG51bWJlcixcbiAgKTogRW1iZWRkZWRWaWV3UmVmPEM+IHtcbiAgICBjb25zdCB2aWV3ID0gPEVtYmVkZGVkVmlld1JlZjxDPj52aWV3Q29udGFpbmVyUmVmLmdldChpbmRleCk7XG4gICAgdXBkYXRlVmlld0NvbnRleHQoaXRlbSwgdmlldywge1xuICAgICAgY291bnQsXG4gICAgICBpbmRleDogY29udGV4dEluZGV4LFxuICAgIH0pO1xuICAgIHZpZXcuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIHJldHVybiB2aWV3O1xuICB9XG5cbiAgLyoqXG4gICAqIEluc2VydHMgYSB2aWV3IGZvciBhIG5ldyBpdGVtLCBlaXRoZXIgZnJvbSB0aGUgY2FjaGUgb3IgYnkgY3JlYXRpbmcgYSBuZXdcbiAgICogb25lLlxuICAgKi9cbiAgZnVuY3Rpb24gX2luc2VydFZpZXcoXG4gICAgdmFsdWU6IFQsXG4gICAgY291bnQ6IG51bWJlcixcbiAgICBhZGp1c3RJbmRleFdpdGg6IG51bWJlcixcbiAgICBjdXJyZW50SW5kZXg/OiBudW1iZXIsXG4gICk6IFtudW1iZXIsIEVtYmVkZGVkVmlld1JlZjxDPl0ge1xuICAgIGN1cnJlbnRJbmRleCA9IGN1cnJlbnRJbmRleCA/PyB2aWV3Q29udGFpbmVyUmVmLmxlbmd0aDtcbiAgICBjb25zdCBjb250ZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyBhZGp1c3RJbmRleFdpdGg7XG4gICAgY29uc3QgY2FjaGVkVmlldyA9IF9pbnNlcnRWaWV3RnJvbUNhY2hlKGN1cnJlbnRJbmRleCk7XG4gICAgaWYgKGNhY2hlZFZpZXcpIHtcbiAgICAgIHVwZGF0ZVZpZXdDb250ZXh0KHZhbHVlLCBjYWNoZWRWaWV3LCB7XG4gICAgICAgIGNvdW50LFxuICAgICAgICBpbmRleDogY29udGV4dEluZGV4LFxuICAgICAgfSk7XG4gICAgICBjYWNoZWRWaWV3LmRldGVjdENoYW5nZXMoKTtcbiAgICAgIHJldHVybiBbY3VycmVudEluZGV4LCBjYWNoZWRWaWV3XTtcbiAgICB9XG4gICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZVZpZXdDb250ZXh0KHZhbHVlLCB7XG4gICAgICBjb3VudCxcbiAgICAgIGluZGV4OiBjb250ZXh0SW5kZXgsXG4gICAgfSk7XG4gICAgY29uc3QgdmlldyA9IHZpZXdDb250YWluZXJSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KFxuICAgICAgdGVtcGxhdGVSZWYsXG4gICAgICBjb250ZXh0LFxuICAgICAgY3VycmVudEluZGV4LFxuICAgICk7XG4gICAgdmlldy5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgcmV0dXJuIFtjdXJyZW50SW5kZXgsIHZpZXddO1xuICB9XG5cbiAgLyoqIERldGFjaGVzIHRoZSB2aWV3IGF0IHRoZSBnaXZlbiBpbmRleCBhbmQgaW5zZXJ0cyBpbnRvIHRoZSB2aWV3IGNhY2hlLiAqL1xuICBmdW5jdGlvbiBfZGV0YWNoQW5kQ2FjaGVWaWV3KGluZGV4OiBudW1iZXIgfCB1bmRlZmluZWQpIHtcbiAgICBjb25zdCBkZXRhY2hlZFZpZXcgPSB2aWV3Q29udGFpbmVyUmVmLmRldGFjaChpbmRleCkgYXMgRW1iZWRkZWRWaWV3UmVmPEM+O1xuICAgIF9tYXliZUNhY2hlVmlldyhkZXRhY2hlZFZpZXcpO1xuICAgIGRldGFjaGVkVmlldy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICAvKiogTW92ZXMgdmlldyBhdCB0aGUgcHJldmlvdXMgaW5kZXggdG8gdGhlIGN1cnJlbnQgaW5kZXguICovXG4gIGZ1bmN0aW9uIF9tb3ZlVmlldyhcbiAgICB2YWx1ZTogVCxcbiAgICBhZGp1c3RlZFByZXZpb3VzSW5kZXg6IG51bWJlcixcbiAgICBjdXJyZW50SW5kZXg6IG51bWJlcixcbiAgICBjb3VudDogbnVtYmVyLFxuICAgIGNvbnRleHRJbmRleDogbnVtYmVyLFxuICApOiBFbWJlZGRlZFZpZXdSZWY8Qz4ge1xuICAgIGNvbnN0IG9sZFZpZXcgPSB2aWV3Q29udGFpbmVyUmVmLmdldChhZGp1c3RlZFByZXZpb3VzSW5kZXgpO1xuICAgIGNvbnN0IHZpZXcgPSA8RW1iZWRkZWRWaWV3UmVmPEM+PihcbiAgICAgIHZpZXdDb250YWluZXJSZWYubW92ZShvbGRWaWV3IGFzIFZpZXdSZWYsIGN1cnJlbnRJbmRleClcbiAgICApO1xuICAgIHVwZGF0ZVZpZXdDb250ZXh0KHZhbHVlLCB2aWV3LCB7XG4gICAgICBjb3VudCxcbiAgICAgIGluZGV4OiBjb250ZXh0SW5kZXgsXG4gICAgfSk7XG4gICAgdmlldy5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgcmV0dXJuIHZpZXc7XG4gIH1cblxuICAvKipcbiAgICogQ2FjaGUgdGhlIGdpdmVuIGRldGFjaGVkIHZpZXcuIElmIHRoZSBjYWNoZSBpcyBmdWxsLCB0aGUgdmlldyB3aWxsIGJlXG4gICAqIGRlc3Ryb3llZC5cbiAgICovXG4gIGZ1bmN0aW9uIF9tYXliZUNhY2hlVmlldyh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8Qz4pIHtcbiAgICBpZiAoX3ZpZXdDYWNoZS5sZW5ndGggPCB0ZW1wbGF0ZUNhY2hlU2l6ZSkge1xuICAgICAgX3ZpZXdDYWNoZS5wdXNoKHZpZXcpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdmlld0NvbnRhaW5lclJlZi5pbmRleE9mKHZpZXcpO1xuXG4gICAgICAvLyBUaGUgaG9zdCBjb21wb25lbnQgY291bGQgcmVtb3ZlIHZpZXdzIGZyb20gdGhlIGNvbnRhaW5lciBvdXRzaWRlIG9mXG4gICAgICAvLyB0aGUgdmlldyByZXBlYXRlci4gSXQncyB1bmxpa2VseSB0aGlzIHdpbGwgb2NjdXIsIGJ1dCBqdXN0IGluIGNhc2UsXG4gICAgICAvLyBkZXN0cm95IHRoZSB2aWV3IG9uIGl0cyBvd24sIG90aGVyd2lzZSBkZXN0cm95IGl0IHRocm91Z2ggdGhlXG4gICAgICAvLyBjb250YWluZXIgdG8gZW5zdXJlIHRoYXQgYWxsIHRoZSByZWZlcmVuY2VzIGFyZSByZW1vdmVkLlxuICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICB2aWV3LmRlc3Ryb3koKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZXdDb250YWluZXJSZWYucmVtb3ZlKGluZGV4KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKiogSW5zZXJ0cyBhIHJlY3ljbGVkIHZpZXcgZnJvbSB0aGUgY2FjaGUgYXQgdGhlIGdpdmVuIGluZGV4LiAqL1xuICBmdW5jdGlvbiBfaW5zZXJ0Vmlld0Zyb21DYWNoZShpbmRleD86IG51bWJlcik6IEVtYmVkZGVkVmlld1JlZjxDPiB8IG51bGwge1xuICAgIGNvbnN0IGNhY2hlZFZpZXcgPSBfdmlld0NhY2hlLnBvcCgpO1xuICAgIGlmIChjYWNoZWRWaWV3KSB7XG4gICAgICByZXR1cm4gPEVtYmVkZGVkVmlld1JlZjxDPj52aWV3Q29udGFpbmVyUmVmLmluc2VydChjYWNoZWRWaWV3LCBpbmRleCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0TGlzdENoYW5nZXMoXG4gICAgY2hhbmdlczogSXRlcmFibGVDaGFuZ2VzPFQ+LFxuICAgIGl0ZW1zOiBUW10sXG4gICAgY291bnQ6IG51bWJlcixcbiAgICBhZGp1c3RJbmRleFdpdGg6IG51bWJlcixcbiAgKTogW1J4VmlydHVhbExpc3RDaGFuZ2VzPFQsIEM+LCBib29sZWFuXSB7XG4gICAgY29uc3QgY2hhbmdlZElkeHMgPSBuZXcgU2V0PFQ+KCk7XG4gICAgY29uc3QgbGlzdENoYW5nZXM6IFJ4VmlydHVhbExpc3RDaGFuZ2VzPFQsIEM+ID0gW107XG4gICAgbGV0IG5vdGlmeVBhcmVudCA9IGZhbHNlO1xuICAgIGxldCBhcHBlbmRlZEF0RW5kID0gMDtcbiAgICBjb25zdCBvdGhlck1vdmVkSWRzOiBudW1iZXJbXSA9IFtdO1xuICAgIGNoYW5nZXMuZm9yRWFjaE9wZXJhdGlvbihcbiAgICAgICh7IGl0ZW0sIHByZXZpb3VzSW5kZXggfSwgYWRqdXN0ZWRQcmV2aW91c0luZGV4LCBjdXJyZW50SW5kZXgpID0+IHtcbiAgICAgICAgaWYgKHByZXZpb3VzSW5kZXggPT0gbnVsbCkge1xuICAgICAgICAgIC8vIGluc2VydFxuICAgICAgICAgIGNvbnN0IGluZGV4ID0gY3VycmVudEluZGV4ID09PSBudWxsID8gdW5kZWZpbmVkIDogY3VycmVudEluZGV4O1xuICAgICAgICAgIGxpc3RDaGFuZ2VzLnB1c2goW1xuICAgICAgICAgICAgaW5kZXggPz8gaXRlbXMubGVuZ3RoICsgYXBwZW5kZWRBdEVuZCxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgW2luc2VydGVkSW5kZXgsIHZpZXddID0gX2luc2VydFZpZXcoXG4gICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICBjb3VudCxcbiAgICAgICAgICAgICAgICBhZGp1c3RJbmRleFdpdGgsXG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdmlldyxcbiAgICAgICAgICAgICAgICBpbmRleDogaW5zZXJ0ZWRJbmRleCxcbiAgICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdKTtcbiAgICAgICAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgYXBwZW5kZWRBdEVuZCsrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjaGFuZ2VkSWR4cy5hZGQoaXRlbSk7XG4gICAgICAgICAgbm90aWZ5UGFyZW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50SW5kZXggPT0gbnVsbCkge1xuICAgICAgICAgIC8vIHJlbW92ZVxuICAgICAgICAgIGxpc3RDaGFuZ2VzLnB1c2goW1xuICAgICAgICAgICAgYWRqdXN0ZWRQcmV2aW91c0luZGV4IGFzIG51bWJlcixcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgX2RldGFjaEFuZENhY2hlVmlldyhhZGp1c3RlZFByZXZpb3VzSW5kZXggPz8gdW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgaXRlbSB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgXSk7XG4gICAgICAgICAgbm90aWZ5UGFyZW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChhZGp1c3RlZFByZXZpb3VzSW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICAvLyBtb3ZlXG4gICAgICAgICAgbGlzdENoYW5nZXMucHVzaChbXG4gICAgICAgICAgICBjdXJyZW50SW5kZXgsXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBfbW92ZVZpZXcoXG4gICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICBhZGp1c3RlZFByZXZpb3VzSW5kZXgsXG4gICAgICAgICAgICAgICAgY3VycmVudEluZGV4LFxuICAgICAgICAgICAgICAgIGNvdW50LFxuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmRleCArIGFkanVzdEluZGV4V2l0aCxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB2aWV3LFxuICAgICAgICAgICAgICAgIGluZGV4OiBjdXJyZW50SW5kZXgsXG4gICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSk7XG4gICAgICAgICAgb3RoZXJNb3ZlZElkcy5wdXNoKGFkanVzdGVkUHJldmlvdXNJbmRleCk7XG4gICAgICAgICAgY2hhbmdlZElkeHMuYWRkKGl0ZW0pO1xuICAgICAgICAgIG5vdGlmeVBhcmVudCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKTtcbiAgICBjaGFuZ2VzLmZvckVhY2hJZGVudGl0eUNoYW5nZSgoeyBpdGVtLCBjdXJyZW50SW5kZXggfSkgPT4ge1xuICAgICAgaWYgKGN1cnJlbnRJbmRleCAhPSBudWxsICYmICFjaGFuZ2VkSWR4cy5oYXMoaXRlbSkpIHtcbiAgICAgICAgbGlzdENoYW5nZXMucHVzaChbXG4gICAgICAgICAgY3VycmVudEluZGV4LFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZpZXcgPSBfdXBkYXRlVmlldyhcbiAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgY3VycmVudEluZGV4LFxuICAgICAgICAgICAgICBjb3VudCxcbiAgICAgICAgICAgICAgY3VycmVudEluZGV4ICsgYWRqdXN0SW5kZXhXaXRoLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHZpZXcsXG4gICAgICAgICAgICAgIGluZGV4OiBjdXJyZW50SW5kZXgsXG4gICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0sXG4gICAgICAgIF0pO1xuICAgICAgICBjaGFuZ2VkSWR4cy5hZGQoaXRlbSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvdGhlck1vdmVkSWRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpdGVtSW5kZXggPSBvdGhlck1vdmVkSWRzW2ldO1xuICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2l0ZW1JbmRleF07XG4gICAgICBpZiAoaXRlbSAmJiAhY2hhbmdlZElkeHMuaGFzKGl0ZW0pKSB7XG4gICAgICAgIGNoYW5nZWRJZHhzLmFkZChpdGVtKTtcbiAgICAgICAgbGlzdENoYW5nZXMucHVzaChbXG4gICAgICAgICAgaXRlbUluZGV4LFxuICAgICAgICAgICgpID0+XG4gICAgICAgICAgICBtYXliZVVwZGF0ZVZpZXcoXG4gICAgICAgICAgICAgIGl0ZW1JbmRleCxcbiAgICAgICAgICAgICAgY291bnQsXG4gICAgICAgICAgICAgIGl0ZW1JbmRleCArIGFkanVzdEluZGV4V2l0aCxcbiAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICksXG4gICAgICAgIF0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2hhbmdlZElkeHMuc2l6ZSA8IGl0ZW1zLmxlbmd0aCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBpdGVtID0gaXRlbXNbaV07XG4gICAgICAgIGlmICghY2hhbmdlZElkeHMuaGFzKGl0ZW0pKSB7XG4gICAgICAgICAgbGlzdENoYW5nZXMucHVzaChbXG4gICAgICAgICAgICBpLFxuICAgICAgICAgICAgKCkgPT4gbWF5YmVVcGRhdGVWaWV3KGksIGNvdW50LCBpICsgYWRqdXN0SW5kZXhXaXRoLCBpdGVtKSxcbiAgICAgICAgICBdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gW2xpc3RDaGFuZ2VzLCBub3RpZnlQYXJlbnRdO1xuICB9XG5cbiAgZnVuY3Rpb24gbWF5YmVVcGRhdGVWaWV3KFxuICAgIHZpZXdJbmRleDogbnVtYmVyLFxuICAgIGNvdW50OiBudW1iZXIsXG4gICAgaXRlbUluZGV4OiBudW1iZXIsXG4gICAgaXRlbTogVCxcbiAgKSB7XG4gICAgY29uc3QgdmlldyA9IDxFbWJlZGRlZFZpZXdSZWY8Qz4+dmlld0NvbnRhaW5lclJlZi5nZXQodmlld0luZGV4KTtcbiAgICBpZiAodmlldy5jb250ZXh0LmNvdW50ICE9PSBjb3VudCB8fCB2aWV3LmNvbnRleHQuaW5kZXggIT09IGl0ZW1JbmRleCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmlldzogX3VwZGF0ZVZpZXcoaXRlbSwgdmlld0luZGV4LCBjb3VudCwgaXRlbUluZGV4KSxcbiAgICAgICAgaW5kZXg6IHZpZXdJbmRleCxcbiAgICAgICAgaXRlbSxcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBpbmRleDogdmlld0luZGV4LFxuICAgICAgdmlldyxcbiAgICAgIGl0ZW0sXG4gICAgfTtcbiAgfVxufVxuIl19