import { Directive, inject, Input, } from '@angular/core';
import { coalesceWith } from '@rx-angular/cdk/coalescing';
import { combineLatest, ReplaySubject, Subject, } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, startWith, switchMap, takeUntil, tap, } from 'rxjs/operators';
import { RxVirtualScrollStrategy, } from '../model';
import { calculateVisibleContainerSize, parseScrollTopBoundaries, toBoolean, unpatchedMicroTask, } from '../util';
import { DEFAULT_ITEM_SIZE, DEFAULT_RUNWAY_ITEMS, DEFAULT_RUNWAY_ITEMS_OPPOSITE, RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS, } from '../virtual-scroll.config';
import * as i0 from "@angular/core";
const defaultItemSize = () => DEFAULT_ITEM_SIZE;
/**
 * @Directive DynamicSizeVirtualScrollStrategy
 *
 * @description
 *
 * The `DynamicSizeVirtualScrollStrategy` is very similar to the `AutosizeVirtualScrollStrategy`.
 * It positions items based on a function determining its size.
 *
 * @docsCategory RxVirtualFor
 * @docsPage RxVirtualFor
 * @publicApi
 */
export class DynamicSizeVirtualScrollStrategy extends RxVirtualScrollStrategy {
    defaults = inject(RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS, {
        optional: true,
    });
    /**
     * @description
     * The amount of items to render upfront in scroll direction
     */
    runwayItems = this.defaults?.runwayItems ?? DEFAULT_RUNWAY_ITEMS;
    /**
     * @description
     * The amount of items to render upfront in reverse scroll direction
     */
    runwayItemsOpposite = this.defaults?.runwayItemsOpposite ?? DEFAULT_RUNWAY_ITEMS_OPPOSITE;
    /**
     * @description
     * When enabled, the scroll strategy stops removing views from the viewport,
     * instead it only adds views. This setting can be changed on the fly. Views will be added in both directions
     * according to the user interactions.
     */
    appendOnly = false;
    /**
     * @description
     * If this flag is true, the virtual scroll strategy maintains the scrolled item when new data
     * is prepended to the list. This is very useful when implementing a reversed infinite scroller, that prepends
     * data instead of appending it
     */
    keepScrolledIndexOnPrepend = false;
    /**
     * @description
     * Function returning the size of an item
     */
    set itemSize(fn) {
        if (fn) {
            this._itemSizeFn = fn;
        }
    }
    get itemSize() {
        return this._itemSizeFn;
    }
    _itemSizeFn = defaultItemSize;
    /** @internal */
    waitForScroll = false;
    /** @internal */
    isStable$ = new ReplaySubject(1);
    /** @internal */
    get isStable() {
        return this.isStable$.pipe(filter((w) => w));
    }
    /** @internal */
    viewport = null;
    /** @internal */
    viewRepeater = null;
    /** @internal */
    _contentSize$ = new ReplaySubject(1);
    /** @internal */
    contentSize$ = this._contentSize$.asObservable();
    /** @internal */
    _contentSize = 0;
    /** @internal */
    set contentSize(size) {
        this._contentSize = size;
        this._contentSize$.next(size);
    }
    get contentSize() {
        return this._contentSize;
    }
    /** @internal */
    _renderedRange$ = new ReplaySubject(1);
    /** @internal */
    renderedRange$ = this._renderedRange$.asObservable();
    /** @internal */
    _renderedRange = { start: 0, end: 0 };
    // range of items where size is known and doesn't need to be re-calculated
    /** @internal */
    set renderedRange(range) {
        if (this._renderedRange.start !== range.start ||
            this._renderedRange.end !== range.end) {
            this._renderedRange = range;
            this._renderedRange$.next(range);
        }
    }
    /** @internal */
    get renderedRange() {
        return this._renderedRange;
    }
    /** @internal */
    _scrolledIndex$ = new ReplaySubject(1);
    /** @internal */
    scrolledIndex$ = this._scrolledIndex$.pipe(distinctUntilChanged());
    _scrolledIndex = 0;
    /** @internal */
    set scrolledIndex(index) {
        this._scrolledIndex = index;
        this._scrolledIndex$.next(index);
    }
    get scrolledIndex() {
        return this._scrolledIndex;
    }
    /** @internal */
    get contentLength() {
        return this._virtualItems.length;
    }
    /** @internal */
    containerSize = 0;
    /** @internal */
    _virtualItems = [];
    /** @internal */
    scrollTop = 0;
    /** @internal */
    scrollTopWithOutOffset = 0;
    /** @internal */
    scrollTopAfterOffset = 0;
    /** @internal */
    viewportOffset = 0;
    /** @internal */
    direction = 'down';
    /** @internal */
    anchorScrollTop = 0;
    /** @internal */
    anchorItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    lastScreenItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    detached$ = new Subject();
    /** @internal */
    recalculateRange$ = new Subject();
    /** @internal */
    until$() {
        return (o$) => o$.pipe(takeUntil(this.detached$));
    }
    /** @internal */
    ngOnChanges(changes) {
        if ((changes['runwayItemsOpposite'] &&
            !changes['runwayItemsOpposite'].firstChange) ||
            (changes['runwayItems'] && !changes['runwayItems'].firstChange)) {
            this.recalculateRange$.next();
        }
    }
    /** @internal */
    ngOnDestroy() {
        this.detach();
    }
    /** @internal */
    attach(viewport, viewRepeater) {
        this.viewport = viewport;
        this.viewRepeater = viewRepeater;
        this.maintainVirtualItems();
        this.calcRenderedRange();
        this.positionElements();
    }
    /** @internal */
    detach() {
        this.viewport = null;
        this.viewRepeater = null;
        this._virtualItems = [];
        this.detached$.next();
    }
    scrollToIndex(index, behavior) {
        const _index = Math.min(Math.max(index, 0), this.contentLength - 1);
        let scrollTo = 0;
        for (let i = 0; i < _index; i++) {
            scrollTo += this._virtualItems[i].size;
        }
        this.waitForScroll =
            scrollTo !== this.scrollTop && this.contentSize > this.containerSize;
        if (this.waitForScroll) {
            this.isStable$.next(false);
        }
        this.viewport.scrollTo(this.viewportOffset + scrollTo, behavior);
    }
    /** @internal */
    maintainVirtualItems() {
        const valueArray$ = this.viewRepeater.values$.pipe(map((values) => Array.isArray(values)
            ? values
            : values != null
                ? Array.from(values)
                : []), shareReplay({ bufferSize: 1, refCount: true }));
        valueArray$.pipe(this.until$()).subscribe((dataArr) => {
            if (!dataArr.length) {
                this._virtualItems = [];
                this.contentSize = 0;
                this.recalculateRange$.next();
            }
            else {
                let shouldRecalculateRange = false;
                let contentSize = 0;
                for (let i = 0; i < dataArr.length; i++) {
                    const oldSize = this._virtualItems[i]?.size;
                    const newSize = this.itemSize(dataArr[i]);
                    contentSize += newSize;
                    if (oldSize === undefined || oldSize !== newSize) {
                        this._virtualItems[i] = { size: newSize };
                        if (!shouldRecalculateRange &&
                            (!this.contentSize ||
                                (i >= this.renderedRange.start && i < this.renderedRange.end))) {
                            shouldRecalculateRange = true;
                        }
                    }
                }
                this.contentSize = contentSize;
                if (shouldRecalculateRange) {
                    this.recalculateRange$.next();
                }
            }
        });
        let valueCache = {};
        /*
         * when keepScrolledIndexOnPrepend is active, we need to listen to data changes and figure out what was appended
         * before the last scrolledToItem
         */
        valueArray$
            .pipe(
        // TODO: this might cause issues when turning on/off at runtime
        filter(() => this.keepScrolledIndexOnPrepend), this.until$())
            .subscribe((valueArray) => {
            const trackBy = this.viewRepeater._trackBy;
            let scrollTo = this.scrolledIndex;
            const dataLength = valueArray.length;
            const oldDataLength = Object.keys(valueCache).length;
            if (oldDataLength > 0) {
                let i = 0;
                // check for each item from the last known scrolledIndex if it's an insert
                for (i; i <= scrollTo && i < dataLength; i++) {
                    // item is not in the valueCache, so it was added
                    if (!valueCache[trackBy(i, valueArray[i])]) {
                        scrollTo++;
                    }
                }
            }
            valueCache = {};
            valueArray.forEach((v, i) => (valueCache[trackBy(i, v)] = v));
            if (scrollTo !== this.scrolledIndex) {
                this.scrollToIndex(scrollTo);
            }
        });
    }
    /** @internal */
    calcRenderedRange() {
        combineLatest([
            this.viewport.containerRect$.pipe(map(({ height }) => {
                this.containerSize = height;
                return height;
            }), distinctUntilChanged()),
            this.viewport.elementScrolled$.pipe(startWith(void 0), tap(() => {
                this.viewportOffset = this.viewport.measureOffset();
                const { scrollTop, scrollTopWithOutOffset, scrollTopAfterOffset } = parseScrollTopBoundaries(this.viewport.getScrollTop(), this.viewportOffset, this._contentSize, this.containerSize);
                this.direction =
                    scrollTopWithOutOffset > this.scrollTopWithOutOffset
                        ? 'down'
                        : 'up';
                this.scrollTopWithOutOffset = scrollTopWithOutOffset;
                this.scrollTopAfterOffset = scrollTopAfterOffset;
                this.scrollTop = scrollTop;
                this.waitForScroll = false;
            })),
            this._contentSize$.pipe(distinctUntilChanged()),
            this.recalculateRange$.pipe(startWith(void 0)),
        ])
            .pipe(
        // make sure to not over calculate things by coalescing all triggers to the next microtask
        coalesceWith(unpatchedMicroTask()), map(() => {
            const range = { start: 0, end: 0 };
            const length = this.contentLength;
            const delta = this.scrollTop - this.anchorScrollTop;
            if (this.scrollTop == 0) {
                this.anchorItem = { index: 0, offset: 0 };
            }
            else {
                this.anchorItem = this.calculateAnchoredItem(this.anchorItem, delta);
            }
            this.scrolledIndex = this.anchorItem.index;
            this.anchorScrollTop = this.scrollTop;
            this.lastScreenItem = this.calculateAnchoredItem(this.anchorItem, calculateVisibleContainerSize(this.containerSize, this.scrollTopWithOutOffset, this.scrollTopAfterOffset));
            if (this.direction === 'up') {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItems);
                range.end = Math.min(length, this.lastScreenItem.index + this.runwayItemsOpposite);
            }
            else {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItemsOpposite);
                range.end = Math.min(length, this.lastScreenItem.index + this.runwayItems);
            }
            if (this.appendOnly) {
                range.start = Math.min(this._renderedRange.start, range.start);
                range.end = Math.max(this._renderedRange.end, range.end);
            }
            return range;
        }))
            .pipe(this.until$())
            .subscribe((range) => {
            this.renderedRange = range;
            this.isStable$.next(!this.waitForScroll);
        });
    }
    /** @internal */
    positionElements() {
        this.viewRepeater.renderingStart$.pipe(switchMap((batchedUpdates) => {
            const renderedRange = this.renderedRange;
            const adjustIndexWith = renderedRange.start;
            const initialIndex = batchedUpdates.size
                ? batchedUpdates.values().next().value + this.renderedRange.start
                : this.renderedRange.start;
            let position = this.calcInitialPosition(initialIndex);
            return this.viewRepeater.viewRendered$.pipe(tap(({ view, index: viewIndex, item }) => {
                const index = viewIndex + adjustIndexWith;
                const size = this.getItemSize(index);
                this.positionElement(this.getElement(view), position);
                position += size;
                this.viewRenderCallback.next({
                    index,
                    view,
                    item,
                });
            }));
        }), this.until$()).subscribe();
    }
    /**
     * @internal
     * heavily inspired by
     *   https://github.com/GoogleChromeLabs/ui-element-samples/blob/gh-pages/infinite-scroller/scripts/infinite-scroll.js
     */
    calculateAnchoredItem(initialAnchor, delta) {
        if (delta == 0)
            return initialAnchor;
        delta += initialAnchor.offset;
        let i = initialAnchor.index;
        const items = this._virtualItems;
        if (delta < 0) {
            while (delta < 0 && i > 0) {
                delta += items[i - 1].size;
                i--;
            }
        }
        else {
            while (delta > 0 && i < items.length && items[i].size <= delta) {
                delta -= items[i].size;
                i++;
            }
        }
        return {
            index: Math.min(i, items.length),
            offset: delta,
        };
    }
    /** @internal */
    calcInitialPosition(start) {
        // Calculate position of starting node
        let pos = this.anchorScrollTop - this.anchorItem.offset;
        let i = this.anchorItem.index;
        while (i > start) {
            const itemSize = this.getItemSize(i - 1);
            pos -= itemSize;
            i--;
        }
        while (i < start) {
            const itemSize = this.getItemSize(i);
            pos += itemSize;
            i++;
        }
        return pos;
    }
    /** @internal */
    getItemSize(index) {
        return this._virtualItems[index].size;
    }
    /** @internal */
    positionElement(element, scrollTop) {
        element.style.position = 'absolute';
        element.style.transform = `translateY(${scrollTop}px)`;
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: DynamicSizeVirtualScrollStrategy, deps: null, target: i0.ɵɵFactoryTarget.Directive });
    /** @nocollapse */ static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "18.0.1", type: DynamicSizeVirtualScrollStrategy, isStandalone: true, selector: "rx-virtual-scroll-viewport[dynamic]", inputs: { runwayItems: "runwayItems", runwayItemsOpposite: "runwayItemsOpposite", appendOnly: ["appendOnly", "appendOnly", toBoolean], keepScrolledIndexOnPrepend: ["keepScrolledIndexOnPrepend", "keepScrolledIndexOnPrepend", toBoolean], itemSize: ["dynamic", "itemSize"] }, providers: [
            {
                provide: RxVirtualScrollStrategy,
                useExisting: DynamicSizeVirtualScrollStrategy,
            },
        ], usesInheritance: true, usesOnChanges: true, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: DynamicSizeVirtualScrollStrategy, decorators: [{
            type: Directive,
            args: [{
                    selector: 'rx-virtual-scroll-viewport[dynamic]',
                    providers: [
                        {
                            provide: RxVirtualScrollStrategy,
                            useExisting: DynamicSizeVirtualScrollStrategy,
                        },
                    ],
                    standalone: true,
                }]
        }], propDecorators: { runwayItems: [{
                type: Input
            }], runwayItemsOpposite: [{
                type: Input
            }], appendOnly: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], keepScrolledIndexOnPrepend: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], itemSize: [{
                type: Input,
                args: ['dynamic']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1zaXplLXZpcnR1YWwtc2Nyb2xsLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy90ZW1wbGF0ZS9leHBlcmltZW50YWwvdmlydHVhbC1zY3JvbGxpbmcvc3JjL2xpYi9zY3JvbGwtc3RyYXRlZ2llcy9keW5hbWljLXNpemUtdmlydHVhbC1zY3JvbGwtc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sS0FBSyxHQUtOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMxRCxPQUFPLEVBQ0wsYUFBYSxFQUdiLGFBQWEsRUFDYixPQUFPLEdBQ1IsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixHQUFHLEVBQ0gsV0FBVyxFQUNYLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFFTCx1QkFBdUIsR0FHeEIsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUNMLDZCQUE2QixFQUM3Qix3QkFBd0IsRUFDeEIsU0FBUyxFQUNULGtCQUFrQixHQUNuQixNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLG9CQUFvQixFQUNwQiw2QkFBNkIsRUFDN0IsaUNBQWlDLEdBQ2xDLE1BQU0sMEJBQTBCLENBQUM7O0FBYWxDLE1BQU0sZUFBZSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0FBRWhEOzs7Ozs7Ozs7OztHQVdHO0FBV0gsTUFBTSxPQUFPLGdDQUlYLFNBQVEsdUJBQTZCO0lBR3BCLFFBQVEsR0FBSSxNQUFNLENBQUMsaUNBQWlDLEVBQUU7UUFDckUsUUFBUSxFQUFFLElBQUk7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O1FBQ3BDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLGNBQWMsU0FBUyxLQUFLLENBQUM7SUFDekQsQ0FBQzswSEFoZFUsZ0NBQWdDOzhHQUFoQyxnQ0FBZ0Msa01BOEJ2QixTQUFTLDRGQVFULFNBQVMsbURBOUNsQjtZQUNUO2dCQUNFLE9BQU8sRUFBRSx1QkFBdUI7Z0JBQ2hDLFdBQVcsRUFBRSxnQ0FBZ0M7YUFDOUM7U0FDRjs7MkZBR1UsZ0NBQWdDO2tCQVY1QyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxxQ0FBcUM7b0JBQy9DLFNBQVMsRUFBRTt3QkFDVDs0QkFDRSxPQUFPLEVBQUUsdUJBQXVCOzRCQUNoQyxXQUFXLGtDQUFrQzt5QkFDOUM7cUJBQ0Y7b0JBQ0QsVUFBVSxFQUFFLElBQUk7aUJBQ2pCOzhCQWdCVSxXQUFXO3NCQUFuQixLQUFLO2dCQU1HLG1CQUFtQjtzQkFBM0IsS0FBSztnQkFTMkIsVUFBVTtzQkFBMUMsS0FBSzt1QkFBQyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUU7Z0JBUUUsMEJBQTBCO3NCQUExRCxLQUFLO3VCQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRTtnQkFPM0IsUUFBUTtzQkFEWCxLQUFLO3VCQUFDLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIE5nSXRlcmFibGUsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvYWxlc2NlV2l0aCB9IGZyb20gJ0ByeC1hbmd1bGFyL2Nkay9jb2FsZXNjaW5nJztcbmltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbixcbiAgT2JzZXJ2YWJsZSxcbiAgUmVwbGF5U3ViamVjdCxcbiAgU3ViamVjdCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIHNoYXJlUmVwbGF5LFxuICBzdGFydFdpdGgsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZVVudGlsLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIExpc3RSYW5nZSxcbiAgUnhWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3ksXG4gIFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0LFxuICBSeFZpcnR1YWxWaWV3UmVwZWF0ZXIsXG59IGZyb20gJy4uL21vZGVsJztcbmltcG9ydCB7XG4gIGNhbGN1bGF0ZVZpc2libGVDb250YWluZXJTaXplLFxuICBwYXJzZVNjcm9sbFRvcEJvdW5kYXJpZXMsXG4gIHRvQm9vbGVhbixcbiAgdW5wYXRjaGVkTWljcm9UYXNrLFxufSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7XG4gIERFRkFVTFRfSVRFTV9TSVpFLFxuICBERUZBVUxUX1JVTldBWV9JVEVNUyxcbiAgREVGQVVMVF9SVU5XQVlfSVRFTVNfT1BQT1NJVEUsXG4gIFJYX1ZJUlRVQUxfU0NST0xMX0RFRkFVTFRfT1BUSU9OUyxcbn0gZnJvbSAnLi4vdmlydHVhbC1zY3JvbGwuY29uZmlnJztcblxuLyoqIEBpbnRlcm5hbCAqL1xudHlwZSBWaXJ0dWFsVmlld0l0ZW0gPSB7XG4gIHNpemU6IG51bWJlcjtcbn07XG5cbi8qKiBAaW50ZXJuYWwgKi9cbnR5cGUgQW5jaG9ySXRlbSA9IHtcbiAgaW5kZXg6IG51bWJlcjtcbiAgb2Zmc2V0OiBudW1iZXI7XG59O1xuXG5jb25zdCBkZWZhdWx0SXRlbVNpemUgPSAoKSA9PiBERUZBVUxUX0lURU1fU0laRTtcblxuLyoqXG4gKiBARGlyZWN0aXZlIER5bmFtaWNTaXplVmlydHVhbFNjcm9sbFN0cmF0ZWd5XG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogVGhlIGBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneWAgaXMgdmVyeSBzaW1pbGFyIHRvIHRoZSBgQXV0b3NpemVWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3lgLlxuICogSXQgcG9zaXRpb25zIGl0ZW1zIGJhc2VkIG9uIGEgZnVuY3Rpb24gZGV0ZXJtaW5pbmcgaXRzIHNpemUuXG4gKlxuICogQGRvY3NDYXRlZ29yeSBSeFZpcnR1YWxGb3JcbiAqIEBkb2NzUGFnZSBSeFZpcnR1YWxGb3JcbiAqIEBwdWJsaWNBcGlcbiAqL1xuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAncngtdmlydHVhbC1zY3JvbGwtdmlld3BvcnRbZHluYW1pY10nLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICAgIHVzZUV4aXN0aW5nOiBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICB9LFxuICBdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneTxcbiAgICBULFxuICAgIFUgZXh0ZW5kcyBOZ0l0ZXJhYmxlPFQ+ID0gTmdJdGVyYWJsZTxUPixcbiAgPlxuICBleHRlbmRzIFJ4VmlydHVhbFNjcm9sbFN0cmF0ZWd5PFQsIFU+XG4gIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3lcbntcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0cz8gPSBpbmplY3QoUlhfVklSVFVBTF9TQ1JPTExfREVGQVVMVF9PUFRJT05TLCB7XG4gICAgb3B0aW9uYWw6IHRydWUsXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiBzY3JvbGwgZGlyZWN0aW9uXG4gICAqL1xuICBASW5wdXQoKSBydW53YXlJdGVtcyA9IHRoaXMuZGVmYXVsdHM/LnJ1bndheUl0ZW1zID8/IERFRkFVTFRfUlVOV0FZX0lURU1TO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiByZXZlcnNlIHNjcm9sbCBkaXJlY3Rpb25cbiAgICovXG4gIEBJbnB1dCgpIHJ1bndheUl0ZW1zT3Bwb3NpdGUgPVxuICAgIHRoaXMuZGVmYXVsdHM/LnJ1bndheUl0ZW1zT3Bwb3NpdGUgPz8gREVGQVVMVF9SVU5XQVlfSVRFTVNfT1BQT1NJVEU7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBXaGVuIGVuYWJsZWQsIHRoZSBzY3JvbGwgc3RyYXRlZ3kgc3RvcHMgcmVtb3Zpbmcgdmlld3MgZnJvbSB0aGUgdmlld3BvcnQsXG4gICAqIGluc3RlYWQgaXQgb25seSBhZGRzIHZpZXdzLiBUaGlzIHNldHRpbmcgY2FuIGJlIGNoYW5nZWQgb24gdGhlIGZseS4gVmlld3Mgd2lsbCBiZSBhZGRlZCBpbiBib3RoIGRpcmVjdGlvbnNcbiAgICogYWNjb3JkaW5nIHRvIHRoZSB1c2VyIGludGVyYWN0aW9ucy5cbiAgICovXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogdG9Cb29sZWFuIH0pIGFwcGVuZE9ubHkgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIElmIHRoaXMgZmxhZyBpcyB0cnVlLCB0aGUgdmlydHVhbCBzY3JvbGwgc3RyYXRlZ3kgbWFpbnRhaW5zIHRoZSBzY3JvbGxlZCBpdGVtIHdoZW4gbmV3IGRhdGFcbiAgICogaXMgcHJlcGVuZGVkIHRvIHRoZSBsaXN0LiBUaGlzIGlzIHZlcnkgdXNlZnVsIHdoZW4gaW1wbGVtZW50aW5nIGEgcmV2ZXJzZWQgaW5maW5pdGUgc2Nyb2xsZXIsIHRoYXQgcHJlcGVuZHNcbiAgICogZGF0YSBpbnN0ZWFkIG9mIGFwcGVuZGluZyBpdFxuICAgKi9cbiAgQElucHV0KHsgdHJhbnNmb3JtOiB0b0Jvb2xlYW4gfSkga2VlcFNjcm9sbGVkSW5kZXhPblByZXBlbmQgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEZ1bmN0aW9uIHJldHVybmluZyB0aGUgc2l6ZSBvZiBhbiBpdGVtXG4gICAqL1xuICBASW5wdXQoJ2R5bmFtaWMnKVxuICBzZXQgaXRlbVNpemUoZm46IChpdGVtOiBUKSA9PiBudW1iZXIpIHtcbiAgICBpZiAoZm4pIHtcbiAgICAgIHRoaXMuX2l0ZW1TaXplRm4gPSBmbjtcbiAgICB9XG4gIH1cbiAgZ2V0IGl0ZW1TaXplKCkge1xuICAgIHJldHVybiB0aGlzLl9pdGVtU2l6ZUZuO1xuICB9XG4gIHByaXZhdGUgX2l0ZW1TaXplRm46IChpdGVtOiBUKSA9PiBudW1iZXIgPSBkZWZhdWx0SXRlbVNpemU7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHdhaXRGb3JTY3JvbGwgPSBmYWxzZTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgaXNTdGFibGUkID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oMSk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBvdmVycmlkZSBnZXQgaXNTdGFibGUoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuaXNTdGFibGUkLnBpcGUoZmlsdGVyKCh3KSA9PiB3KSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgdmlld3BvcnQ6IFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0IHwgbnVsbCA9IG51bGw7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB2aWV3UmVwZWF0ZXI6IFJ4VmlydHVhbFZpZXdSZXBlYXRlcjxULCBVPiB8IG51bGwgPSBudWxsO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfY29udGVudFNpemUkID0gbmV3IFJlcGxheVN1YmplY3Q8bnVtYmVyPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSBjb250ZW50U2l6ZSQgPSB0aGlzLl9jb250ZW50U2l6ZSQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF9jb250ZW50U2l6ZSA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgY29udGVudFNpemUoc2l6ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fY29udGVudFNpemUgPSBzaXplO1xuICAgIHRoaXMuX2NvbnRlbnRTaXplJC5uZXh0KHNpemUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY29udGVudFNpemUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY29udGVudFNpemU7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlbmRlcmVkUmFuZ2UkID0gbmV3IFJlcGxheVN1YmplY3Q8TGlzdFJhbmdlPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSByZW5kZXJlZFJhbmdlJCA9IHRoaXMuX3JlbmRlcmVkUmFuZ2UkLmFzT2JzZXJ2YWJsZSgpO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgX3JlbmRlcmVkUmFuZ2U6IExpc3RSYW5nZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCB9O1xuICAvLyByYW5nZSBvZiBpdGVtcyB3aGVyZSBzaXplIGlzIGtub3duIGFuZCBkb2Vzbid0IG5lZWQgdG8gYmUgcmUtY2FsY3VsYXRlZFxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgcmVuZGVyZWRSYW5nZShyYW5nZTogTGlzdFJhbmdlKSB7XG4gICAgaWYgKFxuICAgICAgdGhpcy5fcmVuZGVyZWRSYW5nZS5zdGFydCAhPT0gcmFuZ2Uuc3RhcnQgfHxcbiAgICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UuZW5kICE9PSByYW5nZS5lbmRcbiAgICApIHtcbiAgICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UgPSByYW5nZTtcbiAgICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UkLm5leHQocmFuZ2UpO1xuICAgIH1cbiAgfVxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgZ2V0IHJlbmRlcmVkUmFuZ2UoKTogTGlzdFJhbmdlIHtcbiAgICByZXR1cm4gdGhpcy5fcmVuZGVyZWRSYW5nZTtcbiAgfVxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX3Njcm9sbGVkSW5kZXgkID0gbmV3IFJlcGxheVN1YmplY3Q8bnVtYmVyPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSBzY3JvbGxlZEluZGV4JCA9IHRoaXMuX3Njcm9sbGVkSW5kZXgkLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gIHByaXZhdGUgX3Njcm9sbGVkSW5kZXggPSAwO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgc2V0IHNjcm9sbGVkSW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuX3Njcm9sbGVkSW5kZXggPSBpbmRleDtcbiAgICB0aGlzLl9zY3JvbGxlZEluZGV4JC5uZXh0KGluZGV4KTtcbiAgfVxuICBwcml2YXRlIGdldCBzY3JvbGxlZEluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLl9zY3JvbGxlZEluZGV4O1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBnZXQgY29udGVudExlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl92aXJ0dWFsSXRlbXMubGVuZ3RoO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBjb250YWluZXJTaXplID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF92aXJ0dWFsSXRlbXM6IFZpcnR1YWxWaWV3SXRlbVtdID0gW107XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzY3JvbGxUb3AgPSAwO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgc2Nyb2xsVG9wV2l0aE91dE9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzY3JvbGxUb3BBZnRlck9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB2aWV3cG9ydE9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBkaXJlY3Rpb246ICd1cCcgfCAnZG93bicgPSAnZG93bic7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBhbmNob3JTY3JvbGxUb3AgPSAwO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgYW5jaG9ySXRlbSA9IHtcbiAgICBpbmRleDogMCxcbiAgICBvZmZzZXQ6IDAsXG4gIH07XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBsYXN0U2NyZWVuSXRlbSA9IHtcbiAgICBpbmRleDogMCxcbiAgICBvZmZzZXQ6IDAsXG4gIH07XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGRldGFjaGVkJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSByZWNhbGN1bGF0ZVJhbmdlJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB1bnRpbCQ8QT4oKTogTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uPEE+IHtcbiAgICByZXR1cm4gKG8kKSA9PiBvJC5waXBlKHRha2VVbnRpbCh0aGlzLmRldGFjaGVkJCkpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKFxuICAgICAgKGNoYW5nZXNbJ3J1bndheUl0ZW1zT3Bwb3NpdGUnXSAmJlxuICAgICAgICAhY2hhbmdlc1sncnVud2F5SXRlbXNPcHBvc2l0ZSddLmZpcnN0Q2hhbmdlKSB8fFxuICAgICAgKGNoYW5nZXNbJ3J1bndheUl0ZW1zJ10gJiYgIWNoYW5nZXNbJ3J1bndheUl0ZW1zJ10uZmlyc3RDaGFuZ2UpXG4gICAgKSB7XG4gICAgICB0aGlzLnJlY2FsY3VsYXRlUmFuZ2UkLm5leHQoKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGV0YWNoKCk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIGF0dGFjaChcbiAgICB2aWV3cG9ydDogUnhWaXJ0dWFsU2Nyb2xsVmlld3BvcnQsXG4gICAgdmlld1JlcGVhdGVyOiBSeFZpcnR1YWxWaWV3UmVwZWF0ZXI8VCwgVT4sXG4gICk6IHZvaWQge1xuICAgIHRoaXMudmlld3BvcnQgPSB2aWV3cG9ydDtcbiAgICB0aGlzLnZpZXdSZXBlYXRlciA9IHZpZXdSZXBlYXRlcjtcbiAgICB0aGlzLm1haW50YWluVmlydHVhbEl0ZW1zKCk7XG4gICAgdGhpcy5jYWxjUmVuZGVyZWRSYW5nZSgpO1xuICAgIHRoaXMucG9zaXRpb25FbGVtZW50cygpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBkZXRhY2goKTogdm9pZCB7XG4gICAgdGhpcy52aWV3cG9ydCA9IG51bGw7XG4gICAgdGhpcy52aWV3UmVwZWF0ZXIgPSBudWxsO1xuICAgIHRoaXMuX3ZpcnR1YWxJdGVtcyA9IFtdO1xuICAgIHRoaXMuZGV0YWNoZWQkLm5leHQoKTtcbiAgfVxuXG4gIHNjcm9sbFRvSW5kZXgoaW5kZXg6IG51bWJlciwgYmVoYXZpb3I/OiBTY3JvbGxCZWhhdmlvcik6IHZvaWQge1xuICAgIGNvbnN0IF9pbmRleCA9IE1hdGgubWluKE1hdGgubWF4KGluZGV4LCAwKSwgdGhpcy5jb250ZW50TGVuZ3RoIC0gMSk7XG4gICAgbGV0IHNjcm9sbFRvID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IF9pbmRleDsgaSsrKSB7XG4gICAgICBzY3JvbGxUbyArPSB0aGlzLl92aXJ0dWFsSXRlbXNbaV0uc2l6ZTtcbiAgICB9XG4gICAgdGhpcy53YWl0Rm9yU2Nyb2xsID1cbiAgICAgIHNjcm9sbFRvICE9PSB0aGlzLnNjcm9sbFRvcCAmJiB0aGlzLmNvbnRlbnRTaXplID4gdGhpcy5jb250YWluZXJTaXplO1xuICAgIGlmICh0aGlzLndhaXRGb3JTY3JvbGwpIHtcbiAgICAgIHRoaXMuaXNTdGFibGUkLm5leHQoZmFsc2UpO1xuICAgIH1cbiAgICB0aGlzLnZpZXdwb3J0IS5zY3JvbGxUbyh0aGlzLnZpZXdwb3J0T2Zmc2V0ICsgc2Nyb2xsVG8sIGJlaGF2aW9yKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBtYWludGFpblZpcnR1YWxJdGVtcygpOiB2b2lkIHtcbiAgICBjb25zdCB2YWx1ZUFycmF5JCA9IHRoaXMudmlld1JlcGVhdGVyIS52YWx1ZXMkLnBpcGUoXG4gICAgICBtYXAoKHZhbHVlcykgPT5cbiAgICAgICAgQXJyYXkuaXNBcnJheSh2YWx1ZXMpXG4gICAgICAgICAgPyB2YWx1ZXNcbiAgICAgICAgICA6IHZhbHVlcyAhPSBudWxsXG4gICAgICAgICAgICA/IEFycmF5LmZyb20odmFsdWVzKVxuICAgICAgICAgICAgOiBbXSxcbiAgICAgICksXG4gICAgICBzaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiB0cnVlIH0pLFxuICAgICk7XG5cbiAgICB2YWx1ZUFycmF5JC5waXBlKHRoaXMudW50aWwkKCkpLnN1YnNjcmliZSgoZGF0YUFycikgPT4ge1xuICAgICAgaWYgKCFkYXRhQXJyLmxlbmd0aCkge1xuICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXMgPSBbXTtcbiAgICAgICAgdGhpcy5jb250ZW50U2l6ZSA9IDA7XG4gICAgICAgIHRoaXMucmVjYWxjdWxhdGVSYW5nZSQubmV4dCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHNob3VsZFJlY2FsY3VsYXRlUmFuZ2UgPSBmYWxzZTtcbiAgICAgICAgbGV0IGNvbnRlbnRTaXplID0gMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhQXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY29uc3Qgb2xkU2l6ZSA9IHRoaXMuX3ZpcnR1YWxJdGVtc1tpXT8uc2l6ZTtcbiAgICAgICAgICBjb25zdCBuZXdTaXplID0gdGhpcy5pdGVtU2l6ZShkYXRhQXJyW2ldKTtcbiAgICAgICAgICBjb250ZW50U2l6ZSArPSBuZXdTaXplO1xuICAgICAgICAgIGlmIChvbGRTaXplID09PSB1bmRlZmluZWQgfHwgb2xkU2l6ZSAhPT0gbmV3U2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zW2ldID0geyBzaXplOiBuZXdTaXplIH07XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICFzaG91bGRSZWNhbGN1bGF0ZVJhbmdlICYmXG4gICAgICAgICAgICAgICghdGhpcy5jb250ZW50U2l6ZSB8fFxuICAgICAgICAgICAgICAgIChpID49IHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydCAmJiBpIDwgdGhpcy5yZW5kZXJlZFJhbmdlLmVuZCkpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgc2hvdWxkUmVjYWxjdWxhdGVSYW5nZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29udGVudFNpemUgPSBjb250ZW50U2l6ZTtcbiAgICAgICAgaWYgKHNob3VsZFJlY2FsY3VsYXRlUmFuZ2UpIHtcbiAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlUmFuZ2UkLm5leHQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IHZhbHVlQ2FjaGU6IFJlY29yZDxhbnksIFQ+ID0ge307XG4gICAgLypcbiAgICAgKiB3aGVuIGtlZXBTY3JvbGxlZEluZGV4T25QcmVwZW5kIGlzIGFjdGl2ZSwgd2UgbmVlZCB0byBsaXN0ZW4gdG8gZGF0YSBjaGFuZ2VzIGFuZCBmaWd1cmUgb3V0IHdoYXQgd2FzIGFwcGVuZGVkXG4gICAgICogYmVmb3JlIHRoZSBsYXN0IHNjcm9sbGVkVG9JdGVtXG4gICAgICovXG4gICAgdmFsdWVBcnJheSRcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyBUT0RPOiB0aGlzIG1pZ2h0IGNhdXNlIGlzc3VlcyB3aGVuIHR1cm5pbmcgb24vb2ZmIGF0IHJ1bnRpbWVcbiAgICAgICAgZmlsdGVyKCgpID0+IHRoaXMua2VlcFNjcm9sbGVkSW5kZXhPblByZXBlbmQpLFxuICAgICAgICB0aGlzLnVudGlsJCgpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgodmFsdWVBcnJheSkgPT4ge1xuICAgICAgICBjb25zdCB0cmFja0J5ID0gdGhpcy52aWV3UmVwZWF0ZXIhLl90cmFja0J5O1xuICAgICAgICBsZXQgc2Nyb2xsVG8gPSB0aGlzLnNjcm9sbGVkSW5kZXg7XG4gICAgICAgIGNvbnN0IGRhdGFMZW5ndGggPSB2YWx1ZUFycmF5Lmxlbmd0aDtcbiAgICAgICAgY29uc3Qgb2xkRGF0YUxlbmd0aCA9IE9iamVjdC5rZXlzKHZhbHVlQ2FjaGUpLmxlbmd0aDtcblxuICAgICAgICBpZiAob2xkRGF0YUxlbmd0aCA+IDApIHtcbiAgICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgICAgLy8gY2hlY2sgZm9yIGVhY2ggaXRlbSBmcm9tIHRoZSBsYXN0IGtub3duIHNjcm9sbGVkSW5kZXggaWYgaXQncyBhbiBpbnNlcnRcbiAgICAgICAgICBmb3IgKGk7IGkgPD0gc2Nyb2xsVG8gJiYgaSA8IGRhdGFMZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgLy8gaXRlbSBpcyBub3QgaW4gdGhlIHZhbHVlQ2FjaGUsIHNvIGl0IHdhcyBhZGRlZFxuICAgICAgICAgICAgaWYgKCF2YWx1ZUNhY2hlW3RyYWNrQnkoaSwgdmFsdWVBcnJheVtpXSldKSB7XG4gICAgICAgICAgICAgIHNjcm9sbFRvKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhbHVlQ2FjaGUgPSB7fTtcbiAgICAgICAgdmFsdWVBcnJheS5mb3JFYWNoKCh2LCBpKSA9PiAodmFsdWVDYWNoZVt0cmFja0J5KGksIHYpXSA9IHYpKTtcbiAgICAgICAgaWYgKHNjcm9sbFRvICE9PSB0aGlzLnNjcm9sbGVkSW5kZXgpIHtcbiAgICAgICAgICB0aGlzLnNjcm9sbFRvSW5kZXgoc2Nyb2xsVG8pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBjYWxjUmVuZGVyZWRSYW5nZSgpOiB2b2lkIHtcbiAgICBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudmlld3BvcnQhLmNvbnRhaW5lclJlY3QkLnBpcGUoXG4gICAgICAgIG1hcCgoeyBoZWlnaHQgfSkgPT4ge1xuICAgICAgICAgIHRoaXMuY29udGFpbmVyU2l6ZSA9IGhlaWdodDtcbiAgICAgICAgICByZXR1cm4gaGVpZ2h0O1xuICAgICAgICB9KSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICksXG4gICAgICB0aGlzLnZpZXdwb3J0IS5lbGVtZW50U2Nyb2xsZWQkLnBpcGUoXG4gICAgICAgIHN0YXJ0V2l0aCh2b2lkIDApLFxuICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgIHRoaXMudmlld3BvcnRPZmZzZXQgPSB0aGlzLnZpZXdwb3J0IS5tZWFzdXJlT2Zmc2V0KCk7XG4gICAgICAgICAgY29uc3QgeyBzY3JvbGxUb3AsIHNjcm9sbFRvcFdpdGhPdXRPZmZzZXQsIHNjcm9sbFRvcEFmdGVyT2Zmc2V0IH0gPVxuICAgICAgICAgICAgcGFyc2VTY3JvbGxUb3BCb3VuZGFyaWVzKFxuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0IS5nZXRTY3JvbGxUb3AoKSxcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydE9mZnNldCxcbiAgICAgICAgICAgICAgdGhpcy5fY29udGVudFNpemUsXG4gICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyU2l6ZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPVxuICAgICAgICAgICAgc2Nyb2xsVG9wV2l0aE91dE9mZnNldCA+IHRoaXMuc2Nyb2xsVG9wV2l0aE91dE9mZnNldFxuICAgICAgICAgICAgICA/ICdkb3duJ1xuICAgICAgICAgICAgICA6ICd1cCc7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3BXaXRoT3V0T2Zmc2V0ID0gc2Nyb2xsVG9wV2l0aE91dE9mZnNldDtcbiAgICAgICAgICB0aGlzLnNjcm9sbFRvcEFmdGVyT2Zmc2V0ID0gc2Nyb2xsVG9wQWZ0ZXJPZmZzZXQ7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7XG4gICAgICAgICAgdGhpcy53YWl0Rm9yU2Nyb2xsID0gZmFsc2U7XG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICAgIHRoaXMuX2NvbnRlbnRTaXplJC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpLFxuICAgICAgdGhpcy5yZWNhbGN1bGF0ZVJhbmdlJC5waXBlKHN0YXJ0V2l0aCh2b2lkIDApKSxcbiAgICBdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0byBub3Qgb3ZlciBjYWxjdWxhdGUgdGhpbmdzIGJ5IGNvYWxlc2NpbmcgYWxsIHRyaWdnZXJzIHRvIHRoZSBuZXh0IG1pY3JvdGFza1xuICAgICAgICBjb2FsZXNjZVdpdGgodW5wYXRjaGVkTWljcm9UYXNrKCkpLFxuICAgICAgICBtYXAoKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJhbmdlID0geyBzdGFydDogMCwgZW5kOiAwIH07XG4gICAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5jb250ZW50TGVuZ3RoO1xuICAgICAgICAgIGNvbnN0IGRlbHRhID0gdGhpcy5zY3JvbGxUb3AgLSB0aGlzLmFuY2hvclNjcm9sbFRvcDtcbiAgICAgICAgICBpZiAodGhpcy5zY3JvbGxUb3AgPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5hbmNob3JJdGVtID0geyBpbmRleDogMCwgb2Zmc2V0OiAwIH07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSA9IHRoaXMuY2FsY3VsYXRlQW5jaG9yZWRJdGVtKFxuICAgICAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0sXG4gICAgICAgICAgICAgIGRlbHRhLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5zY3JvbGxlZEluZGV4ID0gdGhpcy5hbmNob3JJdGVtLmluZGV4O1xuICAgICAgICAgIHRoaXMuYW5jaG9yU2Nyb2xsVG9wID0gdGhpcy5zY3JvbGxUb3A7XG4gICAgICAgICAgdGhpcy5sYXN0U2NyZWVuSXRlbSA9IHRoaXMuY2FsY3VsYXRlQW5jaG9yZWRJdGVtKFxuICAgICAgICAgICAgdGhpcy5hbmNob3JJdGVtLFxuICAgICAgICAgICAgY2FsY3VsYXRlVmlzaWJsZUNvbnRhaW5lclNpemUoXG4gICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyU2l6ZSxcbiAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3BXaXRoT3V0T2Zmc2V0LFxuICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcEFmdGVyT2Zmc2V0LFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGlmICh0aGlzLmRpcmVjdGlvbiA9PT0gJ3VwJykge1xuICAgICAgICAgICAgcmFuZ2Uuc3RhcnQgPSBNYXRoLm1heCgwLCB0aGlzLmFuY2hvckl0ZW0uaW5kZXggLSB0aGlzLnJ1bndheUl0ZW1zKTtcbiAgICAgICAgICAgIHJhbmdlLmVuZCA9IE1hdGgubWluKFxuICAgICAgICAgICAgICBsZW5ndGgsXG4gICAgICAgICAgICAgIHRoaXMubGFzdFNjcmVlbkl0ZW0uaW5kZXggKyB0aGlzLnJ1bndheUl0ZW1zT3Bwb3NpdGUsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByYW5nZS5zdGFydCA9IE1hdGgubWF4KFxuICAgICAgICAgICAgICAwLFxuICAgICAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0uaW5kZXggLSB0aGlzLnJ1bndheUl0ZW1zT3Bwb3NpdGUsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmFuZ2UuZW5kID0gTWF0aC5taW4oXG4gICAgICAgICAgICAgIGxlbmd0aCxcbiAgICAgICAgICAgICAgdGhpcy5sYXN0U2NyZWVuSXRlbS5pbmRleCArIHRoaXMucnVud2F5SXRlbXMsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodGhpcy5hcHBlbmRPbmx5KSB7XG4gICAgICAgICAgICByYW5nZS5zdGFydCA9IE1hdGgubWluKHRoaXMuX3JlbmRlcmVkUmFuZ2Uuc3RhcnQsIHJhbmdlLnN0YXJ0KTtcbiAgICAgICAgICAgIHJhbmdlLmVuZCA9IE1hdGgubWF4KHRoaXMuX3JlbmRlcmVkUmFuZ2UuZW5kLCByYW5nZS5lbmQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmFuZ2U7XG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLnBpcGUodGhpcy51bnRpbCQoKSlcbiAgICAgIC5zdWJzY3JpYmUoKHJhbmdlOiBMaXN0UmFuZ2UpID0+IHtcbiAgICAgICAgdGhpcy5yZW5kZXJlZFJhbmdlID0gcmFuZ2U7XG4gICAgICAgIHRoaXMuaXNTdGFibGUkLm5leHQoIXRoaXMud2FpdEZvclNjcm9sbCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBwb3NpdGlvbkVsZW1lbnRzKCk6IHZvaWQge1xuICAgIHRoaXMudmlld1JlcGVhdGVyIS5yZW5kZXJpbmdTdGFydCQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoYmF0Y2hlZFVwZGF0ZXMpID0+IHtcbiAgICAgICAgY29uc3QgcmVuZGVyZWRSYW5nZSA9IHRoaXMucmVuZGVyZWRSYW5nZTtcbiAgICAgICAgY29uc3QgYWRqdXN0SW5kZXhXaXRoID0gcmVuZGVyZWRSYW5nZS5zdGFydDtcbiAgICAgICAgY29uc3QgaW5pdGlhbEluZGV4ID0gYmF0Y2hlZFVwZGF0ZXMuc2l6ZVxuICAgICAgICAgID8gYmF0Y2hlZFVwZGF0ZXMudmFsdWVzKCkubmV4dCgpLnZhbHVlICsgdGhpcy5yZW5kZXJlZFJhbmdlLnN0YXJ0XG4gICAgICAgICAgOiB0aGlzLnJlbmRlcmVkUmFuZ2Uuc3RhcnQ7XG4gICAgICAgIGxldCBwb3NpdGlvbiA9IHRoaXMuY2FsY0luaXRpYWxQb3NpdGlvbihpbml0aWFsSW5kZXgpO1xuICAgICAgICByZXR1cm4gdGhpcy52aWV3UmVwZWF0ZXIhLnZpZXdSZW5kZXJlZCQucGlwZShcbiAgICAgICAgICB0YXAoKHsgdmlldywgaW5kZXg6IHZpZXdJbmRleCwgaXRlbSB9KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHZpZXdJbmRleCArIGFkanVzdEluZGV4V2l0aDtcbiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGluZGV4KTtcbiAgICAgICAgICAgIHRoaXMucG9zaXRpb25FbGVtZW50KHRoaXMuZ2V0RWxlbWVudCh2aWV3KSwgcG9zaXRpb24pO1xuICAgICAgICAgICAgcG9zaXRpb24gKz0gc2l6ZTtcbiAgICAgICAgICAgIHRoaXMudmlld1JlbmRlckNhbGxiYWNrLm5leHQoe1xuICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgdmlldyxcbiAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSksXG4gICAgICB0aGlzLnVudGlsJCgpLFxuICAgICkuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogQGludGVybmFsXG4gICAqIGhlYXZpbHkgaW5zcGlyZWQgYnlcbiAgICogICBodHRwczovL2dpdGh1Yi5jb20vR29vZ2xlQ2hyb21lTGFicy91aS1lbGVtZW50LXNhbXBsZXMvYmxvYi9naC1wYWdlcy9pbmZpbml0ZS1zY3JvbGxlci9zY3JpcHRzL2luZmluaXRlLXNjcm9sbC5qc1xuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVBbmNob3JlZEl0ZW0oXG4gICAgaW5pdGlhbEFuY2hvcjogQW5jaG9ySXRlbSxcbiAgICBkZWx0YTogbnVtYmVyLFxuICApOiBBbmNob3JJdGVtIHtcbiAgICBpZiAoZGVsdGEgPT0gMCkgcmV0dXJuIGluaXRpYWxBbmNob3I7XG4gICAgZGVsdGEgKz0gaW5pdGlhbEFuY2hvci5vZmZzZXQ7XG4gICAgbGV0IGkgPSBpbml0aWFsQW5jaG9yLmluZGV4O1xuICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5fdmlydHVhbEl0ZW1zO1xuICAgIGlmIChkZWx0YSA8IDApIHtcbiAgICAgIHdoaWxlIChkZWx0YSA8IDAgJiYgaSA+IDApIHtcbiAgICAgICAgZGVsdGEgKz0gaXRlbXNbaSAtIDFdLnNpemU7XG4gICAgICAgIGktLTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgd2hpbGUgKGRlbHRhID4gMCAmJiBpIDwgaXRlbXMubGVuZ3RoICYmIGl0ZW1zW2ldLnNpemUgPD0gZGVsdGEpIHtcbiAgICAgICAgZGVsdGEgLT0gaXRlbXNbaV0uc2l6ZTtcbiAgICAgICAgaSsrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgaW5kZXg6IE1hdGgubWluKGksIGl0ZW1zLmxlbmd0aCksXG4gICAgICBvZmZzZXQ6IGRlbHRhLFxuICAgIH07XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgY2FsY0luaXRpYWxQb3NpdGlvbihzdGFydDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gb2Ygc3RhcnRpbmcgbm9kZVxuICAgIGxldCBwb3MgPSB0aGlzLmFuY2hvclNjcm9sbFRvcCAtIHRoaXMuYW5jaG9ySXRlbS5vZmZzZXQ7XG4gICAgbGV0IGkgPSB0aGlzLmFuY2hvckl0ZW0uaW5kZXg7XG4gICAgd2hpbGUgKGkgPiBzdGFydCkge1xuICAgICAgY29uc3QgaXRlbVNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGkgLSAxKTtcbiAgICAgIHBvcyAtPSBpdGVtU2l6ZTtcbiAgICAgIGktLTtcbiAgICB9XG4gICAgd2hpbGUgKGkgPCBzdGFydCkge1xuICAgICAgY29uc3QgaXRlbVNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGkpO1xuICAgICAgcG9zICs9IGl0ZW1TaXplO1xuICAgICAgaSsrO1xuICAgIH1cbiAgICByZXR1cm4gcG9zO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBnZXRJdGVtU2l6ZShpbmRleDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XS5zaXplO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHBvc2l0aW9uRWxlbWVudChlbGVtZW50OiBIVE1MRWxlbWVudCwgc2Nyb2xsVG9wOiBudW1iZXIpOiB2b2lkIHtcbiAgICBlbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcbiAgICBlbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKCR7c2Nyb2xsVG9wfXB4KWA7XG4gIH1cbn1cbiJdfQ==