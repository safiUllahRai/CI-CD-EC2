import { Directive, ElementRef, Inject, Input, Optional, } from '@angular/core';
import { coerceObservableWith } from '@rx-angular/cdk/coercing';
import { RxStrategyProvider } from '@rx-angular/cdk/render-strategies';
import { RxLet } from '@rx-angular/template/let';
import { BehaviorSubject, combineLatest, Observable, of, Subject } from 'rxjs';
import { filter, map, mergeAll, withLatestFrom } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@rx-angular/cdk/render-strategies";
import * as i2 from "@rx-angular/template/let";
function intersectionObserver(options) {
    const subject = new Subject();
    const observer = observerSupported()
        ? new IntersectionObserver((entries) => {
            entries.forEach((entry) => subject.next(entry));
        }, options)
        : null;
    const entries$ = new Observable((subscriber) => {
        subject.subscribe(subscriber);
        return () => {
            if (observer) {
                observer.disconnect();
            }
        };
    });
    return {
        entries$,
        observe: observer.observe,
        unobserve: observer.unobserve,
    };
}
const observerSupported = () => typeof window !== 'undefined'
    ? !!window.IntersectionObserver
    : false;
export class ViewportPrioDirective {
    el;
    strategyProvider;
    letDirective;
    // Note that we're picking only the `intersectionRatio` property
    // since this is the only property that we're intersted in.
    entriesSubject = new Subject();
    entries$ = this.entriesSubject.pipe(mergeAll());
    _viewportPrioObservables = new BehaviorSubject(of('noop'));
    _viewportPrio = this._viewportPrioObservables.pipe(coerceObservableWith(), mergeAll(), map((v) => (!v ? 'noop' : v)));
    set viewportPrio(prio) {
        this._viewportPrioObservables.next(prio);
    }
    observer = observerSupported()
        ? new IntersectionObserver((entries) => {
            this.entriesSubject.next(entries);
        }, {
            threshold: 0,
        })
        : null;
    visibilityEvents$ = this.entries$.pipe(map((entry) => {
        if (entry.intersectionRatio > 0) {
            return 'visible';
        }
        else {
            return 'invisible';
        }
    }));
    constructor(el, strategyProvider, letDirective) {
        this.el = el;
        this.strategyProvider = strategyProvider;
        this.letDirective = letDirective;
    }
    ngOnInit() {
        const letStrategyName$ = this.strategyProvider.primaryStrategy$.pipe(map(({ name }) => name));
        let lastValue = undefined;
        // @TODO add a connect here to get rid of the subscribe
        this.letDirective.values$
            .pipe(filter((n) => n.kind === 'next'))
            .subscribe((v) => {
            lastValue = v;
        });
        this.visibilityEvents$
            .pipe(withLatestFrom(combineLatest(letStrategyName$, this._viewportPrio).pipe(filter(([newN, oldN]) => newN !== oldN))), map(([visibility, strategyNames]) => {
            const [inStrategyName, outStrategyName] = strategyNames;
            return visibility === 'visible'
                ? [visibility, inStrategyName]
                : [visibility, outStrategyName];
        }))
            .subscribe(([visibility, strategyName]) => {
            if (this.letDirective !== null) {
                this.letDirective.strategy = strategyName;
            }
            if (visibility === 'visible') {
                // render actual state on viewport enter
                //  this.letDirective.templateNotification$.next(lastValue);
            }
        });
        // If the browser doesn't support the `IntersectionObserver` or we're inside
        // the Node.js environment, then this will throw an exception that property
        // `observe` doesn't exist on `null`.
        if (this.observer !== null) {
            this.observer.observe(this.el.nativeElement);
        }
        else {
            // If we're inside the Node.js environment then this should be
            // rendered (e.g. for SEO purposes), and when running this code in browser
            // it will decide itself to render it or not.
            this.entriesSubject.next([{ intersectionRatio: 1 }]);
        }
    }
    ngOnDestroy() {
        if (this.observer) {
            this.observer.disconnect();
        }
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: ViewportPrioDirective, deps: [{ token: i0.ElementRef }, { token: i1.RxStrategyProvider }, { token: RxLet, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
    /** @nocollapse */ static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "18.0.1", type: ViewportPrioDirective, isStandalone: true, selector: "[viewport-prio]", inputs: { viewportPrio: ["viewport-prio", "viewportPrio"] }, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: ViewportPrioDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[viewport-prio]',
                    standalone: true,
                }]
        }], ctorParameters: () => [{ type: i0.ElementRef }, { type: i1.RxStrategyProvider }, { type: i2.RxLet, decorators: [{
                    type: Inject,
                    args: [RxLet]
                }, {
                    type: Optional
                }] }], propDecorators: { viewportPrio: [{
                type: Input,
                args: ['viewport-prio']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQtcHJpby5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3RlbXBsYXRlL2V4cGVyaW1lbnRhbC92aWV3cG9ydC1wcmlvL3NyYy9saWIvdmlld3BvcnQtcHJpby5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsTUFBTSxFQUNOLEtBQUssRUFHTCxRQUFRLEdBQ1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDdkUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUV2RSxTQUFTLG9CQUFvQixDQUFDLE9BQWdCO0lBSzVDLE1BQU0sT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDOUIsTUFBTSxRQUFRLEdBQUcsaUJBQWlCLEVBQUU7UUFDbEMsQ0FBQyxDQUFDLElBQUksb0JBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNuQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbEQsQ0FBQyxFQUFFLE9BQU8sQ0FBQztRQUNiLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFFVCxNQUFNLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FB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RSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQy9DLENBQUM7YUFBTSxDQUFDO1lBQ04sOERBQThEO1lBQzlELDBFQUEwRTtZQUMxRSw2Q0FBNkM7WUFDN0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2RCxDQUFDO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzdCLENBQUM7SUFDSCxDQUFDOzBIQTNHVSxxQkFBcUIsOEVBK0N0QixLQUFLOzhHQS9DSixxQkFBcUI7OzJGQUFyQixxQkFBcUI7a0JBSmpDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGlCQUFpQjtvQkFDM0IsVUFBVSxFQUFFLElBQUk7aUJBQ2pCOzswQkFnREksTUFBTTsyQkFBQyxLQUFLOzswQkFDWixRQUFRO3lDQTdCUCxZQUFZO3NCQURmLEtBQUs7dUJBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvZXJjZU9ic2VydmFibGVXaXRoIH0gZnJvbSAnQHJ4LWFuZ3VsYXIvY2RrL2NvZXJjaW5nJztcbmltcG9ydCB7IFJ4Tm90aWZpY2F0aW9uIH0gZnJvbSAnQHJ4LWFuZ3VsYXIvY2RrL25vdGlmaWNhdGlvbnMnO1xuaW1wb3J0IHsgUnhTdHJhdGVneVByb3ZpZGVyIH0gZnJvbSAnQHJ4LWFuZ3VsYXIvY2RrL3JlbmRlci1zdHJhdGVnaWVzJztcbmltcG9ydCB7IFJ4TGV0IH0gZnJvbSAnQHJ4LWFuZ3VsYXIvdGVtcGxhdGUvbGV0JztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtZXJnZUFsbCwgd2l0aExhdGVzdEZyb20gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmZ1bmN0aW9uIGludGVyc2VjdGlvbk9ic2VydmVyKG9wdGlvbnM/OiBvYmplY3QpOiB7XG4gIG9ic2VydmU6ICh0YXJnZXQ6IEVsZW1lbnQpID0+IHZvaWQ7XG4gIHVub2JzZXJ2ZTogKHRhcmdldDogRWxlbWVudCkgPT4gdm9pZDtcbiAgZW50cmllcyQ6IE9ic2VydmFibGU8YW55Pjtcbn0ge1xuICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcbiAgY29uc3Qgb2JzZXJ2ZXIgPSBvYnNlcnZlclN1cHBvcnRlZCgpXG4gICAgPyBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoKGVudHJpZXMpID0+IHtcbiAgICAgICAgZW50cmllcy5mb3JFYWNoKChlbnRyeSkgPT4gc3ViamVjdC5uZXh0KGVudHJ5KSk7XG4gICAgICB9LCBvcHRpb25zKVxuICAgIDogbnVsbDtcblxuICBjb25zdCBlbnRyaWVzJCA9IG5ldyBPYnNlcnZhYmxlKChzdWJzY3JpYmVyKSA9PiB7XG4gICAgc3ViamVjdC5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChvYnNlcnZlcikge1xuICAgICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICB9XG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBlbnRyaWVzJCxcbiAgICBvYnNlcnZlOiBvYnNlcnZlci5vYnNlcnZlLFxuICAgIHVub2JzZXJ2ZTogb2JzZXJ2ZXIudW5vYnNlcnZlLFxuICB9O1xufVxuXG5jb25zdCBvYnNlcnZlclN1cHBvcnRlZCA9ICgpID0+XG4gIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnXG4gICAgPyAhISh3aW5kb3cgYXMgYW55KS5JbnRlcnNlY3Rpb25PYnNlcnZlclxuICAgIDogZmFsc2U7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1t2aWV3cG9ydC1wcmlvXScsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG59KVxuZXhwb3J0IGNsYXNzIFZpZXdwb3J0UHJpb0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgLy8gTm90ZSB0aGF0IHdlJ3JlIHBpY2tpbmcgb25seSB0aGUgYGludGVyc2VjdGlvblJhdGlvYCBwcm9wZXJ0eVxuICAvLyBzaW5jZSB0aGlzIGlzIHRoZSBvbmx5IHByb3BlcnR5IHRoYXQgd2UncmUgaW50ZXJzdGVkIGluLlxuICBlbnRyaWVzU3ViamVjdCA9IG5ldyBTdWJqZWN0PFxuICAgIFBpY2s8SW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeSwgJ2ludGVyc2VjdGlvblJhdGlvJz5bXVxuICA+KCk7XG5cbiAgZW50cmllcyQ6IE9ic2VydmFibGU8UGljazxJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5LCAnaW50ZXJzZWN0aW9uUmF0aW8nPj4gPVxuICAgIHRoaXMuZW50cmllc1N1YmplY3QucGlwZShtZXJnZUFsbCgpKTtcblxuICBfdmlld3BvcnRQcmlvT2JzZXJ2YWJsZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE9ic2VydmFibGU8c3RyaW5nPiB8IHN0cmluZz4oXG4gICAgb2YoJ25vb3AnKVxuICApO1xuICBfdmlld3BvcnRQcmlvID0gdGhpcy5fdmlld3BvcnRQcmlvT2JzZXJ2YWJsZXMucGlwZShcbiAgICBjb2VyY2VPYnNlcnZhYmxlV2l0aCgpLFxuICAgIG1lcmdlQWxsKCksXG4gICAgbWFwKCh2KSA9PiAoIXYgPyAnbm9vcCcgOiB2KSlcbiAgKTtcbiAgQElucHV0KCd2aWV3cG9ydC1wcmlvJylcbiAgc2V0IHZpZXdwb3J0UHJpbyhwcmlvOiBzdHJpbmcgfCBPYnNlcnZhYmxlPHN0cmluZz4pIHtcbiAgICB0aGlzLl92aWV3cG9ydFByaW9PYnNlcnZhYmxlcy5uZXh0KHByaW8pO1xuICB9XG5cbiAgcHJpdmF0ZSBvYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXIgfCBudWxsID0gb2JzZXJ2ZXJTdXBwb3J0ZWQoKVxuICAgID8gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKFxuICAgICAgICAoZW50cmllcykgPT4ge1xuICAgICAgICAgIHRoaXMuZW50cmllc1N1YmplY3QubmV4dChlbnRyaWVzKTtcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHRocmVzaG9sZDogMCxcbiAgICAgICAgfVxuICAgICAgKVxuICAgIDogbnVsbDtcblxuICB2aXNpYmlsaXR5RXZlbnRzJCA9IHRoaXMuZW50cmllcyQucGlwZShcbiAgICBtYXAoKGVudHJ5KSA9PiB7XG4gICAgICBpZiAoZW50cnkuaW50ZXJzZWN0aW9uUmF0aW8gPiAwKSB7XG4gICAgICAgIHJldHVybiAndmlzaWJsZSc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gJ2ludmlzaWJsZSc7XG4gICAgICB9XG4gICAgfSlcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVsOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PixcbiAgICBwcml2YXRlIHN0cmF0ZWd5UHJvdmlkZXI6IFJ4U3RyYXRlZ3lQcm92aWRlcixcbiAgICBASW5qZWN0KFJ4TGV0KVxuICAgIEBPcHRpb25hbCgpXG4gICAgcHJpdmF0ZSBsZXREaXJlY3RpdmU6IFJ4TGV0PGFueT4gfCBudWxsXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBjb25zdCBsZXRTdHJhdGVneU5hbWUkID0gdGhpcy5zdHJhdGVneVByb3ZpZGVyLnByaW1hcnlTdHJhdGVneSQucGlwZShcbiAgICAgIG1hcCgoeyBuYW1lIH0pID0+IG5hbWUpXG4gICAgKTtcblxuICAgIGxldCBsYXN0VmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgLy8gQFRPRE8gYWRkIGEgY29ubmVjdCBoZXJlIHRvIGdldCByaWQgb2YgdGhlIHN1YnNjcmliZVxuICAgIHRoaXMubGV0RGlyZWN0aXZlLnZhbHVlcyRcbiAgICAgIC5waXBlKGZpbHRlcigobjogUnhOb3RpZmljYXRpb248YW55PikgPT4gbi5raW5kID09PSAnbmV4dCcpKVxuICAgICAgLnN1YnNjcmliZSgodikgPT4ge1xuICAgICAgICBsYXN0VmFsdWUgPSB2O1xuICAgICAgfSk7XG5cbiAgICB0aGlzLnZpc2liaWxpdHlFdmVudHMkXG4gICAgICAucGlwZShcbiAgICAgICAgd2l0aExhdGVzdEZyb20oXG4gICAgICAgICAgY29tYmluZUxhdGVzdChsZXRTdHJhdGVneU5hbWUkLCB0aGlzLl92aWV3cG9ydFByaW8pLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKFtuZXdOLCBvbGROXSkgPT4gbmV3TiAhPT0gb2xkTilcbiAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICAgIG1hcCgoW3Zpc2liaWxpdHksIHN0cmF0ZWd5TmFtZXNdKSA9PiB7XG4gICAgICAgICAgY29uc3QgW2luU3RyYXRlZ3lOYW1lLCBvdXRTdHJhdGVneU5hbWVdID0gc3RyYXRlZ3lOYW1lcztcbiAgICAgICAgICByZXR1cm4gdmlzaWJpbGl0eSA9PT0gJ3Zpc2libGUnXG4gICAgICAgICAgICA/IFt2aXNpYmlsaXR5LCBpblN0cmF0ZWd5TmFtZV1cbiAgICAgICAgICAgIDogW3Zpc2liaWxpdHksIG91dFN0cmF0ZWd5TmFtZV07XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChbdmlzaWJpbGl0eSwgc3RyYXRlZ3lOYW1lXSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5sZXREaXJlY3RpdmUgIT09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLmxldERpcmVjdGl2ZS5zdHJhdGVneSA9IHN0cmF0ZWd5TmFtZSBhcyBzdHJpbmc7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmlzaWJpbGl0eSA9PT0gJ3Zpc2libGUnKSB7XG4gICAgICAgICAgLy8gcmVuZGVyIGFjdHVhbCBzdGF0ZSBvbiB2aWV3cG9ydCBlbnRlclxuICAgICAgICAgIC8vICB0aGlzLmxldERpcmVjdGl2ZS50ZW1wbGF0ZU5vdGlmaWNhdGlvbiQubmV4dChsYXN0VmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB0aGUgYEludGVyc2VjdGlvbk9ic2VydmVyYCBvciB3ZSdyZSBpbnNpZGVcbiAgICAvLyB0aGUgTm9kZS5qcyBlbnZpcm9ubWVudCwgdGhlbiB0aGlzIHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uIHRoYXQgcHJvcGVydHlcbiAgICAvLyBgb2JzZXJ2ZWAgZG9lc24ndCBleGlzdCBvbiBgbnVsbGAuXG4gICAgaWYgKHRoaXMub2JzZXJ2ZXIgIT09IG51bGwpIHtcbiAgICAgIHRoaXMub2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJZiB3ZSdyZSBpbnNpZGUgdGhlIE5vZGUuanMgZW52aXJvbm1lbnQgdGhlbiB0aGlzIHNob3VsZCBiZVxuICAgICAgLy8gcmVuZGVyZWQgKGUuZy4gZm9yIFNFTyBwdXJwb3NlcyksIGFuZCB3aGVuIHJ1bm5pbmcgdGhpcyBjb2RlIGluIGJyb3dzZXJcbiAgICAgIC8vIGl0IHdpbGwgZGVjaWRlIGl0c2VsZiB0byByZW5kZXIgaXQgb3Igbm90LlxuICAgICAgdGhpcy5lbnRyaWVzU3ViamVjdC5uZXh0KFt7IGludGVyc2VjdGlvblJhdGlvOiAxIH1dKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vYnNlcnZlcikge1xuICAgICAgdGhpcy5vYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgfVxuICB9XG59XG4iXX0=