import { createEmbeddedView } from './utils';
/**
 * @internal
 *
 * Factory that returns a `ListTemplateManager` for the passed params.
 *
 * @param templateSettings
 */
export function getTemplateHandler(templateSettings) {
    const { viewContainerRef, initialTemplateRef, createViewContext, updateViewContext, } = templateSettings;
    return {
        updateUnchangedContext,
        insertView,
        moveView,
        removeView,
        getListChanges,
        updateView,
    };
    // =====
    function updateUnchangedContext(item, index, count) {
        const view = viewContainerRef.get(index);
        updateViewContext(item, view, {
            count,
            index,
        });
        view.detectChanges();
    }
    function moveView(oldIndex, item, index, count) {
        const oldView = viewContainerRef.get(oldIndex);
        const view = viewContainerRef.move(oldView, index);
        updateViewContext(item, view, {
            count,
            index,
        });
        view.detectChanges();
    }
    function updateView(item, index, count) {
        const view = viewContainerRef.get(index);
        updateViewContext(item, view, {
            count,
            index,
        });
        view.detectChanges();
    }
    function removeView(index) {
        return viewContainerRef.remove(index);
    }
    function insertView(item, index, count) {
        createEmbeddedView(viewContainerRef, initialTemplateRef, createViewContext(item, {
            count,
            index,
        }), index);
    }
}
/**
 * @internal
 *
 * @param changes
 * @param items
 */
function getListChanges(changes, items) {
    const changedIdxs = new Set();
    const changesArr = [];
    let notifyParent = false;
    changes.forEachOperation((record, adjustedPreviousIndex, currentIndex) => {
        const item = record.item;
        if (record.previousIndex == null) {
            // insert
            changesArr.push(getInsertChange(item, currentIndex === null ? undefined : currentIndex));
            changedIdxs.add(item);
            notifyParent = true;
        }
        else if (currentIndex == null) {
            // remove
            changesArr.push(getRemoveChange(item, adjustedPreviousIndex === null ? undefined : adjustedPreviousIndex));
            notifyParent = true;
        }
        else if (adjustedPreviousIndex !== null) {
            // move
            changesArr.push(getMoveChange(item, currentIndex, adjustedPreviousIndex));
            changedIdxs.add(item);
            notifyParent = true;
        }
    });
    changes.forEachIdentityChange((record) => {
        const item = record.item;
        if (!changedIdxs.has(item)) {
            changesArr.push(getUpdateChange(item, record.currentIndex));
            changedIdxs.add(item);
        }
    });
    items.forEach((item, index) => {
        if (!changedIdxs.has(item)) {
            changesArr.push(getUnchangedChange(item, index));
        }
    });
    return [changesArr, notifyParent];
    // ==========
    function getMoveChange(item, currentIndex, adjustedPreviousIndex) {
        return [
            2 /* RxListTemplateChangeType.move */,
            [item, currentIndex, adjustedPreviousIndex],
        ];
    }
    function getUpdateChange(item, currentIndex) {
        return [3 /* RxListTemplateChangeType.update */, [item, currentIndex]];
    }
    function getUnchangedChange(item, index) {
        return [4 /* RxListTemplateChangeType.context */, [item, index]];
    }
    function getInsertChange(item, currentIndex) {
        return [
            0 /* RxListTemplateChangeType.insert */,
            [item, currentIndex === null ? undefined : currentIndex],
        ];
    }
    function getRemoveChange(item, adjustedPreviousIndex) {
        return [
            1 /* RxListTemplateChangeType.remove */,
            [
                item,
                adjustedPreviousIndex === null ? undefined : adjustedPreviousIndex,
            ],
        ];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC12aWV3LWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2Nkay90ZW1wbGF0ZS9zcmMvbGliL2xpc3Qtdmlldy1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUU3Qzs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsa0JBQWtCLENBQ2hDLGdCQUFpRTtJQUVqRSxNQUFNLEVBQ0osZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQixpQkFBaUIsRUFDakIsaUJBQWlCLEdBQ2xCLEdBQUcsZ0JBQWdCLENBQUM7SUFFckIsT0FBTztRQUNMLHNCQUFzQjtRQUN0QixVQUFVO1FBQ1YsUUFBUTtRQUNSLFVBQVU7UUFDVixjQUFjO1FBQ2QsVUFBVTtLQUNYLENBQUM7SUFFRixRQUFRO0lBRVIsU0FBUyxzQkFBc0IsQ0FBQyxJQUFPLEVBQUUsS0FBYSxFQUFFLEtBQWE7UUFDbkUsTUFBTSxJQUFJLEdBQXVCLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3RCxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzVCLEtBQUs7WUFDTCxLQUFLO1NBQ04sQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxTQUFTLFFBQVEsQ0FDZixRQUFnQixFQUNoQixJQUFPLEVBQ1AsS0FBYSxFQUNiLEtBQWE7UUFFYixNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0MsTUFBTSxJQUFJLEdBQXVCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkUsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtZQUM1QixLQUFLO1lBQ0wsS0FBSztTQUNO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b3J0IHsgRW1iZWRkZWRWaWV3UmVmLCBJdGVyYWJsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJ4TGlzdFZpZXdDb250ZXh0IH0gZnJvbSAnLi9saXN0LXZpZXctY29udGV4dCc7XG5pbXBvcnQge1xuICBSeExpc3RUZW1wbGF0ZUNoYW5nZSxcbiAgUnhMaXN0VGVtcGxhdGVDaGFuZ2VzLFxuICBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUsXG4gIFJ4TGlzdFRlbXBsYXRlU2V0dGluZ3MsXG59IGZyb20gJy4vbW9kZWwnO1xuaW1wb3J0IHsgY3JlYXRlRW1iZWRkZWRWaWV3IH0gZnJvbSAnLi91dGlscyc7XG5cbi8qKlxuICogQGludGVybmFsXG4gKlxuICogRmFjdG9yeSB0aGF0IHJldHVybnMgYSBgTGlzdFRlbXBsYXRlTWFuYWdlcmAgZm9yIHRoZSBwYXNzZWQgcGFyYW1zLlxuICpcbiAqIEBwYXJhbSB0ZW1wbGF0ZVNldHRpbmdzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZUhhbmRsZXI8QyBleHRlbmRzIFJ4TGlzdFZpZXdDb250ZXh0PFQ+LCBUPihcbiAgdGVtcGxhdGVTZXR0aW5nczogT21pdDxSeExpc3RUZW1wbGF0ZVNldHRpbmdzPFQsIEM+LCAncGF0Y2hab25lJz5cbik6IExpc3RUZW1wbGF0ZU1hbmFnZXI8VD4ge1xuICBjb25zdCB7XG4gICAgdmlld0NvbnRhaW5lclJlZixcbiAgICBpbml0aWFsVGVtcGxhdGVSZWYsXG4gICAgY3JlYXRlVmlld0NvbnRleHQsXG4gICAgdXBkYXRlVmlld0NvbnRleHQsXG4gIH0gPSB0ZW1wbGF0ZVNldHRpbmdzO1xuXG4gIHJldHVybiB7XG4gICAgdXBkYXRlVW5jaGFuZ2VkQ29udGV4dCxcbiAgICBpbnNlcnRWaWV3LFxuICAgIG1vdmVWaWV3LFxuICAgIHJlbW92ZVZpZXcsXG4gICAgZ2V0TGlzdENoYW5nZXMsXG4gICAgdXBkYXRlVmlldyxcbiAgfTtcblxuICAvLyA9PT09PVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZVVuY2hhbmdlZENvbnRleHQoaXRlbTogVCwgaW5kZXg6IG51bWJlciwgY291bnQ6IG51bWJlcikge1xuICAgIGNvbnN0IHZpZXcgPSA8RW1iZWRkZWRWaWV3UmVmPEM+PnZpZXdDb250YWluZXJSZWYuZ2V0KGluZGV4KTtcbiAgICB1cGRhdGVWaWV3Q29udGV4dChpdGVtLCB2aWV3LCB7XG4gICAgICBjb3VudCxcbiAgICAgIGluZGV4LFxuICAgIH0pO1xuICAgIHZpZXcuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgZnVuY3Rpb24gbW92ZVZpZXcoXG4gICAgb2xkSW5kZXg6IG51bWJlcixcbiAgICBpdGVtOiBULFxuICAgIGluZGV4OiBudW1iZXIsXG4gICAgY291bnQ6IG51bWJlclxuICApOiB2b2lkIHtcbiAgICBjb25zdCBvbGRWaWV3ID0gdmlld0NvbnRhaW5lclJlZi5nZXQob2xkSW5kZXgpO1xuICAgIGNvbnN0IHZpZXcgPSA8RW1iZWRkZWRWaWV3UmVmPEM+PnZpZXdDb250YWluZXJSZWYubW92ZShvbGRWaWV3LCBpbmRleCk7XG4gICAgdXBkYXRlVmlld0NvbnRleHQoaXRlbSwgdmlldywge1xuICAgICAgY291bnQsXG4gICAgICBpbmRleCxcbiAgICB9KTtcbiAgICB2aWV3LmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoaXRlbTogVCwgaW5kZXg6IG51bWJlciwgY291bnQ6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHZpZXcgPSA8RW1iZWRkZWRWaWV3UmVmPEM+PnZpZXdDb250YWluZXJSZWYuZ2V0KGluZGV4KTtcbiAgICB1cGRhdGVWaWV3Q29udGV4dChpdGVtLCB2aWV3LCB7XG4gICAgICBjb3VudCxcbiAgICAgIGluZGV4LFxuICAgIH0pO1xuICAgIHZpZXcuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgZnVuY3Rpb24gcmVtb3ZlVmlldyhpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgcmV0dXJuIHZpZXdDb250YWluZXJSZWYucmVtb3ZlKGluZGV4KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGluc2VydFZpZXcoaXRlbTogVCwgaW5kZXg6IG51bWJlciwgY291bnQ6IG51bWJlcik6IHZvaWQge1xuICAgIGNyZWF0ZUVtYmVkZGVkVmlldyhcbiAgICAgIHZpZXdDb250YWluZXJSZWYsXG4gICAgICBpbml0aWFsVGVtcGxhdGVSZWYsXG4gICAgICBjcmVhdGVWaWV3Q29udGV4dChpdGVtLCB7XG4gICAgICAgIGNvdW50LFxuICAgICAgICBpbmRleCxcbiAgICAgIH0pLFxuICAgICAgaW5kZXhcbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKlxuICogQW4gb2JqZWN0IHRoYXQgaG9sZHMgbWV0aG9kcyBuZWVkZWQgdG8gaW50cm9kdWNlIGFjdGlvbnMgdG8gYSBsaXN0IGUuZy4gbW92ZSwgcmVtb3ZlLCBpbnNlcnRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMaXN0VGVtcGxhdGVNYW5hZ2VyPFQ+IHtcbiAgdXBkYXRlVW5jaGFuZ2VkQ29udGV4dChpdGVtOiBULCBpbmRleDogbnVtYmVyLCBjb3VudDogbnVtYmVyKTogdm9pZDtcblxuICBpbnNlcnRWaWV3KGl0ZW06IFQsIGluZGV4OiBudW1iZXIsIGNvdW50OiBudW1iZXIpOiB2b2lkO1xuXG4gIG1vdmVWaWV3KG9sZEluZGV4OiBudW1iZXIsIGl0ZW06IFQsIGluZGV4OiBudW1iZXIsIGNvdW50OiBudW1iZXIpOiB2b2lkO1xuXG4gIHVwZGF0ZVZpZXcoaXRlbTogVCwgaW5kZXg6IG51bWJlciwgY291bnQ6IG51bWJlcik6IHZvaWQ7XG5cbiAgcmVtb3ZlVmlldyhpbmRleDogbnVtYmVyKTogdm9pZDtcblxuICBnZXRMaXN0Q2hhbmdlcyhcbiAgICBjaGFuZ2VzOiBJdGVyYWJsZUNoYW5nZXM8VD4sXG4gICAgaXRlbXM6IFRbXVxuICApOiBSeExpc3RUZW1wbGF0ZUNoYW5nZXM7XG59XG5cbi8qKlxuICogQGludGVybmFsXG4gKlxuICogQHBhcmFtIGNoYW5nZXNcbiAqIEBwYXJhbSBpdGVtc1xuICovXG5mdW5jdGlvbiBnZXRMaXN0Q2hhbmdlczxUPihcbiAgY2hhbmdlczogSXRlcmFibGVDaGFuZ2VzPFQ+LFxuICBpdGVtczogVFtdXG4pOiBSeExpc3RUZW1wbGF0ZUNoYW5nZXMge1xuICBjb25zdCBjaGFuZ2VkSWR4cyA9IG5ldyBTZXQ8VD4oKTtcbiAgY29uc3QgY2hhbmdlc0FycjogUnhMaXN0VGVtcGxhdGVDaGFuZ2VbXSA9IFtdO1xuICBsZXQgbm90aWZ5UGFyZW50ID0gZmFsc2U7XG4gIGNoYW5nZXMuZm9yRWFjaE9wZXJhdGlvbigocmVjb3JkLCBhZGp1c3RlZFByZXZpb3VzSW5kZXgsIGN1cnJlbnRJbmRleCkgPT4ge1xuICAgIGNvbnN0IGl0ZW0gPSByZWNvcmQuaXRlbTtcbiAgICBpZiAocmVjb3JkLnByZXZpb3VzSW5kZXggPT0gbnVsbCkge1xuICAgICAgLy8gaW5zZXJ0XG4gICAgICBjaGFuZ2VzQXJyLnB1c2goXG4gICAgICAgIGdldEluc2VydENoYW5nZShpdGVtLCBjdXJyZW50SW5kZXggPT09IG51bGwgPyB1bmRlZmluZWQgOiBjdXJyZW50SW5kZXgpXG4gICAgICApO1xuICAgICAgY2hhbmdlZElkeHMuYWRkKGl0ZW0pO1xuICAgICAgbm90aWZ5UGFyZW50ID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKGN1cnJlbnRJbmRleCA9PSBudWxsKSB7XG4gICAgICAvLyByZW1vdmVcbiAgICAgIGNoYW5nZXNBcnIucHVzaChcbiAgICAgICAgZ2V0UmVtb3ZlQ2hhbmdlKFxuICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgYWRqdXN0ZWRQcmV2aW91c0luZGV4ID09PSBudWxsID8gdW5kZWZpbmVkIDogYWRqdXN0ZWRQcmV2aW91c0luZGV4XG4gICAgICAgIClcbiAgICAgICk7XG4gICAgICBub3RpZnlQYXJlbnQgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoYWRqdXN0ZWRQcmV2aW91c0luZGV4ICE9PSBudWxsKSB7XG4gICAgICAvLyBtb3ZlXG4gICAgICBjaGFuZ2VzQXJyLnB1c2goZ2V0TW92ZUNoYW5nZShpdGVtLCBjdXJyZW50SW5kZXgsIGFkanVzdGVkUHJldmlvdXNJbmRleCkpO1xuICAgICAgY2hhbmdlZElkeHMuYWRkKGl0ZW0pO1xuICAgICAgbm90aWZ5UGFyZW50ID0gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuICBjaGFuZ2VzLmZvckVhY2hJZGVudGl0eUNoYW5nZSgocmVjb3JkKSA9PiB7XG4gICAgY29uc3QgaXRlbSA9IHJlY29yZC5pdGVtO1xuICAgIGlmICghY2hhbmdlZElkeHMuaGFzKGl0ZW0pKSB7XG4gICAgICBjaGFuZ2VzQXJyLnB1c2goZ2V0VXBkYXRlQ2hhbmdlKGl0ZW0sIHJlY29yZC5jdXJyZW50SW5kZXgpKTtcbiAgICAgIGNoYW5nZWRJZHhzLmFkZChpdGVtKTtcbiAgICB9XG4gIH0pO1xuICBpdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgIGlmICghY2hhbmdlZElkeHMuaGFzKGl0ZW0pKSB7XG4gICAgICBjaGFuZ2VzQXJyLnB1c2goZ2V0VW5jaGFuZ2VkQ2hhbmdlKGl0ZW0sIGluZGV4KSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIFtjaGFuZ2VzQXJyLCBub3RpZnlQYXJlbnRdO1xuXG4gIC8vID09PT09PT09PT1cblxuICBmdW5jdGlvbiBnZXRNb3ZlQ2hhbmdlKFxuICAgIGl0ZW06IFQsXG4gICAgY3VycmVudEluZGV4OiBudW1iZXIsXG4gICAgYWRqdXN0ZWRQcmV2aW91c0luZGV4OiBudW1iZXJcbiAgKTogUnhMaXN0VGVtcGxhdGVDaGFuZ2Uge1xuICAgIHJldHVybiBbXG4gICAgICBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUubW92ZSxcbiAgICAgIFtpdGVtLCBjdXJyZW50SW5kZXgsIGFkanVzdGVkUHJldmlvdXNJbmRleF0sXG4gICAgXTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFVwZGF0ZUNoYW5nZShcbiAgICBpdGVtOiBULFxuICAgIGN1cnJlbnRJbmRleDogbnVtYmVyXG4gICk6IFJ4TGlzdFRlbXBsYXRlQ2hhbmdlIHtcbiAgICByZXR1cm4gW1J4TGlzdFRlbXBsYXRlQ2hhbmdlVHlwZS51cGRhdGUsIFtpdGVtLCBjdXJyZW50SW5kZXhdXTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFVuY2hhbmdlZENoYW5nZShpdGVtOiBULCBpbmRleDogbnVtYmVyKTogUnhMaXN0VGVtcGxhdGVDaGFuZ2Uge1xuICAgIHJldHVybiBbUnhMaXN0VGVtcGxhdGVDaGFuZ2VUeXBlLmNvbnRleHQsIFtpdGVtLCBpbmRleF1dO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0SW5zZXJ0Q2hhbmdlKFxuICAgIGl0ZW06IFQsXG4gICAgY3VycmVudEluZGV4OiBudW1iZXJcbiAgKTogUnhMaXN0VGVtcGxhdGVDaGFuZ2Uge1xuICAgIHJldHVybiBbXG4gICAgICBSeExpc3RUZW1wbGF0ZUNoYW5nZVR5cGUuaW5zZXJ0LFxuICAgICAgW2l0ZW0sIGN1cnJlbnRJbmRleCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IGN1cnJlbnRJbmRleF0sXG4gICAgXTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFJlbW92ZUNoYW5nZShcbiAgICBpdGVtOiBULFxuICAgIGFkanVzdGVkUHJldmlvdXNJbmRleDogbnVtYmVyXG4gICk6IFJ4TGlzdFRlbXBsYXRlQ2hhbmdlIHtcbiAgICByZXR1cm4gW1xuICAgICAgUnhMaXN0VGVtcGxhdGVDaGFuZ2VUeXBlLnJlbW92ZSxcbiAgICAgIFtcbiAgICAgICAgaXRlbSxcbiAgICAgICAgYWRqdXN0ZWRQcmV2aW91c0luZGV4ID09PSBudWxsID8gdW5kZWZpbmVkIDogYWRqdXN0ZWRQcmV2aW91c0luZGV4LFxuICAgICAgXSxcbiAgICBdO1xuICB9XG59XG4iXX0=