import { onStrategy, } from '@rx-angular/cdk/render-strategies';
import { BehaviorSubject, concat, of, } from 'rxjs';
import { ignoreElements, switchMap } from 'rxjs/operators';
/**
 * @internal
 * creates an embeddedViewRef
 *
 * @param viewContainerRef
 * @param templateRef
 * @param context
 * @param index
 * @return EmbeddedViewRef<C>
 */
export function createEmbeddedView(viewContainerRef, templateRef, context, index = 0) {
    const view = viewContainerRef.createEmbeddedView(templateRef, context, index);
    view.detectChanges();
    return view;
}
/**
 * @internal
 *
 * A factory function returning an object to handle `TemplateRef`'s.
 * You can add and get a `TemplateRef`.
 *
 */
export function templateHandling(viewContainerRef) {
    const templateCache = new Map();
    const get$ = (name) => {
        return templateCache.get(name) || of(undefined);
    };
    const get = (name) => {
        let ref;
        const templatRef$ = get$(name);
        if (templatRef$) {
            const sub = templatRef$.subscribe((r) => (ref = r));
            sub.unsubscribe();
        }
        return ref;
    };
    return {
        add(name, templateRef) {
            assertTemplate(name, templateRef);
            if (!templateCache.has(name)) {
                templateCache.set(name, new BehaviorSubject(templateRef));
            }
            else {
                templateCache.get(name).next(templateRef);
            }
        },
        get$,
        get,
        createEmbeddedView: (name, context) => createEmbeddedView(viewContainerRef, get(name), context),
    };
    //
    function assertTemplate(property, templateRef) {
        const isTemplateRefOrNull = !!(!templateRef || templateRef.createEmbeddedView);
        if (!isTemplateRefOrNull) {
            throw new Error(`${property} must be a TemplateRef, but received ${typeof templateRef}`);
        }
        return isTemplateRefOrNull;
    }
}
/**
 * @internal
 *
 * A side effect operator similar to `tap` but with a static internal logic.
 * It calls detect changes on the 'VirtualParent' and the injectingViewCdRef.
 *
 * @param injectingViewCdRef
 * @param strategy
 * @param notifyNeeded
 * @param ngZone
 */
export function notifyAllParentsIfNeeded(injectingViewCdRef, strategy, notifyNeeded, ngZone) {
    return (o$) => o$.pipe(switchMap((v) => {
        const notifyParent = notifyNeeded();
        if (!notifyParent) {
            return of(v);
        }
        return concat(of(v), onStrategy(injectingViewCdRef, strategy, (_v, work, options) => {
            /*console.log(
             'notifyAllParentsIfNeeded injectingView',
             (injectingViewCdRef as any).context
             );*/
            work(injectingViewCdRef, options.scope);
        }, {
            scope: injectingViewCdRef.context || injectingViewCdRef,
            ngZone,
        }).pipe(ignoreElements()));
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2Nkay90ZW1wbGF0ZS9zcmMvbGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLE9BQU8sRUFDTCxVQUFVLEdBRVgsTUFBTSxtQ0FBbUMsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsZUFBZSxFQUNmLE1BQU0sRUFHTixFQUFFLEdBRUgsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNEOzs7Ozs7Ozs7R0FTRztBQUNILE1BQU0sVUFBVSxrQkFBa0IsQ0FDaEMsZ0JBQWtDLEVBQ2xDLFdBQTJCLEVBQzNCLE9BQVUsRUFDVixLQUFLLEdBQUcsQ0FBQztJQUVULE1BQU0sSUFBSSxHQUFHLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDOUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3JCLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNILE1BQU0sVUFBVSxnQkFBZ0IsQ0FDOUIsZ0JBQWtDO0lBT2xDLE1BQU0sYUFBYSxHQUFHLElBQUksR0FBRyxFQUE4QixDQUFDO0lBRTVELE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBTyxFQUE4QixFQUFFO1FBQ25ELE9BQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDO0lBQ0YsTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFPLEVBQThCLEVBQUU7UUFDbEQsSUFBSSxHQUFtQixDQUFDO1FBQ3hCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ2hCLE1BQU0sR0FBRyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLENBQUM7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUMsQ0FBQztJQUVGLE9BQU87UUFDTCxHQUFHLENBQUMsSUFBTyxFQUFFLFdBQTJCO1lBQ3RDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDbEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDN0IsYUFBYSxDQUFDLEdBQUcsQ0FDZixJQUFJLEVBQ0osSUFBSSxlQUFlLENBQWlCLFdBQVcsQ0FBQyxDQUNqRCxDQUFDO1lBQ0osQ0FBQztpQkFBTSxDQUFDO2dCQUNOLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVDLENBQUM7UUFDSCxDQUFDO1FBQ0QsSUFBSTtRQUNKLEdBQUc7UUFDSCxrQkFBa0IsRUFBRSxDQUFDLElBQU8sRUFBRSxPQUFXLEVBQUUsRUFBRSxDQUMzQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDO0tBQzNELENBQUM7SUFFRixFQUFFO0lBQ0YsU0FBUyxjQUFjLENBQ3JCLFFBQWEsRUFDYixXQUFrQztRQUVsQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxDQUM1QixDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsa0JBQWtCLENBQy9DLENBQUM7UUFDRixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUN6QixNQUFNLElBQUksS0FBSyxDQUNiLEdBQUcsUUFBUSx3Q0FBd0MsT0FBTyxXQUFXLEVBQUUsQ0FDeEUsQ0FBQztRQUNKLENBQUM7UUFDRCxPQUFPLG1CQUFtQixDQUFDO0lBQzdCLENBQUM7QUFDSCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7R0FVRztBQUNILE1BQU0sVUFBVSx3QkFBd0IsQ0FDdEMsa0JBQXFDLEVBQ3JDLFFBQStCLEVBQy9CLFlBQTJCLEVBQzNCLE1BQWU7SUFFZixPQUFPLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDWixFQUFFLENBQUMsSUFBSSxDQUNMLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQ2QsTUFBTSxZQUFZLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ2xCLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2YsQ0FBQztRQUNELE9BQU8sTUFBTSxDQUNYLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFDTCxVQUFVLENBQ1Isa0JBQWtCLEVBQ2xCLFFBQVEsRUFDUixDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDcEI7OztpQkFHSztZQUNMLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsQ0FBQyxFQUNEO1lBQ0UsS0FBSyxFQUFHLGtCQUEwQixDQUFDLE9BQU8sSUFBSSxrQkFBa0I7WUFDaEUsTUFBTTtTQUNQLENBQ0YsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FDekIsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7QUFDTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIEVtYmVkZGVkVmlld1JlZixcbiAgTmdab25lLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBvblN0cmF0ZWd5LFxuICBSeFN0cmF0ZWd5Q3JlZGVudGlhbHMsXG59IGZyb20gJ0ByeC1hbmd1bGFyL2Nkay9yZW5kZXItc3RyYXRlZ2llcyc7XG5pbXBvcnQge1xuICBCZWhhdmlvclN1YmplY3QsXG4gIGNvbmNhdCxcbiAgTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uLFxuICBPYnNlcnZhYmxlLFxuICBvZixcbiAgU3ViamVjdCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBpZ25vcmVFbGVtZW50cywgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICogY3JlYXRlcyBhbiBlbWJlZGRlZFZpZXdSZWZcbiAqXG4gKiBAcGFyYW0gdmlld0NvbnRhaW5lclJlZlxuICogQHBhcmFtIHRlbXBsYXRlUmVmXG4gKiBAcGFyYW0gY29udGV4dFxuICogQHBhcmFtIGluZGV4XG4gKiBAcmV0dXJuIEVtYmVkZGVkVmlld1JlZjxDPlxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRW1iZWRkZWRWaWV3PEM+KFxuICB2aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8Qz4sXG4gIGNvbnRleHQ6IEMsXG4gIGluZGV4ID0gMFxuKTogRW1iZWRkZWRWaWV3UmVmPEM+IHtcbiAgY29uc3QgdmlldyA9IHZpZXdDb250YWluZXJSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KHRlbXBsYXRlUmVmLCBjb250ZXh0LCBpbmRleCk7XG4gIHZpZXcuZGV0ZWN0Q2hhbmdlcygpO1xuICByZXR1cm4gdmlldztcbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqXG4gKiBBIGZhY3RvcnkgZnVuY3Rpb24gcmV0dXJuaW5nIGFuIG9iamVjdCB0byBoYW5kbGUgYFRlbXBsYXRlUmVmYCdzLlxuICogWW91IGNhbiBhZGQgYW5kIGdldCBhIGBUZW1wbGF0ZVJlZmAuXG4gKlxuICovXG5leHBvcnQgZnVuY3Rpb24gdGVtcGxhdGVIYW5kbGluZzxOLCBDPihcbiAgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZlxuKToge1xuICBhZGQobmFtZTogTiwgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPEM+KTogdm9pZDtcbiAgZ2V0KG5hbWU6IE4pOiBUZW1wbGF0ZVJlZjxDPjtcbiAgZ2V0JChuYW1lOiBOKTogT2JzZXJ2YWJsZTxUZW1wbGF0ZVJlZjxDPj47XG4gIGNyZWF0ZUVtYmVkZGVkVmlldyhuYW1lOiBOLCBjb250ZXh0PzogQywgaW5kZXg/OiBudW1iZXIpOiBFbWJlZGRlZFZpZXdSZWY8Qz47XG59IHtcbiAgY29uc3QgdGVtcGxhdGVDYWNoZSA9IG5ldyBNYXA8TiwgU3ViamVjdDxUZW1wbGF0ZVJlZjxDPj4+KCk7XG5cbiAgY29uc3QgZ2V0JCA9IChuYW1lOiBOKTogT2JzZXJ2YWJsZTxUZW1wbGF0ZVJlZjxDPj4gPT4ge1xuICAgIHJldHVybiB0ZW1wbGF0ZUNhY2hlLmdldChuYW1lKSB8fCBvZih1bmRlZmluZWQpO1xuICB9O1xuICBjb25zdCBnZXQgPSAobmFtZTogTik6IFRlbXBsYXRlUmVmPEM+IHwgdW5kZWZpbmVkID0+IHtcbiAgICBsZXQgcmVmOiBUZW1wbGF0ZVJlZjxDPjtcbiAgICBjb25zdCB0ZW1wbGF0UmVmJCA9IGdldCQobmFtZSk7XG4gICAgaWYgKHRlbXBsYXRSZWYkKSB7XG4gICAgICBjb25zdCBzdWIgPSB0ZW1wbGF0UmVmJC5zdWJzY3JpYmUoKHIpID0+IChyZWYgPSByKSk7XG4gICAgICBzdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlZjtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIGFkZChuYW1lOiBOLCB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8Qz4pOiB2b2lkIHtcbiAgICAgIGFzc2VydFRlbXBsYXRlKG5hbWUsIHRlbXBsYXRlUmVmKTtcbiAgICAgIGlmICghdGVtcGxhdGVDYWNoZS5oYXMobmFtZSkpIHtcbiAgICAgICAgdGVtcGxhdGVDYWNoZS5zZXQoXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBuZXcgQmVoYXZpb3JTdWJqZWN0PFRlbXBsYXRlUmVmPEM+Pih0ZW1wbGF0ZVJlZilcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRlbXBsYXRlQ2FjaGUuZ2V0KG5hbWUpLm5leHQodGVtcGxhdGVSZWYpO1xuICAgICAgfVxuICAgIH0sXG4gICAgZ2V0JCxcbiAgICBnZXQsXG4gICAgY3JlYXRlRW1iZWRkZWRWaWV3OiAobmFtZTogTiwgY29udGV4dD86IEMpID0+XG4gICAgICBjcmVhdGVFbWJlZGRlZFZpZXcodmlld0NvbnRhaW5lclJlZiwgZ2V0KG5hbWUpLCBjb250ZXh0KSxcbiAgfTtcblxuICAvL1xuICBmdW5jdGlvbiBhc3NlcnRUZW1wbGF0ZTxUPihcbiAgICBwcm9wZXJ0eTogYW55LFxuICAgIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxUPiB8IG51bGxcbiAgKTogdGVtcGxhdGVSZWYgaXMgVGVtcGxhdGVSZWY8VD4ge1xuICAgIGNvbnN0IGlzVGVtcGxhdGVSZWZPck51bGwgPSAhIShcbiAgICAgICF0ZW1wbGF0ZVJlZiB8fCB0ZW1wbGF0ZVJlZi5jcmVhdGVFbWJlZGRlZFZpZXdcbiAgICApO1xuICAgIGlmICghaXNUZW1wbGF0ZVJlZk9yTnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgJHtwcm9wZXJ0eX0gbXVzdCBiZSBhIFRlbXBsYXRlUmVmLCBidXQgcmVjZWl2ZWQgJHt0eXBlb2YgdGVtcGxhdGVSZWZ9YFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGlzVGVtcGxhdGVSZWZPck51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqXG4gKiBBIHNpZGUgZWZmZWN0IG9wZXJhdG9yIHNpbWlsYXIgdG8gYHRhcGAgYnV0IHdpdGggYSBzdGF0aWMgaW50ZXJuYWwgbG9naWMuXG4gKiBJdCBjYWxscyBkZXRlY3QgY2hhbmdlcyBvbiB0aGUgJ1ZpcnR1YWxQYXJlbnQnIGFuZCB0aGUgaW5qZWN0aW5nVmlld0NkUmVmLlxuICpcbiAqIEBwYXJhbSBpbmplY3RpbmdWaWV3Q2RSZWZcbiAqIEBwYXJhbSBzdHJhdGVneVxuICogQHBhcmFtIG5vdGlmeU5lZWRlZFxuICogQHBhcmFtIG5nWm9uZVxuICovXG5leHBvcnQgZnVuY3Rpb24gbm90aWZ5QWxsUGFyZW50c0lmTmVlZGVkPFQ+KFxuICBpbmplY3RpbmdWaWV3Q2RSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICBzdHJhdGVneTogUnhTdHJhdGVneUNyZWRlbnRpYWxzLFxuICBub3RpZnlOZWVkZWQ6ICgpID0+IGJvb2xlYW4sXG4gIG5nWm9uZT86IE5nWm9uZVxuKTogTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uPFQ+IHtcbiAgcmV0dXJuIChvJCkgPT5cbiAgICBvJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKCh2KSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGlmeVBhcmVudCA9IG5vdGlmeU5lZWRlZCgpO1xuICAgICAgICBpZiAoIW5vdGlmeVBhcmVudCkge1xuICAgICAgICAgIHJldHVybiBvZih2KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29uY2F0KFxuICAgICAgICAgIG9mKHYpLFxuICAgICAgICAgIG9uU3RyYXRlZ3koXG4gICAgICAgICAgICBpbmplY3RpbmdWaWV3Q2RSZWYsXG4gICAgICAgICAgICBzdHJhdGVneSxcbiAgICAgICAgICAgIChfdiwgd29yaywgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAvKmNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgJ25vdGlmeUFsbFBhcmVudHNJZk5lZWRlZCBpbmplY3RpbmdWaWV3JyxcbiAgICAgICAgICAgICAgIChpbmplY3RpbmdWaWV3Q2RSZWYgYXMgYW55KS5jb250ZXh0XG4gICAgICAgICAgICAgICApOyovXG4gICAgICAgICAgICAgIHdvcmsoaW5qZWN0aW5nVmlld0NkUmVmLCBvcHRpb25zLnNjb3BlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHNjb3BlOiAoaW5qZWN0aW5nVmlld0NkUmVmIGFzIGFueSkuY29udGV4dCB8fCBpbmplY3RpbmdWaWV3Q2RSZWYsXG4gICAgICAgICAgICAgIG5nWm9uZSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApLnBpcGUoaWdub3JlRWxlbWVudHMoKSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbn1cbiJdfQ==