export const coalescingManager = createCoalesceManager();
function hasKey(ctx, property) {
    return ctx[property] != null;
}
/*
 * createPropertiesWeakMap
 *
 * @param getDefaults: (o: O) => P
 * Example:
 *
 * export interface Properties {
 *   isCoalescing: boolean;
 * }
 *
 * const obj: object = {
 *   foo: 'bar',
 *   isCoalescing: 'weakMap version'
 * };
 *
 * const getDefaults = (ctx: object): Properties => ({isCoalescing: false});
 * const propsMap = createPropertiesWeakMap<object, Properties>(getDefaults);
 *
 * console.log('obj before:', obj);
 * // {foo: "bar", isCoalescing: "weakMap version"}
 * console.log('props before:', propsMap.getProps(obj));
 * // {isCoalescing: "weakMap version"}
 *
 * propsMap.setProps(obj, {isCoalescing: true});
 * console.log('obj after:', obj);
 * // {foo: "bar", isCoalescing: "weakMap version"}
 * console.log('props after:', propsMap.getProps(obj));
 * // {isCoalescing: "true"}
 * */
function createPropertiesWeakMap(getDefaults) {
    const propertyMap = new WeakMap();
    return {
        getProps: getProperties,
        setProps: setProperties,
    };
    function getProperties(ctx) {
        const defaults = getDefaults(ctx);
        const propertiesPresent = propertyMap.get(ctx);
        let properties;
        if (propertiesPresent !== undefined) {
            properties = propertiesPresent;
        }
        else {
            properties = {};
            Object.entries(defaults).forEach(([prop, value]) => {
                if (hasKey(ctx, prop)) {
                    properties[prop] = ctx[prop];
                }
                else {
                    properties[prop] = value;
                }
            });
            propertyMap.set(ctx, properties);
        }
        return properties;
    }
    function setProperties(ctx, props) {
        const properties = getProperties(ctx);
        Object.entries(props).forEach(([prop, value]) => {
            properties[prop] = value;
        });
        propertyMap.set(ctx, properties);
        return properties;
    }
}
const coalescingContextPropertiesMap = createPropertiesWeakMap((ctx) => ({
    numCoalescingSubscribers: 0,
}));
/**
 * @describe createCoalesceManager
 *
 * returns a
 * Maintains a weak map of component references ans flags
 * them if the coalescing process is already started for them.
 *
 * Used in render aware internally.
 */
function createCoalesceManager() {
    return {
        remove: removeWork,
        add: addWork,
        isCoalescing,
    };
    // Increments the number of subscriptions in a scope e.g. a class instance
    function removeWork(scope) {
        const numCoalescingSubscribers = coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers -
            1;
        coalescingContextPropertiesMap.setProps(scope, {
            numCoalescingSubscribers: numCoalescingSubscribers >= 0 ? numCoalescingSubscribers : 0,
        });
    }
    // Decrements the number of subscriptions in a scope e.g. a class instance
    function addWork(scope) {
        const numCoalescingSubscribers = coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers +
            1;
        coalescingContextPropertiesMap.setProps(scope, {
            numCoalescingSubscribers,
        });
    }
    // Checks if anybody else is already coalescing atm
    function isCoalescing(scope) {
        return (coalescingContextPropertiesMap.getProps(scope).numCoalescingSubscribers >
            0);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29hbGVzY2luZ01hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL2Nkay9jb2FsZXNjaW5nL3NyYy9saWIvY29hbGVzY2luZ01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBVUEsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQXNCLHFCQUFxQixFQUFFLENBQUM7QUFHNUUsU0FBUyxNQUFNLENBQUksR0FBTSxFQUFFLFFBQWtCO0lBQzNDLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQztBQUMvQixDQUFDO0FBQ0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7S0E0Qks7QUFDTCxTQUFTLHVCQUF1QixDQUc5QixXQUF3QjtJQUV4QixNQUFNLFdBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO0lBRXhDLE9BQU87UUFDTCxRQUFRLEVBQUUsYUFBYTtRQUN2QixRQUFRLEVBQUUsYUFBYTtLQUN4QixDQUFDO0lBRUYsU0FBUyxhQUFhLENBQUMsR0FBTTtRQUMzQixNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxpQkFBaUIsR0FBa0IsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5RCxJQUFJLFVBQWEsQ0FBQztRQUVsQixJQUFJLGlCQUFpQixLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3BDLFVBQVUsR0FBRyxpQkFBc0IsQ0FBQztRQUN0QyxDQUFDO2FBQU0sQ0FBQztZQUNOLFVBQVUsR0FBRyxFQUFPLENBQUM7WUFFcEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQWUsQ0FBQyxPQUFPLENBQzdDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUF5QixFQUFRLEVBQUU7Z0JBQzlDLElBQUksTUFBTSxDQUFDLEdBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDO29CQUMzQixVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUksR0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN0QyxDQUFDO3FCQUFNLENBQUM7b0JBQ04sVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDM0IsQ0FBQztZQUNILENBQUMsQ0FDRixDQUFDO1lBRUYsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDbkMsQ0FBQztRQUNELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxTQUFTLGFBQWEsQ0FBQyxHQUFNLEVBQUUsS0FBaUI7UUFDOUMsTUFBTSxVQUFVLEdBQU0sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDL0QsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUNILFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2pDLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7QUFDSCxDQUFDO0FBRUQsTUFBTSw4QkFBOEIsR0FBRyx1QkFBdUIsQ0FHNUQsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVix3QkFBd0IsRUFBRSxDQUFDO0NBQzVCLENBQUMsQ0FBQyxDQUFDO0FBQ0o7Ozs7Ozs7O0dBUUc7QUFDSCxTQUFTLHFCQUFxQjtJQUM1QixPQUFPO1FBQ0wsTUFBTSxFQUFFLFVBQVU7UUFDbEIsR0FBRyxFQUFFLE9BQU87UUFDWixZQUFZO0tBQ2IsQ0FBQztJQUVGLDBFQUEwRTtJQUMxRSxTQUFTLFVBQVUsQ0FBQyxLQUE4QjtRQUNoRCxNQUFNLHdCQUF3QixHQUM1Qiw4QkFBOEIsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsd0JBQXdCO1lBQ3ZFLENBQUMsQ0FBQztRQUNKLDhCQUE4QixDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7WUFDN0Msd0JBQXdCLEVBQ3RCLHdCQUF3QixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDL0QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELDBFQUEwRTtJQUMxRSxTQUFTLE9BQU8sQ0FBQyxLQUE4QjtRQUM3QyxNQUFNLHdCQUF3QixHQUM1Qiw4QkFBOEIsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsd0JBQXdCO1lBQ3ZFLENBQUMsQ0FBQztRQUNKLDhCQUE4QixDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUU7WUFDN0Msd0JBQXdCO1NBQ3pCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxtREFBbUQ7SUFDbkQsU0FBUyxZQUFZLENBQUMsS0FBOEI7UUFDbEQsT0FBTyxDQUNMLDhCQUE4QixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyx3QkFBd0I7WUFDdkUsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImludGVyZmFjZSBDb2FsZXNjaW5nQ29udGV4dFByb3BzIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4ge1xuICBudW1Db2FsZXNjaW5nU3Vic2NyaWJlcnM6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb2FsZXNjaW5nTWFuYWdlciB7XG4gIHJlbW92ZTogKHNjb3BlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gdm9pZDtcbiAgYWRkOiAoc2NvcGU6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB2b2lkO1xuICBpc0NvYWxlc2Npbmc6IChzY29wZTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjb25zdCBjb2FsZXNjaW5nTWFuYWdlcjogQ29hbGVzY2luZ01hbmFnZXIgPSBjcmVhdGVDb2FsZXNjZU1hbmFnZXIoKTtcbnR5cGUgS2V5T2Y8Tz4gPSBrZXlvZiBPO1xudHlwZSBWYWx1ZU9mPE8+ID0gT1trZXlvZiBPXTtcbmZ1bmN0aW9uIGhhc0tleTxPPihjdHg6IE8sIHByb3BlcnR5OiBLZXlPZjxPPik6IGN0eCBpcyBPIHtcbiAgcmV0dXJuIGN0eFtwcm9wZXJ0eV0gIT0gbnVsbDtcbn1cbi8qXG4gKiBjcmVhdGVQcm9wZXJ0aWVzV2Vha01hcFxuICpcbiAqIEBwYXJhbSBnZXREZWZhdWx0czogKG86IE8pID0+IFBcbiAqIEV4YW1wbGU6XG4gKlxuICogZXhwb3J0IGludGVyZmFjZSBQcm9wZXJ0aWVzIHtcbiAqICAgaXNDb2FsZXNjaW5nOiBib29sZWFuO1xuICogfVxuICpcbiAqIGNvbnN0IG9iajogb2JqZWN0ID0ge1xuICogICBmb286ICdiYXInLFxuICogICBpc0NvYWxlc2Npbmc6ICd3ZWFrTWFwIHZlcnNpb24nXG4gKiB9O1xuICpcbiAqIGNvbnN0IGdldERlZmF1bHRzID0gKGN0eDogb2JqZWN0KTogUHJvcGVydGllcyA9PiAoe2lzQ29hbGVzY2luZzogZmFsc2V9KTtcbiAqIGNvbnN0IHByb3BzTWFwID0gY3JlYXRlUHJvcGVydGllc1dlYWtNYXA8b2JqZWN0LCBQcm9wZXJ0aWVzPihnZXREZWZhdWx0cyk7XG4gKlxuICogY29uc29sZS5sb2coJ29iaiBiZWZvcmU6Jywgb2JqKTtcbiAqIC8vIHtmb286IFwiYmFyXCIsIGlzQ29hbGVzY2luZzogXCJ3ZWFrTWFwIHZlcnNpb25cIn1cbiAqIGNvbnNvbGUubG9nKCdwcm9wcyBiZWZvcmU6JywgcHJvcHNNYXAuZ2V0UHJvcHMob2JqKSk7XG4gKiAvLyB7aXNDb2FsZXNjaW5nOiBcIndlYWtNYXAgdmVyc2lvblwifVxuICpcbiAqIHByb3BzTWFwLnNldFByb3BzKG9iaiwge2lzQ29hbGVzY2luZzogdHJ1ZX0pO1xuICogY29uc29sZS5sb2coJ29iaiBhZnRlcjonLCBvYmopO1xuICogLy8ge2ZvbzogXCJiYXJcIiwgaXNDb2FsZXNjaW5nOiBcIndlYWtNYXAgdmVyc2lvblwifVxuICogY29uc29sZS5sb2coJ3Byb3BzIGFmdGVyOicsIHByb3BzTWFwLmdldFByb3BzKG9iaikpO1xuICogLy8ge2lzQ29hbGVzY2luZzogXCJ0cnVlXCJ9XG4gKiAqL1xuZnVuY3Rpb24gY3JlYXRlUHJvcGVydGllc1dlYWtNYXA8XG4gIE8gZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgUCBleHRlbmRzIE9cbj4oZ2V0RGVmYXVsdHM6IChvOiBPKSA9PiBQKSB7XG4gIHR5cGUgSyA9IEtleU9mPFA+O1xuICBjb25zdCBwcm9wZXJ0eU1hcCA9IG5ldyBXZWFrTWFwPE8sIFA+KCk7XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRQcm9wczogZ2V0UHJvcGVydGllcyxcbiAgICBzZXRQcm9wczogc2V0UHJvcGVydGllcyxcbiAgfTtcblxuICBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKGN0eDogTyk6IFAge1xuICAgIGNvbnN0IGRlZmF1bHRzID0gZ2V0RGVmYXVsdHMoY3R4KTtcbiAgICBjb25zdCBwcm9wZXJ0aWVzUHJlc2VudDogUCB8IHVuZGVmaW5lZCA9IHByb3BlcnR5TWFwLmdldChjdHgpO1xuICAgIGxldCBwcm9wZXJ0aWVzOiBQO1xuXG4gICAgaWYgKHByb3BlcnRpZXNQcmVzZW50ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzUHJlc2VudCBhcyBQO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9wZXJ0aWVzID0ge30gYXMgUDtcblxuICAgICAgKE9iamVjdC5lbnRyaWVzKGRlZmF1bHRzKSBhcyB1bmtub3duW10pLmZvckVhY2goXG4gICAgICAgIChbcHJvcCwgdmFsdWVdOiBbS2V5T2Y8UD4sIFZhbHVlT2Y8UD5dKTogdm9pZCA9PiB7XG4gICAgICAgICAgaWYgKGhhc0tleShjdHggYXMgUCwgcHJvcCkpIHtcbiAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSAoY3R4IGFzIFApW3Byb3BdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzW3Byb3BdID0gdmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICBwcm9wZXJ0eU1hcC5zZXQoY3R4LCBwcm9wZXJ0aWVzKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRQcm9wZXJ0aWVzKGN0eDogTywgcHJvcHM6IFBhcnRpYWw8UD4pOiBQIHtcbiAgICBjb25zdCBwcm9wZXJ0aWVzOiBQID0gZ2V0UHJvcGVydGllcyhjdHgpO1xuICAgIChPYmplY3QuZW50cmllcyhwcm9wcykgYXMgW0ssIFBbS11dW10pLmZvckVhY2goKFtwcm9wLCB2YWx1ZV0pID0+IHtcbiAgICAgIHByb3BlcnRpZXNbcHJvcF0gPSB2YWx1ZTtcbiAgICB9KTtcbiAgICBwcm9wZXJ0eU1hcC5zZXQoY3R4LCBwcm9wZXJ0aWVzKTtcbiAgICByZXR1cm4gcHJvcGVydGllcztcbiAgfVxufVxuXG5jb25zdCBjb2FsZXNjaW5nQ29udGV4dFByb3BlcnRpZXNNYXAgPSBjcmVhdGVQcm9wZXJ0aWVzV2Vha01hcDxcbiAgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIENvYWxlc2NpbmdDb250ZXh0UHJvcHNcbj4oKGN0eCkgPT4gKHtcbiAgbnVtQ29hbGVzY2luZ1N1YnNjcmliZXJzOiAwLFxufSkpO1xuLyoqXG4gKiBAZGVzY3JpYmUgY3JlYXRlQ29hbGVzY2VNYW5hZ2VyXG4gKlxuICogcmV0dXJucyBhXG4gKiBNYWludGFpbnMgYSB3ZWFrIG1hcCBvZiBjb21wb25lbnQgcmVmZXJlbmNlcyBhbnMgZmxhZ3NcbiAqIHRoZW0gaWYgdGhlIGNvYWxlc2NpbmcgcHJvY2VzcyBpcyBhbHJlYWR5IHN0YXJ0ZWQgZm9yIHRoZW0uXG4gKlxuICogVXNlZCBpbiByZW5kZXIgYXdhcmUgaW50ZXJuYWxseS5cbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ29hbGVzY2VNYW5hZ2VyKCk6IENvYWxlc2NpbmdNYW5hZ2VyIHtcbiAgcmV0dXJuIHtcbiAgICByZW1vdmU6IHJlbW92ZVdvcmssXG4gICAgYWRkOiBhZGRXb3JrLFxuICAgIGlzQ29hbGVzY2luZyxcbiAgfTtcblxuICAvLyBJbmNyZW1lbnRzIHRoZSBudW1iZXIgb2Ygc3Vic2NyaXB0aW9ucyBpbiBhIHNjb3BlIGUuZy4gYSBjbGFzcyBpbnN0YW5jZVxuICBmdW5jdGlvbiByZW1vdmVXb3JrKHNjb3BlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IHZvaWQge1xuICAgIGNvbnN0IG51bUNvYWxlc2NpbmdTdWJzY3JpYmVycyA9XG4gICAgICBjb2FsZXNjaW5nQ29udGV4dFByb3BlcnRpZXNNYXAuZ2V0UHJvcHMoc2NvcGUpLm51bUNvYWxlc2NpbmdTdWJzY3JpYmVycyAtXG4gICAgICAxO1xuICAgIGNvYWxlc2NpbmdDb250ZXh0UHJvcGVydGllc01hcC5zZXRQcm9wcyhzY29wZSwge1xuICAgICAgbnVtQ29hbGVzY2luZ1N1YnNjcmliZXJzOlxuICAgICAgICBudW1Db2FsZXNjaW5nU3Vic2NyaWJlcnMgPj0gMCA/IG51bUNvYWxlc2NpbmdTdWJzY3JpYmVycyA6IDAsXG4gICAgfSk7XG4gIH1cblxuICAvLyBEZWNyZW1lbnRzIHRoZSBudW1iZXIgb2Ygc3Vic2NyaXB0aW9ucyBpbiBhIHNjb3BlIGUuZy4gYSBjbGFzcyBpbnN0YW5jZVxuICBmdW5jdGlvbiBhZGRXb3JrKHNjb3BlOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IHZvaWQge1xuICAgIGNvbnN0IG51bUNvYWxlc2NpbmdTdWJzY3JpYmVycyA9XG4gICAgICBjb2FsZXNjaW5nQ29udGV4dFByb3BlcnRpZXNNYXAuZ2V0UHJvcHMoc2NvcGUpLm51bUNvYWxlc2NpbmdTdWJzY3JpYmVycyArXG4gICAgICAxO1xuICAgIGNvYWxlc2NpbmdDb250ZXh0UHJvcGVydGllc01hcC5zZXRQcm9wcyhzY29wZSwge1xuICAgICAgbnVtQ29hbGVzY2luZ1N1YnNjcmliZXJzLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gQ2hlY2tzIGlmIGFueWJvZHkgZWxzZSBpcyBhbHJlYWR5IGNvYWxlc2NpbmcgYXRtXG4gIGZ1bmN0aW9uIGlzQ29hbGVzY2luZyhzY29wZTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgY29hbGVzY2luZ0NvbnRleHRQcm9wZXJ0aWVzTWFwLmdldFByb3BzKHNjb3BlKS5udW1Db2FsZXNjaW5nU3Vic2NyaWJlcnMgPlxuICAgICAgMFxuICAgICk7XG4gIH1cbn1cbiJdfQ==