import { Inject, Injectable, Optional, } from '@angular/core';
import { BehaviorSubject, fromEvent, } from 'rxjs';
import { map, shareReplay, switchMap, takeUntil } from 'rxjs/operators';
import { mergeDefaultConfig, RX_RENDER_STRATEGIES_CONFIG, } from './config';
import { onStrategy } from './onStrategy';
import * as i0 from "@angular/core";
/**
 * @description
 * RxStrategyProvider is a wrapper service that you can use to consume strategies and schedule your code execution.
 *
 * @example
 * Component({
 *   selector: 'app-service-communicator',
 *   template: ``
 * });
 * export class ServiceCommunicationComponent {
 *   private currentUserSettings;
 *
 *   constructor(
 *     private strategyProvider: RxStrategyProvider,
 *     private userService: UserService,
 *     private backgroundSync: BackgroundSyncService
 *   ) {
 *     this.userService.fetchCurrentUserSettings
 *       .pipe(
 *         tap(settings => (this.currentUserSettings = settings)),
 *         this.strategyProvider.scheduleWith(
 *           settings => this.backgroundSync.openConnection(settings),
 *           { strategy: 'idle' }
 *         )
 *       )
 *       .subscribe();
 *   }
 * }
 *
 * @docsCategory RxStrategyProvider
 * @docsPage RxStrategyProvider
 */
export class RxStrategyProvider {
    _strategies$ = new BehaviorSubject(undefined);
    _primaryStrategy$ = new BehaviorSubject(undefined);
    _cfg;
    /**
     * @description
     * Returns current `RxAngularConfig` used in the service.
     * Config includes:
     * - strategy that currently in use - `primaryStrategy`
     * - array of custom user defined strategies - `customStrategies`
     * - setting that is responsible for running in our outside of the zone.js - `patchZone`
     */
    get config() {
        return this._cfg;
    }
    /**
     * @description
     * Returns object that contains key-value pairs of strategy names and their credentials (settings) that are available in the service.
     */
    get strategies() {
        return this._strategies$.getValue();
    }
    /**
     * @description
     * Returns an array of strategy names available in the service.
     */
    get strategyNames() {
        return Object.values(this.strategies).map((s) => s.name);
    }
    /**
     * @description
     * Returns current strategy of the service.
     */
    get primaryStrategy() {
        return this._primaryStrategy$.getValue().name;
    }
    /**
     * @description
     * Set's the strategy that will be used by the service.
     */
    set primaryStrategy(strategyName) {
        this._primaryStrategy$.next(this.strategies[strategyName]);
    }
    /**
     * @description
     * Current strategy of the service as an observable.
     */
    primaryStrategy$ = this._primaryStrategy$.asObservable();
    /**
     * @description
     * Returns observable of an object that contains key-value pairs of strategy names and their credentials (settings) that are available in the service.
     */
    strategies$ = this._strategies$.asObservable();
    /**
     * @description
     * Returns an observable of an array of strategy names available in the service.
     */
    strategyNames$ = this.strategies$.pipe(map((strategies) => Object.values(strategies).map((s) => s.name)), shareReplay({ bufferSize: 1, refCount: true }));
    /**
     * @internal
     */
    constructor(cfg) {
        this._cfg = mergeDefaultConfig(cfg);
        this._strategies$.next(this._cfg.customStrategies);
        this.primaryStrategy = this.config.primaryStrategy;
    }
    /**
     * @description
     * Allows to schedule a work inside rxjs `pipe`. Accepts the work and configuration options object.
     * - work is any function that should be executed
     * - (optional) options includes strategy, patchZone and scope
     *
     * Scope is by default a subscription but you can also pass `this` and then the scope will be current component.
     * Scope setup is useful if your work is some of the methods of `ChangeDetectorRef`. Only one change detection will be triggered if you have multiple schedules of change detection methods and scope is set to `this`.
     *
     * @example
     * myObservable$.pipe(
     *    this.strategyProvider.scheduleWith(() => myWork(), {strategy: 'idle', patchZone: false})
     * ).subscribe();
     *
     * @return MonoTypeOperatorFunction<R>
     */
    scheduleWith(work, options) {
        const strategy = this.strategies[options?.strategy || this.primaryStrategy];
        const scope = options?.scope || {};
        const _work = getWork(work, options?.patchZone);
        const ngZone = options?.patchZone || undefined;
        return (o$) => o$.pipe(switchMap((v) => onStrategy(v, strategy, (_v) => {
            _work(_v);
        }, { scope, ngZone })));
    }
    /**
     * @description
     * Allows to schedule a work as an observable. Accepts the work and configuration options object.
     * - work is any function that should be executed
     * - (optional) options includes strategy, patchZone and scope
     *
     * Scope is by default a subscription but you can also pass `this` and then the scope will be current component.
     * Scope setup is especially useful if you provide work that will trigger a change detection.
     *
     * @example
     * this.strategyProvider.schedule(() => myWork(), {strategy: 'idle', patchZone: false}).subscribe();
     *
     * @return Observable<R>
     */
    schedule(work, options) {
        const strategy = this.strategies[options?.strategy || this.primaryStrategy];
        const scope = options?.scope || {};
        const _work = getWork(work, options?.patchZone);
        const ngZone = options?.patchZone || undefined;
        let returnVal;
        return onStrategy(null, strategy, () => {
            returnVal = _work();
        }, { scope, ngZone }).pipe(map(() => returnVal));
    }
    /**
     * @description
     * Allows to schedule a change detection cycle. Accepts the ChangeDetectorRef and configuration options object.
     * Options include:
     * - afterCD which is the work that should be executed after change detection cycle.
     * - abortCtrl is an AbortController that you can use to cancel the scheduled cycle.
     *
     * @example
     * this.strategyProvider.scheduleCd(this.changeDetectorRef, {afterCD: myWork()});
     *
     * @return AbortController
     */
    scheduleCD(cdRef, options) {
        const strategy = this.strategies[options?.strategy || this.primaryStrategy];
        const scope = options?.scope || cdRef;
        const abC = options?.abortCtrl || new AbortController();
        const ngZone = options?.patchZone || undefined;
        const work = getWork(() => {
            strategy.work(cdRef, scope);
            if (options?.afterCD) {
                options.afterCD();
            }
        }, options.patchZone);
        onStrategy(null, strategy, () => {
            work();
        }, { scope, ngZone })
            .pipe(takeUntil(fromEvent(abC.signal, 'abort')))
            .subscribe();
        return abC;
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: RxStrategyProvider, deps: [{ token: RX_RENDER_STRATEGIES_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
    /** @nocollapse */ static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: RxStrategyProvider, providedIn: 'root' });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: RxStrategyProvider, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [RX_RENDER_STRATEGIES_CONFIG]
                }] }] });
function getWork(work, patchZone) {
    let _work = work;
    if (patchZone) {
        _work = (args) => patchZone.run(() => work(args));
    }
    return _work;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyYXRlZ3ktcHJvdmlkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY2RrL3JlbmRlci1zdHJhdGVnaWVzL3NyYy9saWIvc3RyYXRlZ3ktcHJvdmlkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsTUFBTSxFQUNOLFVBQVUsRUFFVixRQUFRLEdBQ1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLGVBQWUsRUFDZixTQUFTLEdBR1YsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEUsT0FBTyxFQUNMLGtCQUFrQixFQUNsQiwyQkFBMkIsR0FFNUIsTUFBTSxVQUFVLENBQUM7QUFPbEIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQzs7QUFFMUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0ErQkc7QUFFSCxNQUFNLE9BQU8sa0JBQWtCO0lBQ3JCLFlBQVksR0FBRyxJQUFJLGVBQWUsQ0FBa0IsU0FBUyxDQUFDLENBQUM7SUFDL0QsaUJBQWlCLEdBQUcsSUFBSSxlQUFlLENBRTdDLFNBQVMsQ0FBQyxDQUFDO0lBRUksSUFBSSxDQUF3QztJQUU3RDs7Ozs7OztPQU9HO0lBQ0gsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdEMsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksYUFBYTtRQUNmLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksZUFBZTtRQUNqQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFDaEQsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksZUFBZSxDQUFDLFlBQWdDO1FBQ2xELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQ2tCLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQ3pFLENBQUM7SUFDSixDQUFDO0lBRUQ7OztPQUdHO0lBQ00sZ0JBQWdCLEdBQ3ZCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUV4Qzs7O09BR0c7SUFDTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUV4RDs7O09BR0c7SUFDTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQzdDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUNqRSxXQUFXLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUMvQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxZQUdFLEdBQWdDO1FBRWhDLElBQUksQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBdUIsQ0FBQyxDQUFDO1FBQzFELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7SUFDckQsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7T0FlRztJQUNILFlBQVksQ0FDVixJQUFxQixFQUNyQixPQUFtQztRQUVuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzVFLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ25DLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sTUFBTSxHQUFHLE9BQU8sRUFBRSxTQUFTLElBQUksU0FBUyxDQUFDO1FBQy9DLE9BQU8sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUNaLEVBQUUsQ0FBQyxJQUFJLENBQ0wsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDZCxVQUFVLENBQ1IsQ0FBQyxFQUNELFFBQVEsRUFDUixDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ0wsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1osQ0FBQyxFQUNELEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUNsQixDQUNGLENBQ0YsQ0FBQztJQUNOLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7OztPQWFHO0lBQ0gsUUFBUSxDQUNOLElBQWEsRUFDYixPQUFtQztRQUVuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzVFLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ25DLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sTUFBTSxHQUFHLE9BQU8sRUFBRSxTQUFTLElBQUksU0FBUyxDQUFDO1FBQy9DLElBQUksU0FBWSxDQUFDO1FBQ2pCLE9BQU8sVUFBVSxDQUNmLElBQUksRUFDSixRQUFRLEVBQ1IsR0FBRyxFQUFFO1lBQ0gsU0FBUyxHQUFHLEtBQUssRUFBRSxDQUFDO1FBQ3RCLENBQUMsRUFDRCxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FDbEIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7Ozs7Ozs7OztPQVdHO0lBQ0gsVUFBVSxDQUNSLEtBQXdCLEVBQ3hCLE9BR0M7UUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxRQUFRLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzVFLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLElBQUksS0FBSyxDQUFDO1FBQ3RDLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxTQUFTLElBQUksSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUN4RCxNQUFNLE1BQU0sR0FBRyxPQUFPLEVBQUUsU0FBUyxJQUFJLFNBQVMsQ0FBQztRQUMvQyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ3hCLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVCLElBQUksT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDO2dCQUNyQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEIsQ0FBQztRQUNILENBQUMsRUFBRSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEIsVUFBVSxDQUNSLElBQUksRUFDSixRQUFRLEVBQ1IsR0FBRyxFQUFFO1lBQ0gsSUFBSSxFQUFFLENBQUM7UUFDVCxDQUFDLEVBQ0QsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQ2xCO2FBQ0UsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQy9DLFNBQVMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDOzBIQXpNVSxrQkFBa0Isa0JBaUZuQiwyQkFBMkI7OEhBakYxQixrQkFBa0IsY0FETCxNQUFNOzsyRkFDbkIsa0JBQWtCO2tCQUQ5QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7MEJBaUY3QixRQUFROzswQkFDUixNQUFNOzJCQUFDLDJCQUEyQjs7QUEySHZDLFNBQVMsT0FBTyxDQUNkLElBQXVCLEVBQ3ZCLFNBQTBCO0lBRTFCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztJQUNqQixJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ2QsS0FBSyxHQUFHLENBQUMsSUFBVSxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgSW5qZWN0LFxuICBJbmplY3RhYmxlLFxuICBOZ1pvbmUsXG4gIE9wdGlvbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEJlaGF2aW9yU3ViamVjdCxcbiAgZnJvbUV2ZW50LFxuICBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb24sXG4gIE9ic2VydmFibGUsXG59IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBtZXJnZURlZmF1bHRDb25maWcsXG4gIFJYX1JFTkRFUl9TVFJBVEVHSUVTX0NPTkZJRyxcbiAgUnhSZW5kZXJTdHJhdGVnaWVzQ29uZmlnLFxufSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQge1xuICBSeFN0cmF0ZWdpZXMsXG4gIFJ4U3RyYXRlZ3lDcmVkZW50aWFscyxcbiAgUnhTdHJhdGVneU5hbWVzLFxuICBTY2hlZHVsZU9uU3RyYXRlZ3lPcHRpb25zLFxufSBmcm9tICcuL21vZGVsJztcbmltcG9ydCB7IG9uU3RyYXRlZ3kgfSBmcm9tICcuL29uU3RyYXRlZ3knO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICogUnhTdHJhdGVneVByb3ZpZGVyIGlzIGEgd3JhcHBlciBzZXJ2aWNlIHRoYXQgeW91IGNhbiB1c2UgdG8gY29uc3VtZSBzdHJhdGVnaWVzIGFuZCBzY2hlZHVsZSB5b3VyIGNvZGUgZXhlY3V0aW9uLlxuICpcbiAqIEBleGFtcGxlXG4gKiBDb21wb25lbnQoe1xuICogICBzZWxlY3RvcjogJ2FwcC1zZXJ2aWNlLWNvbW11bmljYXRvcicsXG4gKiAgIHRlbXBsYXRlOiBgYFxuICogfSk7XG4gKiBleHBvcnQgY2xhc3MgU2VydmljZUNvbW11bmljYXRpb25Db21wb25lbnQge1xuICogICBwcml2YXRlIGN1cnJlbnRVc2VyU2V0dGluZ3M7XG4gKlxuICogICBjb25zdHJ1Y3RvcihcbiAqICAgICBwcml2YXRlIHN0cmF0ZWd5UHJvdmlkZXI6IFJ4U3RyYXRlZ3lQcm92aWRlcixcbiAqICAgICBwcml2YXRlIHVzZXJTZXJ2aWNlOiBVc2VyU2VydmljZSxcbiAqICAgICBwcml2YXRlIGJhY2tncm91bmRTeW5jOiBCYWNrZ3JvdW5kU3luY1NlcnZpY2VcbiAqICAgKSB7XG4gKiAgICAgdGhpcy51c2VyU2VydmljZS5mZXRjaEN1cnJlbnRVc2VyU2V0dGluZ3NcbiAqICAgICAgIC5waXBlKFxuICogICAgICAgICB0YXAoc2V0dGluZ3MgPT4gKHRoaXMuY3VycmVudFVzZXJTZXR0aW5ncyA9IHNldHRpbmdzKSksXG4gKiAgICAgICAgIHRoaXMuc3RyYXRlZ3lQcm92aWRlci5zY2hlZHVsZVdpdGgoXG4gKiAgICAgICAgICAgc2V0dGluZ3MgPT4gdGhpcy5iYWNrZ3JvdW5kU3luYy5vcGVuQ29ubmVjdGlvbihzZXR0aW5ncyksXG4gKiAgICAgICAgICAgeyBzdHJhdGVneTogJ2lkbGUnIH1cbiAqICAgICAgICAgKVxuICogICAgICAgKVxuICogICAgICAgLnN1YnNjcmliZSgpO1xuICogICB9XG4gKiB9XG4gKlxuICogQGRvY3NDYXRlZ29yeSBSeFN0cmF0ZWd5UHJvdmlkZXJcbiAqIEBkb2NzUGFnZSBSeFN0cmF0ZWd5UHJvdmlkZXJcbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBSeFN0cmF0ZWd5UHJvdmlkZXI8VCBleHRlbmRzIHN0cmluZyA9IHN0cmluZz4ge1xuICBwcml2YXRlIF9zdHJhdGVnaWVzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UnhTdHJhdGVnaWVzPFQ+Pih1bmRlZmluZWQpO1xuICBwcml2YXRlIF9wcmltYXJ5U3RyYXRlZ3kkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxcbiAgICBSeFN0cmF0ZWd5Q3JlZGVudGlhbHM8UnhTdHJhdGVneU5hbWVzPFQ+PlxuICA+KHVuZGVmaW5lZCk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfY2ZnOiBSZXF1aXJlZDxSeFJlbmRlclN0cmF0ZWdpZXNDb25maWc8VD4+O1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUmV0dXJucyBjdXJyZW50IGBSeEFuZ3VsYXJDb25maWdgIHVzZWQgaW4gdGhlIHNlcnZpY2UuXG4gICAqIENvbmZpZyBpbmNsdWRlczpcbiAgICogLSBzdHJhdGVneSB0aGF0IGN1cnJlbnRseSBpbiB1c2UgLSBgcHJpbWFyeVN0cmF0ZWd5YFxuICAgKiAtIGFycmF5IG9mIGN1c3RvbSB1c2VyIGRlZmluZWQgc3RyYXRlZ2llcyAtIGBjdXN0b21TdHJhdGVnaWVzYFxuICAgKiAtIHNldHRpbmcgdGhhdCBpcyByZXNwb25zaWJsZSBmb3IgcnVubmluZyBpbiBvdXIgb3V0c2lkZSBvZiB0aGUgem9uZS5qcyAtIGBwYXRjaFpvbmVgXG4gICAqL1xuICBnZXQgY29uZmlnKCk6IFJlcXVpcmVkPFJ4UmVuZGVyU3RyYXRlZ2llc0NvbmZpZzxUPj4ge1xuICAgIHJldHVybiB0aGlzLl9jZmc7XG4gIH1cblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFJldHVybnMgb2JqZWN0IHRoYXQgY29udGFpbnMga2V5LXZhbHVlIHBhaXJzIG9mIHN0cmF0ZWd5IG5hbWVzIGFuZCB0aGVpciBjcmVkZW50aWFscyAoc2V0dGluZ3MpIHRoYXQgYXJlIGF2YWlsYWJsZSBpbiB0aGUgc2VydmljZS5cbiAgICovXG4gIGdldCBzdHJhdGVnaWVzKCk6IFJ4U3RyYXRlZ2llczxUPiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0cmF0ZWdpZXMkLmdldFZhbHVlKCk7XG4gIH1cblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFJldHVybnMgYW4gYXJyYXkgb2Ygc3RyYXRlZ3kgbmFtZXMgYXZhaWxhYmxlIGluIHRoZSBzZXJ2aWNlLlxuICAgKi9cbiAgZ2V0IHN0cmF0ZWd5TmFtZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMuc3RyYXRlZ2llcykubWFwKChzKSA9PiBzLm5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBSZXR1cm5zIGN1cnJlbnQgc3RyYXRlZ3kgb2YgdGhlIHNlcnZpY2UuXG4gICAqL1xuICBnZXQgcHJpbWFyeVN0cmF0ZWd5KCk6IFJ4U3RyYXRlZ3lOYW1lczxUPiB7XG4gICAgcmV0dXJuIHRoaXMuX3ByaW1hcnlTdHJhdGVneSQuZ2V0VmFsdWUoKS5uYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBTZXQncyB0aGUgc3RyYXRlZ3kgdGhhdCB3aWxsIGJlIHVzZWQgYnkgdGhlIHNlcnZpY2UuXG4gICAqL1xuICBzZXQgcHJpbWFyeVN0cmF0ZWd5KHN0cmF0ZWd5TmFtZTogUnhTdHJhdGVneU5hbWVzPFQ+KSB7XG4gICAgdGhpcy5fcHJpbWFyeVN0cmF0ZWd5JC5uZXh0KFxuICAgICAgPFJ4U3RyYXRlZ3lDcmVkZW50aWFsczxSeFN0cmF0ZWd5TmFtZXM8VD4+PnRoaXMuc3RyYXRlZ2llc1tzdHJhdGVneU5hbWVdXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQ3VycmVudCBzdHJhdGVneSBvZiB0aGUgc2VydmljZSBhcyBhbiBvYnNlcnZhYmxlLlxuICAgKi9cbiAgcmVhZG9ubHkgcHJpbWFyeVN0cmF0ZWd5JDogT2JzZXJ2YWJsZTxSeFN0cmF0ZWd5Q3JlZGVudGlhbHM+ID1cbiAgICB0aGlzLl9wcmltYXJ5U3RyYXRlZ3kkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUmV0dXJucyBvYnNlcnZhYmxlIG9mIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIGtleS12YWx1ZSBwYWlycyBvZiBzdHJhdGVneSBuYW1lcyBhbmQgdGhlaXIgY3JlZGVudGlhbHMgKHNldHRpbmdzKSB0aGF0IGFyZSBhdmFpbGFibGUgaW4gdGhlIHNlcnZpY2UuXG4gICAqL1xuICByZWFkb25seSBzdHJhdGVnaWVzJCA9IHRoaXMuX3N0cmF0ZWdpZXMkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogUmV0dXJucyBhbiBvYnNlcnZhYmxlIG9mIGFuIGFycmF5IG9mIHN0cmF0ZWd5IG5hbWVzIGF2YWlsYWJsZSBpbiB0aGUgc2VydmljZS5cbiAgICovXG4gIHJlYWRvbmx5IHN0cmF0ZWd5TmFtZXMkID0gdGhpcy5zdHJhdGVnaWVzJC5waXBlKFxuICAgIG1hcCgoc3RyYXRlZ2llcykgPT4gT2JqZWN0LnZhbHVlcyhzdHJhdGVnaWVzKS5tYXAoKHMpID0+IHMubmFtZSkpLFxuICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSlcbiAgKTtcblxuICAvKipcbiAgICogQGludGVybmFsXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoUlhfUkVOREVSX1NUUkFURUdJRVNfQ09ORklHKVxuICAgIGNmZzogUnhSZW5kZXJTdHJhdGVnaWVzQ29uZmlnPFQ+XG4gICkge1xuICAgIHRoaXMuX2NmZyA9IG1lcmdlRGVmYXVsdENvbmZpZyhjZmcpO1xuICAgIHRoaXMuX3N0cmF0ZWdpZXMkLm5leHQodGhpcy5fY2ZnLmN1c3RvbVN0cmF0ZWdpZXMgYXMgYW55KTtcbiAgICB0aGlzLnByaW1hcnlTdHJhdGVneSA9IHRoaXMuY29uZmlnLnByaW1hcnlTdHJhdGVneTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogQWxsb3dzIHRvIHNjaGVkdWxlIGEgd29yayBpbnNpZGUgcnhqcyBgcGlwZWAuIEFjY2VwdHMgdGhlIHdvcmsgYW5kIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBvYmplY3QuXG4gICAqIC0gd29yayBpcyBhbnkgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWRcbiAgICogLSAob3B0aW9uYWwpIG9wdGlvbnMgaW5jbHVkZXMgc3RyYXRlZ3ksIHBhdGNoWm9uZSBhbmQgc2NvcGVcbiAgICpcbiAgICogU2NvcGUgaXMgYnkgZGVmYXVsdCBhIHN1YnNjcmlwdGlvbiBidXQgeW91IGNhbiBhbHNvIHBhc3MgYHRoaXNgIGFuZCB0aGVuIHRoZSBzY29wZSB3aWxsIGJlIGN1cnJlbnQgY29tcG9uZW50LlxuICAgKiBTY29wZSBzZXR1cCBpcyB1c2VmdWwgaWYgeW91ciB3b3JrIGlzIHNvbWUgb2YgdGhlIG1ldGhvZHMgb2YgYENoYW5nZURldGVjdG9yUmVmYC4gT25seSBvbmUgY2hhbmdlIGRldGVjdGlvbiB3aWxsIGJlIHRyaWdnZXJlZCBpZiB5b3UgaGF2ZSBtdWx0aXBsZSBzY2hlZHVsZXMgb2YgY2hhbmdlIGRldGVjdGlvbiBtZXRob2RzIGFuZCBzY29wZSBpcyBzZXQgdG8gYHRoaXNgLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBteU9ic2VydmFibGUkLnBpcGUoXG4gICAqICAgIHRoaXMuc3RyYXRlZ3lQcm92aWRlci5zY2hlZHVsZVdpdGgoKCkgPT4gbXlXb3JrKCksIHtzdHJhdGVneTogJ2lkbGUnLCBwYXRjaFpvbmU6IGZhbHNlfSlcbiAgICogKS5zdWJzY3JpYmUoKTtcbiAgICpcbiAgICogQHJldHVybiBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb248Uj5cbiAgICovXG4gIHNjaGVkdWxlV2l0aDxSPihcbiAgICB3b3JrOiAodj86IFIpID0+IHZvaWQsXG4gICAgb3B0aW9ucz86IFNjaGVkdWxlT25TdHJhdGVneU9wdGlvbnNcbiAgKTogTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uPFI+IHtcbiAgICBjb25zdCBzdHJhdGVneSA9IHRoaXMuc3RyYXRlZ2llc1tvcHRpb25zPy5zdHJhdGVneSB8fCB0aGlzLnByaW1hcnlTdHJhdGVneV07XG4gICAgY29uc3Qgc2NvcGUgPSBvcHRpb25zPy5zY29wZSB8fCB7fTtcbiAgICBjb25zdCBfd29yayA9IGdldFdvcmsod29yaywgb3B0aW9ucz8ucGF0Y2hab25lKTtcbiAgICBjb25zdCBuZ1pvbmUgPSBvcHRpb25zPy5wYXRjaFpvbmUgfHwgdW5kZWZpbmVkO1xuICAgIHJldHVybiAobyQpID0+XG4gICAgICBvJC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKHYpID0+XG4gICAgICAgICAgb25TdHJhdGVneShcbiAgICAgICAgICAgIHYsXG4gICAgICAgICAgICBzdHJhdGVneSxcbiAgICAgICAgICAgIChfdikgPT4ge1xuICAgICAgICAgICAgICBfd29yayhfdik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgeyBzY29wZSwgbmdab25lIH1cbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEFsbG93cyB0byBzY2hlZHVsZSBhIHdvcmsgYXMgYW4gb2JzZXJ2YWJsZS4gQWNjZXB0cyB0aGUgd29yayBhbmQgY29uZmlndXJhdGlvbiBvcHRpb25zIG9iamVjdC5cbiAgICogLSB3b3JrIGlzIGFueSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBleGVjdXRlZFxuICAgKiAtIChvcHRpb25hbCkgb3B0aW9ucyBpbmNsdWRlcyBzdHJhdGVneSwgcGF0Y2hab25lIGFuZCBzY29wZVxuICAgKlxuICAgKiBTY29wZSBpcyBieSBkZWZhdWx0IGEgc3Vic2NyaXB0aW9uIGJ1dCB5b3UgY2FuIGFsc28gcGFzcyBgdGhpc2AgYW5kIHRoZW4gdGhlIHNjb3BlIHdpbGwgYmUgY3VycmVudCBjb21wb25lbnQuXG4gICAqIFNjb3BlIHNldHVwIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGlmIHlvdSBwcm92aWRlIHdvcmsgdGhhdCB3aWxsIHRyaWdnZXIgYSBjaGFuZ2UgZGV0ZWN0aW9uLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0cmF0ZWd5UHJvdmlkZXIuc2NoZWR1bGUoKCkgPT4gbXlXb3JrKCksIHtzdHJhdGVneTogJ2lkbGUnLCBwYXRjaFpvbmU6IGZhbHNlfSkuc3Vic2NyaWJlKCk7XG4gICAqXG4gICAqIEByZXR1cm4gT2JzZXJ2YWJsZTxSPlxuICAgKi9cbiAgc2NoZWR1bGU8Uj4oXG4gICAgd29yazogKCkgPT4gUixcbiAgICBvcHRpb25zPzogU2NoZWR1bGVPblN0cmF0ZWd5T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPFI+IHtcbiAgICBjb25zdCBzdHJhdGVneSA9IHRoaXMuc3RyYXRlZ2llc1tvcHRpb25zPy5zdHJhdGVneSB8fCB0aGlzLnByaW1hcnlTdHJhdGVneV07XG4gICAgY29uc3Qgc2NvcGUgPSBvcHRpb25zPy5zY29wZSB8fCB7fTtcbiAgICBjb25zdCBfd29yayA9IGdldFdvcmsod29yaywgb3B0aW9ucz8ucGF0Y2hab25lKTtcbiAgICBjb25zdCBuZ1pvbmUgPSBvcHRpb25zPy5wYXRjaFpvbmUgfHwgdW5kZWZpbmVkO1xuICAgIGxldCByZXR1cm5WYWw6IFI7XG4gICAgcmV0dXJuIG9uU3RyYXRlZ3koXG4gICAgICBudWxsLFxuICAgICAgc3RyYXRlZ3ksXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVyblZhbCA9IF93b3JrKCk7XG4gICAgICB9LFxuICAgICAgeyBzY29wZSwgbmdab25lIH1cbiAgICApLnBpcGUobWFwKCgpID0+IHJldHVyblZhbCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBBbGxvd3MgdG8gc2NoZWR1bGUgYSBjaGFuZ2UgZGV0ZWN0aW9uIGN5Y2xlLiBBY2NlcHRzIHRoZSBDaGFuZ2VEZXRlY3RvclJlZiBhbmQgY29uZmlndXJhdGlvbiBvcHRpb25zIG9iamVjdC5cbiAgICogT3B0aW9ucyBpbmNsdWRlOlxuICAgKiAtIGFmdGVyQ0Qgd2hpY2ggaXMgdGhlIHdvcmsgdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWQgYWZ0ZXIgY2hhbmdlIGRldGVjdGlvbiBjeWNsZS5cbiAgICogLSBhYm9ydEN0cmwgaXMgYW4gQWJvcnRDb250cm9sbGVyIHRoYXQgeW91IGNhbiB1c2UgdG8gY2FuY2VsIHRoZSBzY2hlZHVsZWQgY3ljbGUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RyYXRlZ3lQcm92aWRlci5zY2hlZHVsZUNkKHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYsIHthZnRlckNEOiBteVdvcmsoKX0pO1xuICAgKlxuICAgKiBAcmV0dXJuIEFib3J0Q29udHJvbGxlclxuICAgKi9cbiAgc2NoZWR1bGVDRChcbiAgICBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgb3B0aW9ucz86IFNjaGVkdWxlT25TdHJhdGVneU9wdGlvbnMgJiB7XG4gICAgICBhZnRlckNEPzogKCkgPT4gdm9pZDtcbiAgICAgIGFib3J0Q3RybD86IEFib3J0Q29udHJvbGxlcjtcbiAgICB9XG4gICk6IEFib3J0Q29udHJvbGxlciB7XG4gICAgY29uc3Qgc3RyYXRlZ3kgPSB0aGlzLnN0cmF0ZWdpZXNbb3B0aW9ucz8uc3RyYXRlZ3kgfHwgdGhpcy5wcmltYXJ5U3RyYXRlZ3ldO1xuICAgIGNvbnN0IHNjb3BlID0gb3B0aW9ucz8uc2NvcGUgfHwgY2RSZWY7XG4gICAgY29uc3QgYWJDID0gb3B0aW9ucz8uYWJvcnRDdHJsIHx8IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICBjb25zdCBuZ1pvbmUgPSBvcHRpb25zPy5wYXRjaFpvbmUgfHwgdW5kZWZpbmVkO1xuICAgIGNvbnN0IHdvcmsgPSBnZXRXb3JrKCgpID0+IHtcbiAgICAgIHN0cmF0ZWd5LndvcmsoY2RSZWYsIHNjb3BlKTtcbiAgICAgIGlmIChvcHRpb25zPy5hZnRlckNEKSB7XG4gICAgICAgIG9wdGlvbnMuYWZ0ZXJDRCgpO1xuICAgICAgfVxuICAgIH0sIG9wdGlvbnMucGF0Y2hab25lKTtcbiAgICBvblN0cmF0ZWd5KFxuICAgICAgbnVsbCxcbiAgICAgIHN0cmF0ZWd5LFxuICAgICAgKCkgPT4ge1xuICAgICAgICB3b3JrKCk7XG4gICAgICB9LFxuICAgICAgeyBzY29wZSwgbmdab25lIH1cbiAgICApXG4gICAgICAucGlwZSh0YWtlVW50aWwoZnJvbUV2ZW50KGFiQy5zaWduYWwsICdhYm9ydCcpKSlcbiAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gYWJDO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFdvcms8VD4oXG4gIHdvcms6IChhcmdzPzogYW55KSA9PiBULFxuICBwYXRjaFpvbmU/OiBmYWxzZSB8IE5nWm9uZVxuKTogKGFyZ3M/OiBhbnkpID0+IFQge1xuICBsZXQgX3dvcmsgPSB3b3JrO1xuICBpZiAocGF0Y2hab25lKSB7XG4gICAgX3dvcmsgPSAoYXJncz86IGFueSkgPT4gcGF0Y2hab25lLnJ1bigoKSA9PiB3b3JrKGFyZ3MpKTtcbiAgfVxuICByZXR1cm4gX3dvcms7XG59XG4iXX0=